<div class="bg-[color:var(--app-card)] border border-[color:var(--app-border)] rounded-lg p-4 mb-4">
    <div class="flex items-start gap-3 mb-3">
        <img src="{{ comment.author.profile.google_avatar_url if comment.author.profile and comment.author.profile.google_avatar_url else url_for('static', filename='images/default-avatar.svg') }}" 
             alt="{{ comment.author.username }}" 
             class="w-10 h-10 rounded-full flex-shrink-0">
        <div class="flex-1">
            <div class="flex items-center gap-2 mb-1">
                <span class="font-semibold text-[color:var(--app-text)]">{{ comment.author.display_name or comment.author.username }}</span>
                <span class="text-sm text-[color:var(--app-muted)]">{{ comment.created_at.strftime('%b %d, %Y at %I:%M %p') }}</span>
                {% if comment.author_id == current_user.id or (current_user.is_authenticated and (current_user.is_admin or current_user.role == 'admin')) %}
                <form method="POST" action="{{ url_for('forum.delete_comment_route', comment_id=comment.id) }}" class="inline ml-auto" onsubmit="return confirm('Are you sure you want to delete this comment?');">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="text-red-500 hover:text-red-600 text-sm">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </form>
                {% endif %}
            </div>
            <p class="text-[color:var(--app-text)] whitespace-pre-wrap">{{ comment.body }}</p>
            
            {% if comment.file_url %}
            <div class="mt-3">
                {% if comment.filename and comment.filename.split('.')[-1].lower() in ['jpg', 'jpeg', 'png', 'gif', 'webp'] %}
                    <img src="{{ comment.file_url }}" alt="{{ comment.filename }}" 
                         class="max-w-md rounded-lg border border-[color:var(--app-border)] cursor-pointer hover:opacity-80 transition-opacity"
                         onclick="window.open('{{ comment.file_url }}', '_blank')">
                {% else %}
                    <a href="{{ comment.file_url }}" target="_blank" rel="noopener" 
                       class="inline-flex items-center gap-2 px-3 py-2 bg-gray-100 dark:bg-gray-800 text-[color:var(--app-text)] rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                        <i data-lucide="file" class="w-4 h-4"></i>
                        <span>{{ comment.filename or 'Download File' }}</span>
                    </a>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Comment Reactions -->
    <div class="flex items-center gap-4 pt-3 border-t border-[color:var(--app-border)]">
        {% if current_user.is_authenticated %}
        <button onclick="reactToComment({{ comment.id }}, 'like')" 
                class="flex items-center gap-2 px-3 py-1 rounded-lg hover:bg-[color:var(--app-surface-hover)] transition-colors {% if comment_reactions.get(comment.id) == 'like' %}text-green-500{% else %}text-[color:var(--app-muted)]{% endif %}">
            <i data-lucide="thumbs-up" class="w-4 h-4"></i>
            <span class="comment-like-count-{{ comment.id }}">{{ comment.like_count }}</span>
        </button>
        <button onclick="reactToComment({{ comment.id }}, 'dislike')" 
                class="flex items-center gap-2 px-3 py-1 rounded-lg hover:bg-[color:var(--app-surface-hover)] transition-colors {% if comment_reactions.get(comment.id) == 'dislike' %}text-red-500{% else %}text-[color:var(--app-muted)]{% endif %}">
            <i data-lucide="thumbs-down" class="w-4 h-4"></i>
            <span class="comment-dislike-count-{{ comment.id }}">{{ comment.dislike_count }}</span>
        </button>
        {% else %}
        <div class="flex items-center gap-2 text-[color:var(--app-muted)]">
            <i data-lucide="thumbs-up" class="w-4 h-4"></i>
            <span>{{ comment.like_count }}</span>
        </div>
        <div class="flex items-center gap-2 text-[color:var(--app-muted)]">
            <i data-lucide="thumbs-down" class="w-4 h-4"></i>
            <span>{{ comment.dislike_count }}</span>
        </div>
        {% endif %}
    </div>
</div>

<script>
    function reactToComment(commentId, reactionType) {
        fetch(`{{ url_for('forum.react_comment', comment_id=0) }}`.replace('0', commentId), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
            },
            body: JSON.stringify({ reaction_type: reactionType })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.querySelector(`.comment-like-count-${commentId}`).textContent = data.like_count;
                document.querySelector(`.comment-dislike-count-${commentId}`).textContent = data.dislike_count;
                // Reload page to update button states
                window.location.reload();
            }
        })
        .catch(error => console.error('Error:', error));
    }
</script>

