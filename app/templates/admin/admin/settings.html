{% extends 'admin/admin/base.html' %}

{% block title %}App Settings{% endblock %}

{% block header %}⚙️ App Settings{% endblock %}

{% block content %}
<div class="space-y-6">
  <!-- Toast notification container -->
  <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

  <!-- Introduction -->
  <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
    <p class="text-sm text-blue-800 dark:text-blue-200">
      <i class="fas fa-info-circle mr-2"></i>
      This is your main control center. Manage all app configurations, test integrations, and monitor your system from one place.
    </p>
  </div>

  <!-- 1. General Settings -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
    <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
      <i class="fas fa-building mr-2 text-blue-500"></i>
      General Settings
    </h2>
    <form method="POST" enctype="multipart/form-data" id="general-form">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <input type="hidden" name="section" value="general">
      
      <div class="grid md:grid-cols-2 gap-6">
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Business Name</label>
          <input type="text" name="business_name" value="{{ settings.business_name or '' }}" 
                 class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500">
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Website URL</label>
          <input type="url" name="website_url" value="{{ settings.website_url or '' }}" 
                 class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500">
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Support Email</label>
          <input type="email" name="support_email" value="{{ settings.support_email or '' }}" 
                 class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500">
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Contact WhatsApp Number</label>
          <input type="text" name="contact_whatsapp" value="{{ settings.contact_whatsapp or '' }}" 
                 placeholder="+2200000000"
                 class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500">
        </div>
        
        <div class="md:col-span-2">
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Company Logo</label>
          <div class="flex items-center gap-4">
            {% if settings.company_logo_url %}
            <div class="w-24 h-24 border border-gray-300 dark:border-gray-600 rounded-lg overflow-hidden bg-white dark:bg-gray-700">
              <img src="{{ settings.company_logo_url }}" alt="Company Logo" class="w-full h-full object-contain">
            </div>
            {% endif %}
            <label class="cursor-pointer inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">
              <i class="fas fa-upload mr-2"></i>
              Upload Logo
              <input type="file" name="company_logo" accept="image/*" class="hidden">
            </label>
          </div>
          <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">Upload to Cloudinary. PNG, JPG, or SVG recommended.</p>
        </div>
      </div>
      
      <div class="mt-6">
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-500">
          <i class="fas fa-save mr-2"></i>Save General Settings
        </button>
      </div>
    </form>
  </div>

  <!-- 2. Payment Settings -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
    <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
      <i class="fas fa-credit-card mr-2 text-green-500"></i>
      Payment Settings
    </h2>
    <form method="POST" id="payment-form">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <input type="hidden" name="section" value="payment">
      
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ModemPay API Key (Secret Key)</label>
          <input type="password" name="modempay_api_key" value="{{ settings.modempay_api_key or '' }}" 
                 class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500"
                 placeholder="sk_live_...">
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ModemPay Public Key</label>
          <input type="text" name="modempay_public_key" value="{{ settings.modempay_public_key or '' }}" 
                 class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500"
                 placeholder="pk_live_...">
        </div>
        
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Return URL</label>
            <input type="url" name="payment_return_url" value="{{ settings.payment_return_url or '' }}" 
                   class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Cancel URL</label>
            <input type="url" name="payment_cancel_url" value="{{ settings.payment_cancel_url or '' }}" 
                   class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500">
          </div>
        </div>
        
        <div class="flex items-center">
          <input type="checkbox" name="payments_enabled" id="payments_enabled" 
                 {% if settings.payments_enabled %}checked{% endif %}
                 class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
          <label for="payments_enabled" class="ml-2 block text-sm text-gray-700 dark:text-gray-300">
            Enable Payments
          </label>
        </div>
      </div>
      
      <div class="mt-6 flex gap-3">
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-500">
          <i class="fas fa-save mr-2"></i>Save Payment Settings
        </button>
        <button type="button" onclick="testPayment()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 focus:ring-2 focus:ring-green-500">
          <i class="fas fa-vial mr-2"></i>Test Payment
        </button>
      </div>
    </form>
  </div>

  <!-- 3. Cloudinary Settings -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
    <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
      <i class="fas fa-cloud mr-2 text-purple-500"></i>
      Cloudinary Settings
    </h2>
    <form method="POST" id="cloudinary-form">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <input type="hidden" name="section" value="cloudinary">
      
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Cloud Name</label>
          <input type="text" name="cloudinary_cloud_name" value="{{ settings.cloudinary_cloud_name or '' }}" 
                 class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500">
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">API Key</label>
          <input type="text" name="cloudinary_api_key" value="{{ settings.cloudinary_api_key or '' }}" 
                 class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500">
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">API Secret</label>
          <input type="password" name="cloudinary_api_secret" value="" 
                 placeholder="Leave blank to keep current"
                 class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500">
          <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Leave blank to keep current secret</p>
        </div>
      </div>
      
      <div class="mt-6 flex gap-3">
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-500">
          <i class="fas fa-save mr-2"></i>Save Cloudinary Settings
        </button>
        <button type="button" onclick="testCloudinary()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 focus:ring-2 focus:ring-purple-500">
          <i class="fas fa-vial mr-2"></i>Test Upload
        </button>
      </div>
    </form>
  </div>

  <!-- 4. WhatsApp Settings -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
    <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
      <i class="fab fa-whatsapp mr-2 text-green-500"></i>
      WhatsApp Settings
    </h2>
    <form method="POST" id="whatsapp-form">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <input type="hidden" name="section" value="whatsapp">
      
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">WhatsApp Access Token</label>
          <input type="password" name="whatsapp_access_token" value="{{ settings.whatsapp_access_token or '' }}" 
                 class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500">
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Phone Number ID</label>
          <input type="text" name="whatsapp_phone_number_id" value="{{ settings.whatsapp_phone_number_id or '' }}" 
                 class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500">
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Business Name</label>
          <input type="text" name="whatsapp_business_name" value="{{ settings.whatsapp_business_name or '' }}" 
                 class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500">
        </div>
        
        <div class="flex items-center">
          <input type="checkbox" name="whatsapp_bulk_messaging_enabled" id="whatsapp_bulk_messaging_enabled" 
                 {% if settings.whatsapp_bulk_messaging_enabled %}checked{% endif %}
                 class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
          <label for="whatsapp_bulk_messaging_enabled" class="ml-2 block text-sm text-gray-700 dark:text-gray-300">
            Enable Bulk Messaging
          </label>
        </div>
      </div>
      
      <div class="mt-6 flex gap-3">
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-500">
          <i class="fas fa-save mr-2"></i>Save WhatsApp Settings
        </button>
        <button type="button" onclick="testWhatsApp()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 focus:ring-2 focus:ring-green-500">
          <i class="fas fa-vial mr-2"></i>Test Message
        </button>
      </div>
    </form>
  </div>

  <!-- 5. Email Settings -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
    <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
      <i class="fas fa-envelope mr-2 text-red-500"></i>
      Email Settings
    </h2>
    <form method="POST" id="email-form">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <input type="hidden" name="section" value="email">
      
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">SMTP Server</label>
          <input type="text" name="smtp_server" value="{{ settings.smtp_server or 'smtp.gmail.com' }}" 
                 class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500">
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Port</label>
          <input type="number" name="smtp_port" value="{{ settings.smtp_port or 587 }}" 
                 class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500">
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Sender Email</label>
          <input type="email" name="smtp_username" value="{{ settings.smtp_username or '' }}" 
                 class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500">
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">App Password</label>
          <input type="password" name="smtp_password" value="" 
                 placeholder="Leave blank to keep current"
                 class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500">
          <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Leave blank to keep current password</p>
        </div>
        
        <div class="flex items-center">
          <input type="checkbox" name="smtp_use_tls" id="smtp_use_tls" 
                 {% if settings.smtp_use_tls %}checked{% endif %}
                 class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
          <label for="smtp_use_tls" class="ml-2 block text-sm text-gray-700 dark:text-gray-300">
            Use TLS/SSL
          </label>
        </div>
      </div>
      
      <div class="mt-6 flex gap-3">
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-500">
          <i class="fas fa-save mr-2"></i>Save Email Settings
        </button>
        <button type="button" onclick="testEmail()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 focus:ring-2 focus:ring-red-500">
          <i class="fas fa-vial mr-2"></i>Test Email
        </button>
      </div>
    </form>
  </div>

  <!-- 6. Data & Security -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
    <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
      <i class="fas fa-database mr-2 text-yellow-500"></i>
      Data & Security
    </h2>
    
    <div class="grid md:grid-cols-3 gap-4 mb-6">
      <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
        <div class="text-2xl font-bold text-gray-900 dark:text-white">{{ total_customers }}</div>
        <div class="text-sm text-gray-600 dark:text-gray-400">Total Customers</div>
      </div>
      <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
        <div class="text-2xl font-bold text-gray-900 dark:text-white">{{ total_products }}</div>
        <div class="text-sm text-gray-600 dark:text-gray-400">Total Products</div>
      </div>
      <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
        <div class="text-2xl font-bold text-gray-900 dark:text-white">{{ total_orders }}</div>
        <div class="text-sm text-gray-600 dark:text-gray-400">Total Orders</div>
      </div>
    </div>
    
    <div class="flex flex-wrap gap-3">
      <button onclick="backupDatabase()" class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 focus:ring-2 focus:ring-yellow-500">
        <i class="fas fa-download mr-2"></i>Backup Database
      </button>
      <button onclick="clearCache()" class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 focus:ring-2 focus:ring-orange-500">
        <i class="fas fa-broom mr-2"></i>Clear Cache
      </button>
      <a href="/admin/reports" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 focus:ring-2 focus:ring-gray-500 inline-flex items-center">
        <i class="fas fa-chart-bar mr-2"></i>View Reports
      </a>
    </div>
  </div>

  <!-- 7. AI Control (Optional) -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
    <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
      <i class="fas fa-robot mr-2 text-indigo-500"></i>
      AI Control (Optional)
    </h2>
    <form method="POST" id="ai-form">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <input type="hidden" name="section" value="ai">
      
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">AI API Key</label>
          <input type="password" name="ai_api_key" value="{{ settings.ai_api_key or '' }}" 
                 class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500"
                 placeholder="sk-...">
        </div>
        
        <div class="flex items-center">
          <input type="checkbox" name="ai_auto_prompt_improvements" id="ai_auto_prompt_improvements" 
                 {% if settings.ai_auto_prompt_improvements %}checked{% endif %}
                 class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
          <label for="ai_auto_prompt_improvements" class="ml-2 block text-sm text-gray-700 dark:text-gray-300">
            Enable Auto-Prompt Improvements
          </label>
        </div>
      </div>
      
      <div class="mt-6">
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-500">
          <i class="fas fa-save mr-2"></i>Save AI Settings
        </button>
      </div>
    </form>
  </div>
</div>

<script>
function getCSRFToken() {
  // Try to get from meta tag first, then from form field
  const metaToken = document.querySelector('meta[name="csrf-token"]');
  if (metaToken) {
    return metaToken.getAttribute('content');
  }
  const formToken = document.querySelector('[name="csrf_token"]');
  if (formToken) {
    return formToken.value;
  }
  return '';
}

function showToast(message, type = 'success') {
  const container = document.getElementById('toast-container');
  const toast = document.createElement('div');
  toast.className = `px-4 py-3 rounded-lg shadow-lg ${type === 'success' ? 'bg-green-500' : 'bg-red-500'} text-white flex items-center justify-between min-w-[300px]`;
  toast.innerHTML = `
    <span>${message}</span>
    <button onclick="this.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
      <i class="fas fa-times"></i>
    </button>
  `;
  container.appendChild(toast);
  setTimeout(() => toast.remove(), 5000);
}

async function testPayment() {
  const btn = event.target.closest('button');
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Testing...';
  
  try {
    const response = await fetch('/admin/settings/test-payment', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken()
      }
    });
    const data = await response.json();
    showToast(data.message, data.success ? 'success' : 'error');
  } catch (error) {
    showToast('Error testing payment: ' + error.message, 'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
}

async function testCloudinary() {
  const btn = event.target.closest('button');
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Testing...';
  
  try {
    const response = await fetch('/admin/settings/test-cloudinary', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken()
      }
    });
    const data = await response.json();
    showToast(data.message, data.success ? 'success' : 'error');
  } catch (error) {
    showToast('Error testing Cloudinary: ' + error.message, 'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
}

async function testWhatsApp() {
  const testNumber = prompt('Enter WhatsApp number to test (e.g., +2200000000):', '+2200000000');
  if (!testNumber) return;
  
  const btn = event.target.closest('button');
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Sending...';
  
  try {
    const response = await fetch('/admin/settings/test-whatsapp', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken()
      },
      body: JSON.stringify({ test_number: testNumber })
    });
    const data = await response.json();
    showToast(data.message, data.success ? 'success' : 'error');
  } catch (error) {
    showToast('Error testing WhatsApp: ' + error.message, 'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
}

async function testEmail() {
  const testEmail = prompt('Enter email address to test:', '{{ current_user.email }}');
  if (!testEmail) return;
  
  const btn = event.target.closest('button');
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Sending...';
  
  try {
    const response = await fetch('/admin/settings/test-email', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken()
      },
      body: JSON.stringify({ test_email: testEmail })
    });
    const data = await response.json();
    showToast(data.message, data.success ? 'success' : 'error');
  } catch (error) {
    showToast('Error testing email: ' + error.message, 'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
}

async function backupDatabase() {
  const btn = event.target;
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Backing up...';
  
  try {
    const response = await fetch('/admin/settings/backup-database', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken()
      }
    });
    
    // Check if response is JSON
    const contentType = response.headers.get('content-type');
    if (contentType && contentType.includes('application/json')) {
      const data = await response.json();
      showToast(data.message, data.success ? 'success' : 'error');
    } else {
      // Response is not JSON (likely HTML error page)
      const text = await response.text();
      showToast('Error backing up database: Server returned an error. Please check the console.', 'error');
      console.error('Non-JSON response:', text.substring(0, 200));
    }
  } catch (error) {
    showToast('Error backing up database: ' + error.message, 'error');
    console.error('Backup error:', error);
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
}

async function clearCache() {
  const btn = event.target;
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Clearing...';
  
  try {
    const response = await fetch('/admin/settings/clear-cache', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken()
      }
    });
    const data = await response.json();
    showToast(data.message, data.success ? 'success' : 'error');
  } catch (error) {
    showToast('Error clearing cache: ' + error.message, 'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
}
</script>
{% endblock %}

