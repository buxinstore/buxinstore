{% extends 'admin/admin/base.html' %}

{% block title %}App Settings{% endblock %}

{% block header %}⚙️ App Settings{% endblock %}

{% block content %}
<div class="space-y-6">
  <!-- Toast notification container -->
  <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

  <!-- Introduction -->
  <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
    <p class="text-sm text-blue-800 dark:text-blue-200">
      <i class="fas fa-info-circle mr-2"></i>
      This is your main control center. Manage all app configurations, test integrations, and monitor your system from one place.
    </p>
  </div>

  <!-- 1. General Settings -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
    <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
      <i class="fas fa-building mr-2 text-blue-500"></i>
      General Settings
    </h2>
    <form method="POST" enctype="multipart/form-data" id="general-form">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <input type="hidden" name="section" value="general">
      
      <div class="grid md:grid-cols-2 gap-6">
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Business Name</label>
          <input type="text" name="business_name" value="{{ settings.business_name or '' }}" 
                 class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500">
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Website URL</label>
          <input type="url" name="website_url" value="{{ settings.website_url or '' }}" 
                 class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500">
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Support Email</label>
          <input type="email" name="support_email" value="{{ settings.support_email or '' }}" 
                 class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500">
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Contact WhatsApp Number</label>
          <input type="text" name="contact_whatsapp" value="{{ settings.contact_whatsapp or '' }}" 
                 placeholder="+2200000000"
                 class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500">
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">WhatsApp Receiver (for form submissions)</label>
          <input type="text" name="contact_whatsapp_receiver" value="{{ settings.contact_whatsapp_receiver or '' }}" 
                 placeholder="+2200000000"
                 class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500">
          <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">WhatsApp number that receives form submissions</p>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Email Receiver (for form submissions)</label>
          <input type="email" name="contact_email_receiver" value="{{ settings.contact_email_receiver or '' }}" 
                 placeholder="admin@example.com"
                 class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500">
          <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Email address that receives form submissions</p>
        </div>
      </div>
      
      <div class="mt-6 border-t border-gray-200 dark:border-gray-700 pt-6">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Communication Settings</h3>
        <div class="grid md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              Default WhatsApp Receiver <span class="text-red-500">*</span>
            </label>
            <input type="text" name="whatsapp_receiver" value="{{ settings.whatsapp_receiver or '+2200000000' }}" 
                   placeholder="+2200000000"
                   class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500"
                   required>
            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Default WhatsApp number for all communications (bulk messaging, test messages, form submissions)</p>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              Default Email Receiver <span class="text-red-500">*</span>
            </label>
            <input type="email" name="email_receiver" value="{{ settings.email_receiver or 'buxinstore9@gmail.com' }}" 
                   placeholder="buxinstore9@gmail.com"
                   class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500"
                   required>
            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Default email address for all communications (customer emails, form submissions, notifications)</p>
          </div>
        </div>
      </div>
        
      <div class="mt-6 border-t border-gray-200 dark:border-gray-700 pt-6">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
          <i class="fas fa-comments mr-2 text-cyan-500"></i>
          Floating Contact Widget Settings
        </h3>
        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
          Configure the floating contact buttons displayed on your website. If a field is empty, that button will not be shown.
        </p>
        <div class="grid md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              WhatsApp Phone Number
            </label>
            <input type="text" name="floating_whatsapp_number" 
                   value="{{ settings.floating_whatsapp_number or '' }}" 
                   placeholder="2207741187 or +2207741187"
                   class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500">
            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Phone number for WhatsApp contact button (without country code prefix is OK, e.g., 2207741187)</p>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              Support Email
            </label>
            <input type="email" name="floating_support_email" 
                   value="{{ settings.floating_support_email or '' }}" 
                   placeholder="buxinstore9@gmail.com"
                   class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500">
            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Email address for support contact button</p>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              Default Email Subject
            </label>
            <input type="text" name="floating_email_subject" 
                   value="{{ settings.floating_email_subject or 'Support Request' }}" 
                   placeholder="Support Request"
                   class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500">
            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Default subject line for email contact button</p>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              Default Email Message
            </label>
            <textarea name="floating_email_body" rows="3"
                      placeholder="Hello, I need help with ..."
                      class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500">{{ settings.floating_email_body or 'Hello, I need help with ...' }}</textarea>
            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Default message body for email contact button</p>
          </div>
        </div>
      </div>
        
        <div class="md:col-span-2 mt-6">
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Company Logo</label>
          <div class="flex items-center gap-4">
            {% if settings.company_logo_url %}
            <div class="w-24 h-24 border border-gray-300 dark:border-gray-600 rounded-lg overflow-hidden bg-white dark:bg-gray-700">
              <img src="{{ settings.company_logo_url }}" alt="Company Logo" class="w-full h-full object-contain">
            </div>
            {% endif %}
            <label class="cursor-pointer inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">
              <i class="fas fa-upload mr-2"></i>
              Upload Logo
              <input type="file" name="company_logo" accept="image/*" class="hidden">
            </label>
          </div>
          <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">Upload to Cloudinary. PNG, JPG, or SVG recommended.</p>
        </div>
      </div>
      
      <div class="mt-6">
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-500">
          <i class="fas fa-save mr-2"></i>Save General Settings
        </button>
      </div>
    </form>
  </div>

  <!-- 2. Payment Settings -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
    <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
      <i class="fas fa-credit-card mr-2 text-green-500"></i>
      Payment Settings
    </h2>
    <form method="POST" id="payment-form">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <input type="hidden" name="section" value="payment">
      
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ModemPay API Key (Secret Key)</label>
          <input type="password" name="modempay_api_key" value="{{ settings.modempay_api_key or '' }}" 
                 class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500"
                 placeholder="sk_live_...">
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ModemPay Public Key</label>
          <input type="text" name="modempay_public_key" value="{{ settings.modempay_public_key or '' }}" 
                 class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500"
                 placeholder="pk_live_...">
        </div>
        
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Return URL</label>
            <input type="url" name="payment_return_url" value="{{ settings.payment_return_url or '' }}" 
                   class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Cancel URL</label>
            <input type="url" name="payment_cancel_url" value="{{ settings.payment_cancel_url or '' }}" 
                   class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500">
          </div>
        </div>
        
        <div class="flex items-center">
          <input type="checkbox" name="payments_enabled" id="payments_enabled" 
                 {% if settings.payments_enabled %}checked{% endif %}
                 class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
          <label for="payments_enabled" class="ml-2 block text-sm text-gray-700 dark:text-gray-300">
            Enable Payments
          </label>
        </div>
      </div>
      
      <div class="mt-6 flex gap-3">
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-500">
          <i class="fas fa-save mr-2"></i>Save Payment Settings
        </button>
        <button type="button" onclick="testPayment()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 focus:ring-2 focus:ring-green-500">
          <i class="fas fa-vial mr-2"></i>Test Payment
        </button>
      </div>
    </form>
  </div>

  <!-- 3. Cloudinary Settings -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
    <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
      <i class="fas fa-cloud mr-2 text-purple-500"></i>
      Cloudinary Settings
    </h2>
    <form method="POST" id="cloudinary-form">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <input type="hidden" name="section" value="cloudinary">
      
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Cloud Name</label>
          <input type="text" name="cloudinary_cloud_name" value="{{ settings.cloudinary_cloud_name or '' }}" 
                 class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500">
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">API Key</label>
          <input type="text" name="cloudinary_api_key" value="{{ settings.cloudinary_api_key or '' }}" 
                 class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500">
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">API Secret</label>
          <input type="password" name="cloudinary_api_secret" value="" 
                 placeholder="Leave blank to keep current"
                 class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500">
          <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Leave blank to keep current secret</p>
        </div>
      </div>
      
      <div class="mt-6 flex gap-3">
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-500">
          <i class="fas fa-save mr-2"></i>Save Cloudinary Settings
        </button>
        <button type="button" onclick="testCloudinary()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 focus:ring-2 focus:ring-purple-500">
          <i class="fas fa-vial mr-2"></i>Test Upload
        </button>
      </div>
    </form>
  </div>

  <!-- 4. WhatsApp Settings -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
    <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
      <i class="fab fa-whatsapp mr-2 text-green-500"></i>
      WhatsApp Settings
    </h2>
    
    <!-- Token Status Indicator -->
    {% if whatsapp_token_status %}
      {% if whatsapp_token_status.is_expired %}
      <div class="mb-4 p-4 rounded-md bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800">
        <div class="flex items-center">
          <i class="fas fa-exclamation-circle h-5 w-5 text-red-400 mr-3"></i>
          <div>
            <p class="text-sm font-semibold text-red-800 dark:text-red-200">
              ❌ WhatsApp access token has EXPIRED
            </p>
            {% if whatsapp_token_status.error_info %}
            <p class="text-xs text-red-700 dark:text-red-300 mt-1">
              {{ whatsapp_token_status.error_info.message or 'Token expired' }}
            </p>
            {% endif %}
          </div>
        </div>
      </div>
      {% elif whatsapp_token_status.is_valid %}
      <div class="mb-4 p-4 rounded-md bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800">
        <div class="flex items-center">
          <i class="fas fa-check-circle h-5 w-5 text-green-400 mr-3"></i>
          <p class="text-sm font-semibold text-green-800 dark:text-green-200">
            ✅ WhatsApp access token is valid
          </p>
        </div>
      </div>
      {% elif whatsapp_token_status.configured and not whatsapp_token_status.is_valid %}
      <div class="mb-4 p-4 rounded-md bg-orange-50 dark:bg-orange-900/20 border border-orange-200 dark:border-orange-800">
        <div class="flex items-center">
          <i class="fas fa-exclamation-triangle h-5 w-5 text-orange-400 mr-3"></i>
          <div>
            <p class="text-sm font-semibold text-orange-800 dark:text-orange-200">
              ⚠️ WhatsApp token validation failed
            </p>
            {% if whatsapp_token_status.error_info %}
            <p class="text-xs text-orange-700 dark:text-orange-300 mt-1">
              {{ whatsapp_token_status.error_info.message or 'Unknown error' }}
            </p>
            {% endif %}
          </div>
        </div>
      </div>
      {% endif %}
    {% endif %}

    <!-- Instructions Panel -->
    <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-4">
      <div class="flex items-start">
        <div class="flex-shrink-0">
          <i class="fas fa-info-circle h-5 w-5 text-blue-400 mt-0.5"></i>
        </div>
        <div class="ml-3 flex-1">
          <h3 class="text-sm font-semibold text-blue-800 dark:text-blue-200 mb-2">
            How to Generate a WhatsApp Access Token
          </h3>
          <ol class="list-decimal list-inside space-y-1 text-xs text-blue-700 dark:text-blue-300 mb-3">
            <li>Go to <a href="https://developers.facebook.com/apps" target="_blank" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 underline">Meta Developer Console</a></li>
            <li>Select your WhatsApp Business App</li>
            <li>Navigate to <strong>WhatsApp → API Setup</strong></li>
            <li>Find the <strong>"Temporary access token"</strong> section (or generate a System User token for permanent access)</li>
            <li>Click <strong>"Copy"</strong> to copy the token</li>
            <li>Paste it in the <strong>"WhatsApp Access Token"</strong> field below</li>
            <li>Click <strong>"Save WhatsApp Settings"</strong> - the token will be saved to .env and reloaded automatically</li>
          </ol>
          <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded p-2 mt-2">
            <p class="text-xs text-yellow-800 dark:text-yellow-200">
              <strong>Note:</strong> Temporary tokens expire after 1-24 hours. For production, create a <strong>System User token</strong> which doesn't expire. 
              See <a href="https://developers.facebook.com/docs/whatsapp/cloud-api/get-started" target="_blank" class="underline">Meta's documentation</a> for details.
            </p>
          </div>
        </div>
      </div>
    </div>
    
    <form method="POST" id="whatsapp-form">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <input type="hidden" name="section" value="whatsapp">
      
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            WhatsApp Access Token <span class="text-red-500">*</span>
          </label>
          <input type="password" name="whatsapp_access_token" value="{{ settings.whatsapp_access_token or '' }}" 
                 class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500"
                 placeholder="EAAxxxxxxxxxxxxx">
          <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
            Your WhatsApp access token from Meta Developer Console. Token is saved to .env and reloaded automatically when you save.
          </p>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Phone Number ID <span class="text-red-500">*</span>
          </label>
          <input type="text" name="whatsapp_phone_number_id" value="{{ settings.whatsapp_phone_number_id or '' }}" 
                 class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500"
                 placeholder="123456789012345">
          <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
            Your WhatsApp Business Phone Number ID (found in Meta Developer Console → WhatsApp → API Setup).
          </p>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Business Name</label>
          <input type="text" name="whatsapp_business_name" value="{{ settings.whatsapp_business_name or '' }}" 
                 class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500">
        </div>
        
        <div class="flex items-center">
          <input type="checkbox" name="whatsapp_bulk_messaging_enabled" id="whatsapp_bulk_messaging_enabled" 
                 {% if settings.whatsapp_bulk_messaging_enabled %}checked{% endif %}
                 class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
          <label for="whatsapp_bulk_messaging_enabled" class="ml-2 block text-sm text-gray-700 dark:text-gray-300">
            Enable Bulk Messaging
          </label>
        </div>
      </div>
      
      <div class="mt-6 flex gap-3">
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-500">
          <i class="fas fa-save mr-2"></i>Save WhatsApp Settings
        </button>
        <button type="button" onclick="testWhatsApp()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 focus:ring-2 focus:ring-green-500">
          <i class="fas fa-vial mr-2"></i>Test Message
        </button>
      </div>
    </form>
  </div>

  <!-- 5. Email Settings (Resend) -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
    <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
      <i class="fas fa-envelope mr-2 text-red-500"></i>
      Email Settings (Resend)
    </h2>
    <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-4">
      <p class="text-sm text-blue-800 dark:text-blue-200">
        <i class="fas fa-info-circle mr-2"></i>
        Your app uses Resend for email delivery. Configure your email settings below. The API key can be set in environment variables (RESEND_API_KEY) or stored in the database.
      </p>
    </div>
    <form method="POST" id="email-form">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <input type="hidden" name="section" value="email">
      
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Resend API Key
          </label>
          <input type="password" name="resend_api_key" value="{{ settings.resend_api_key or '' }}" 
                 placeholder="re_..."
                 class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500">
          <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Resend API key (can also be set via RESEND_API_KEY environment variable). Leave blank to use environment variable.</p>
        </div>
        
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              From Email <span class="text-red-500">*</span>
            </label>
            <input type="email" name="resend_from_email" value="{{ settings.resend_from_email or '' }}" 
                   placeholder="onboarding@resend.dev"
                   class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500"
                   required>
            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">The email address that sends emails (must be verified in Resend)</p>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              Default Recipient
            </label>
            <input type="email" name="resend_default_recipient" value="{{ settings.resend_default_recipient or '' }}" 
                   placeholder="admin@example.com"
                   class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500">
            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Default recipient for admin emails (backups, notifications, etc.)</p>
          </div>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Contact Email
          </label>
          <input type="email" name="contact_email" value="{{ settings.contact_email or '' }}" 
                 placeholder="support@example.com"
                 class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500">
          <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Email address for customer support inquiries</p>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Default Subject Prefix
          </label>
          <input type="text" name="default_subject_prefix" value="{{ settings.default_subject_prefix or 'buxin store' }}" 
                 placeholder="buxin store"
                 class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500">
          <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Default prefix added to email subjects (e.g., "buxin store - Order Confirmation")</p>
        </div>
        
        <div class="flex items-center">
          <input type="checkbox" name="resend_enabled" id="resend_enabled" 
                 {% if settings.resend_enabled %}checked{% endif %}
                 class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
          <label for="resend_enabled" class="ml-2 block text-sm text-gray-700 dark:text-gray-300">
            Enable Resend Email Sending
          </label>
        </div>
      </div>
      
      <div class="mt-6 flex gap-3">
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-500">
          <i class="fas fa-save mr-2"></i>Save Email Settings
        </button>
        <button type="button" onclick="testEmail()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 focus:ring-2 focus:ring-red-500">
          <i class="fas fa-vial mr-2"></i>Test Email
        </button>
      </div>
    </form>
  </div>

  <!-- 6. PWA Settings -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
    <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
      <i class="fas fa-mobile-alt mr-2 text-indigo-500"></i>
      PWA Settings (Progressive Web App)
    </h2>
    <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-4">
      <p class="text-sm text-blue-800 dark:text-blue-200">
        <i class="fas fa-info-circle mr-2"></i>
        Configure your Progressive Web App settings. These settings control how your app appears when installed on mobile devices and desktops.
      </p>
    </div>
    <form method="POST" id="pwa-form" enctype="multipart/form-data">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <input type="hidden" name="section" value="pwa">
      
      <div class="space-y-6">
        <div class="grid md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              App Name <span class="text-red-500">*</span>
            </label>
            <input type="text" name="pwa_app_name" 
                   value="{{ settings.pwa_app_name or 'buxin store' }}" 
                   placeholder="buxin store"
                   class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500"
                   required>
            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Full name shown in app launcher</p>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              Short Name <span class="text-red-500">*</span>
            </label>
            <input type="text" name="pwa_short_name" 
                   value="{{ settings.pwa_short_name or 'buxin store' }}" 
                   placeholder="buxin store"
                   maxlength="12"
                   class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500"
                   required>
            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Short name for home screen (max 12 characters)</p>
          </div>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Description
          </label>
          <textarea name="pwa_description" rows="3"
                    placeholder="buxin store - Your gateway to the future of technology. Explore robotics, coding, and artificial intelligence."
                    class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500">{{ settings.pwa_description or 'buxin store - Your gateway to the future of technology. Explore robotics, coding, and artificial intelligence.' }}</textarea>
          <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">App description shown in app stores and install prompts</p>
        </div>
        
        <div class="grid md:grid-cols-3 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              Theme Color <span class="text-red-500">*</span>
            </label>
            <div class="flex items-center gap-2">
              <input type="color" name="pwa_theme_color" 
                     id="pwa_theme_color"
                     value="{{ settings.pwa_theme_color or '#ffffff' }}"
                     class="h-10 w-20 rounded border border-gray-300 dark:border-gray-600 cursor-pointer"
                     onchange="document.getElementById('pwa_theme_color_text').value=this.value"
                     required>
              <input type="text" 
                     id="pwa_theme_color_text"
                     value="{{ settings.pwa_theme_color or '#ffffff' }}"
                     onchange="if(this.value.match(/^#[0-9A-Fa-f]{6}$/)){document.getElementById('pwa_theme_color').value=this.value}"
                     pattern="^#[0-9A-Fa-f]{6}$"
                     placeholder="#ffffff"
                     class="flex-1 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500">
            </div>
            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Toolbar color on mobile browsers</p>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              Background Color <span class="text-red-500">*</span>
            </label>
            <div class="flex items-center gap-2">
              <input type="color" name="pwa_background_color" 
                     id="pwa_background_color"
                     value="{{ settings.pwa_background_color or '#ffffff' }}"
                     class="h-10 w-20 rounded border border-gray-300 dark:border-gray-600 cursor-pointer"
                     onchange="document.getElementById('pwa_background_color_text').value=this.value"
                     required>
              <input type="text" 
                     id="pwa_background_color_text"
                     value="{{ settings.pwa_background_color or '#ffffff' }}"
                     onchange="if(this.value.match(/^#[0-9A-Fa-f]{6}$/)){document.getElementById('pwa_background_color').value=this.value}"
                     pattern="^#[0-9A-Fa-f]{6}$"
                     placeholder="#ffffff"
                     class="flex-1 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500">
            </div>
            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Splash screen background color</p>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              Display Mode <span class="text-red-500">*</span>
            </label>
            <select name="pwa_display" 
                    class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500"
                    required>
              <option value="standalone" {% if settings.pwa_display == 'standalone' or not settings.pwa_display %}selected{% endif %}>Standalone</option>
              <option value="fullscreen" {% if settings.pwa_display == 'fullscreen' %}selected{% endif %}>Fullscreen</option>
              <option value="minimal-ui" {% if settings.pwa_display == 'minimal-ui' %}selected{% endif %}>Minimal UI</option>
              <option value="browser" {% if settings.pwa_display == 'browser' %}selected{% endif %}>Browser</option>
            </select>
            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">How app appears when launched</p>
          </div>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Start URL
          </label>
          <input type="text" name="pwa_start_url" 
                 value="{{ settings.pwa_start_url or '/' }}" 
                 placeholder="/"
                 class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500">
          <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">URL to open when app is launched (default: /)</p>
        </div>
        
        <div class="grid md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              PWA Logo (512×512) <span class="text-red-500">*</span>
            </label>
            <div class="flex items-center gap-4">
              {% if settings.pwa_logo_path %}
              <div class="w-24 h-24 border border-gray-300 dark:border-gray-600 rounded-lg overflow-hidden bg-white dark:bg-gray-700">
                <img src="{{ url_for('static', filename=settings.pwa_logo_path) }}" alt="PWA Logo" class="w-full h-full object-cover">
              </div>
              {% endif %}
              <label class="cursor-pointer inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                <i class="fas fa-upload mr-2"></i>
                Upload Logo
                <input type="file" name="pwa_logo" accept="image/png,image/jpeg,image/jpg" class="hidden">
              </label>
            </div>
            <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">PNG or JPG, recommended size 512×512px. Will be used for app icons.</p>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              Favicon / Head Icon (32×32 or 64×64)
            </label>
            <div class="flex items-center gap-4">
              {% if settings.pwa_favicon_path %}
              <div class="w-16 h-16 border border-gray-300 dark:border-gray-600 rounded-lg overflow-hidden bg-white dark:bg-gray-700">
                <img src="{{ url_for('static', filename=settings.pwa_favicon_path) }}" alt="Favicon" class="w-full h-full object-cover">
              </div>
              {% endif %}
              <label class="cursor-pointer inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                <i class="fas fa-upload mr-2"></i>
                Upload Favicon
                <input type="file" name="pwa_favicon" accept="image/png,image/x-icon,image/jpeg,image/jpg" class="hidden">
              </label>
            </div>
            <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">PNG or ICO, recommended sizes 32×32 or 64×64px. Shown in browser tabs.</p>
          </div>
        </div>
      </div>
      
      <div class="mt-6 flex gap-3">
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-500">
          <i class="fas fa-save mr-2"></i>Save PWA Settings
        </button>
        <button type="button" onclick="window.open('/manifest.json', '_blank')" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 focus:ring-2 focus:ring-indigo-500">
          <i class="fas fa-eye mr-2"></i>Preview Manifest
        </button>
      </div>
    </form>
  </div>

  <!-- 7. Data & Security -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
    <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
      <i class="fas fa-database mr-2 text-yellow-500"></i>
      Data & Security
    </h2>
    
    <div class="grid md:grid-cols-3 gap-4 mb-6">
      <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
        <div class="text-2xl font-bold text-gray-900 dark:text-white">{{ total_customers }}</div>
        <div class="text-sm text-gray-600 dark:text-gray-400">Total Customers</div>
      </div>
      <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
        <div class="text-2xl font-bold text-gray-900 dark:text-white">{{ total_products }}</div>
        <div class="text-sm text-gray-600 dark:text-gray-400">Total Products</div>
      </div>
      <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
        <div class="text-2xl font-bold text-gray-900 dark:text-white">{{ total_orders }}</div>
        <div class="text-sm text-gray-600 dark:text-gray-400">Total Orders</div>
      </div>
    </div>
    
    <div class="flex flex-wrap gap-3">
      <button onclick="backupDatabase()" class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 focus:ring-2 focus:ring-yellow-500">
        <i class="fas fa-download mr-2"></i>Backup Database
      </button>
      <button onclick="clearCache()" class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 focus:ring-2 focus:ring-orange-500">
        <i class="fas fa-broom mr-2"></i>Clear Cache
      </button>
      <a href="/admin/migrate" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 focus:ring-2 focus:ring-indigo-500 inline-flex items-center">
        <i class="fas fa-database mr-2"></i>Run Database Migration
      </a>
      <a href="/admin/reports" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 focus:ring-2 focus:ring-gray-500 inline-flex items-center">
        <i class="fas fa-chart-bar mr-2"></i>View Reports
      </a>
    </div>
  </div>

  <!-- 7. AI Control (Optional) -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
    <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
      <i class="fas fa-robot mr-2 text-indigo-500"></i>
      AI Control (Optional)
    </h2>
    <form method="POST" id="ai-form">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <input type="hidden" name="section" value="ai">
      
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">AI API Key</label>
          <input type="password" name="ai_api_key" value="{{ settings.ai_api_key or '' }}" 
                 class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500"
                 placeholder="sk-...">
        </div>
        
        <div class="flex items-center">
          <input type="checkbox" name="ai_auto_prompt_improvements" id="ai_auto_prompt_improvements" 
                 {% if settings.ai_auto_prompt_improvements %}checked{% endif %}
                 class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
          <label for="ai_auto_prompt_improvements" class="ml-2 block text-sm text-gray-700 dark:text-gray-300">
            Enable Auto-Prompt Improvements
          </label>
        </div>
      </div>
      
      <div class="mt-6">
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-500">
          <i class="fas fa-save mr-2"></i>Save AI Settings
        </button>
      </div>
    </form>
  </div>
</div>

<script>
function getCSRFToken() {
  // Try to get from meta tag first, then from form field
  const metaToken = document.querySelector('meta[name="csrf-token"]');
  if (metaToken) {
    return metaToken.getAttribute('content');
  }
  const formToken = document.querySelector('[name="csrf_token"]');
  if (formToken) {
    return formToken.value;
  }
  return '';
}

function showToast(message, type = 'success') {
  const container = document.getElementById('toast-container');
  const toast = document.createElement('div');
  toast.className = `px-4 py-3 rounded-lg shadow-lg ${type === 'success' ? 'bg-green-500' : 'bg-red-500'} text-white flex items-center justify-between min-w-[300px]`;
  toast.innerHTML = `
    <span>${message}</span>
    <button onclick="this.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
      <i class="fas fa-times"></i>
    </button>
  `;
  container.appendChild(toast);
  setTimeout(() => toast.remove(), 5000);
}

async function testPayment() {
  const btn = event.target.closest('button');
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Testing...';
  
  try {
    const response = await fetch('/admin/settings/test-payment', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken()
      }
    });
    const data = await response.json();
    showToast(data.message, data.success ? 'success' : 'error');
  } catch (error) {
    showToast('Error testing payment: ' + error.message, 'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
}

async function testCloudinary() {
  const btn = event.target.closest('button');
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Testing...';
  
  try {
    const response = await fetch('/admin/settings/test-cloudinary', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken()
      }
    });
    const data = await response.json();
    showToast(data.message, data.success ? 'success' : 'error');
  } catch (error) {
    showToast('Error testing Cloudinary: ' + error.message, 'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
}

async function testWhatsApp() {
  const testNumber = prompt('Enter WhatsApp number to test (e.g., +2200000000):', '+2200000000');
  if (!testNumber) return;
  
  const btn = event.target.closest('button');
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Sending...';
  
  try {
    const response = await fetch('/admin/settings/test-whatsapp', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken()
      },
      body: JSON.stringify({ test_number: testNumber })
    });
    const data = await response.json();
    showToast(data.message, data.success ? 'success' : 'error');
  } catch (error) {
    showToast('Error testing WhatsApp: ' + error.message, 'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
}

async function testEmail() {
  const testEmail = prompt('Enter email address to test:', '{{ current_user.email }}');
  if (!testEmail) return;
  
  const btn = event.target.closest('button');
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Sending...';
  
  try {
    const response = await fetch('/admin/settings/test-email', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken()
      },
      body: JSON.stringify({ test_email: testEmail })
    });
    const data = await response.json();
    showToast(data.message, data.success ? 'success' : 'error');
  } catch (error) {
    showToast('Error testing email: ' + error.message, 'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
}

async function backupDatabase() {
  const btn = event.target;
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Backing up...';
  
  try {
    const response = await fetch('/admin/settings/backup-database', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken()
      }
    });
    
    // Check if response is JSON
    const contentType = response.headers.get('content-type');
    if (contentType && contentType.includes('application/json')) {
      const data = await response.json();
      showToast(data.message, data.success ? 'success' : 'error');
    } else {
      // Response is not JSON (likely HTML error page)
      const text = await response.text();
      showToast('Error backing up database: Server returned an error. Please check the console.', 'error');
      console.error('Non-JSON response:', text.substring(0, 200));
    }
  } catch (error) {
    showToast('Error backing up database: ' + error.message, 'error');
    console.error('Backup error:', error);
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
}

async function clearCache() {
  const btn = event.target;
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Clearing...';
  
  try {
    const response = await fetch('/admin/settings/clear-cache', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken()
      }
    });
    const data = await response.json();
    showToast(data.message, data.success ? 'success' : 'error');
  } catch (error) {
    showToast('Error clearing cache: ' + error.message, 'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
}
</script>
{% endblock %}

