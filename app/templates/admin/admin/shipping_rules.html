{% extends 'admin/admin/base.html' %}

{% block header %}Shipping Rules{% endblock %}

{% block content %}
<div class="py-4">
    <div class="flex justify-between items-center mb-4">
        <div>
            <h2 class="text-2xl font-semibold text-gray-900 dark:text-white">Shipping Rules Management</h2>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Manage shipping costs based on country and weight</p>
        </div>
        <div class="flex gap-2">
            <button type="button" 
                    id="bulk-delete-btn"
                    onclick="bulkDeleteRules()"
                    disabled
                    class="inline-flex items-center px-4 py-2 border border-red-300 dark:border-red-600 text-sm font-medium rounded-md shadow-sm text-red-700 dark:text-red-300 bg-white dark:bg-gray-700 hover:bg-red-50 dark:hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fas fa-trash mr-2"></i> Delete Selected
            </button>
            <a href="{{ url_for('admin_export_shipping_rules', format='csv') }}" 
               class="inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md shadow-sm text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                <i class="fas fa-file-csv mr-2"></i> Export CSV
            </a>
            <a href="{{ url_for('admin_export_shipping_rules', format='json') }}" 
               class="inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md shadow-sm text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                <i class="fas fa-download mr-2"></i> Export JSON
            </a>
            <form method="POST" action="{{ url_for('admin_import_shipping_rules') }}" enctype="multipart/form-data" class="inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <label class="inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md shadow-sm text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 cursor-pointer">
                    <i class="fas fa-upload mr-2"></i> Import
                    <input type="file" name="file" accept=".csv,.xlsx" class="hidden" onchange="this.form.submit()">
                </label>
            </form>
            <a href="{{ url_for('admin_new_shipping_rule') }}" 
               class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                <i class="fas fa-plus mr-2"></i> Add Rule
            </a>
        </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="mb-4 space-y-2">
                {% for category, message in messages %}
                    <div class="px-4 py-3 rounded-lg text-sm {% if category == 'success' %}bg-green-50 text-green-700 border border-green-200 dark:bg-green-900/30 dark:text-green-200 dark:border-green-700/40{% elif category == 'warning' %}bg-yellow-50 text-yellow-700 border border-yellow-200 dark:bg-yellow-900/30 dark:text-yellow-200 dark:border-yellow-700/40{% else %}bg-red-50 text-red-700 border border-red-200 dark:bg-red-900/30 dark:text-red-200 dark:border-red-700/40{% endif %}">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- New Simplified System Notice -->
    <div class="mb-6 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
        <div class="flex">
            <div class="flex-shrink-0">
                <i class="fas fa-info-circle text-blue-400"></i>
            </div>
            <div class="ml-3">
                <h3 class="text-sm font-medium text-blue-800 dark:text-blue-200">
                    üöÄ Simplified Shipping Pricing System
                </h3>
                <div class="mt-2 text-sm text-blue-700 dark:text-blue-300">
                    <p class="mb-2">
                        <strong>New System:</strong> You only need to enter <strong>one base price for 0.5 kg</strong> per shipping method and country.
                    </p>
                    <p class="mb-2">
                        The system automatically calculates shipping for any weight using the formula:
                    </p>
                    <p class="font-mono bg-blue-100 dark:bg-blue-900/40 p-2 rounded mb-2">
                        <strong>Total Shipping Price = (Product Weight / 0.5) √ó Base Price for 0.5 kg</strong>
                    </p>
                    <p class="text-xs">
                        <strong>Example:</strong> If Express base price is D30 for 0.5kg, a 1.5kg product = (1.5 / 0.5) √ó 30 = D90
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-4">
            <div class="text-sm font-medium text-gray-500 dark:text-gray-400">Total Rules</div>
            <div class="text-2xl font-bold text-gray-900 dark:text-white mt-1">{{ total_rules }}</div>
        </div>
        <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-4">
            <div class="text-sm font-medium text-gray-500 dark:text-gray-400">Active Rules</div>
            <div class="text-2xl font-bold text-green-600 dark:text-green-400 mt-1">{{ active_rules }}</div>
        </div>
        <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-4">
            <div class="text-sm font-medium text-gray-500 dark:text-gray-400">Global Rules</div>
            <div class="text-2xl font-bold text-blue-600 dark:text-blue-400 mt-1">{{ global_rules }}</div>
        </div>
        <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-4">
            <div class="text-sm font-medium text-gray-500 dark:text-gray-400">Countries with Rules</div>
            <div class="text-2xl font-bold text-purple-600 dark:text-purple-400 mt-1">{{ countries_with_rules }}</div>
        </div>
    </div>

    <!-- Shipping Calculator Widget -->
    <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6 mb-6">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Shipping Calculator</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Weight (kg)</label>
                <input type="number" 
                       id="calc-weight" 
                       step="0.001" 
                       min="0" 
                       placeholder="0.5"
                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Country</label>
                <select id="calc-country" 
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                    <option value="">Select Country</option>
                    {% for country in countries %}
                    <option value="{{ country.id }}">{{ country.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="flex items-end">
                <button onclick="calculateShipping()" 
                        class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    Calculate
                </button>
            </div>
        </div>
        <div id="calc-result" class="mt-4 hidden">
            <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-md">
                <div id="calc-result-content"></div>
            </div>
        </div>
    </div>

    <!-- Search and Filter Bar -->
    <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-4 mb-4">
        <form method="GET" action="{{ url_for('admin_shipping_rules') }}" class="flex flex-wrap gap-4 items-end">
            <div class="flex-1 min-w-[200px]">
                <label for="search" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Search</label>
                <input type="text" 
                       id="search" 
                       name="search" 
                       value="{{ search }}" 
                       placeholder="Search by country, notes..."
                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
            </div>
            <div class="min-w-[150px]">
                <label for="country_iso" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Country</label>
                <select id="country_iso" 
                        name="country_iso" 
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                    <option value="">All Countries</option>
                    <option value="*" {% if country_iso == '*' %}selected{% endif %}>Global</option>
                    {% for country in countries %}
                    <option value="{{ country.code }}" {% if country_iso == country.code %}selected{% endif %}>{{ country.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="min-w-[150px]">
                <label for="mode_key" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Shipping Method</label>
                <select id="mode_key" 
                        name="mode_key" 
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                    <option value="">All Methods</option>
                    {% for mode in shipping_modes %}
                    <option value="{{ mode.key }}" {% if mode_key == mode.key %}selected{% endif %}>{{ mode.label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="min-w-[150px]">
                <label for="status" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Status</label>
                <select id="status" 
                        name="status" 
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                    <option value="">All</option>
                    <option value="active" {% if status_filter == 'active' %}selected{% endif %}>Active</option>
                    <option value="inactive" {% if status_filter == 'inactive' %}selected{% endif %}>Inactive</option>
                </select>
            </div>
            <div class="min-w-[150px]">
                <label for="sort" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Sort By</label>
                <select id="sort" 
                        name="sort" 
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                    <option value="priority" {% if sort_by == 'priority' %}selected{% endif %}>Priority</option>
                    <option value="country" {% if sort_by == 'country' %}selected{% endif %}>Country</option>
                    <option value="min_weight" {% if sort_by == 'min_weight' %}selected{% endif %}>Min Weight</option>
                    <option value="price" {% if sort_by == 'price' %}selected{% endif %}>Price</option>
                </select>
            </div>
            <div class="min-w-[120px]">
                <label for="order" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Order</label>
                <select id="order" 
                        name="order" 
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                    <option value="desc" {% if sort_order == 'desc' %}selected{% endif %}>Descending</option>
                    <option value="asc" {% if sort_order == 'asc' %}selected{% endif %}>Ascending</option>
                </select>
            </div>
            <div>
                <button type="submit" 
                        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <i class="fas fa-filter mr-2"></i> Apply
                </button>
            </div>
        </form>
    </div>

    <!-- Rules Table -->
    <div class="bg-white dark:bg-gray-800 shadow rounded-lg overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-700">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                            <input type="checkbox" 
                                   id="select-all-checkbox" 
                                   onchange="toggleAllCheckboxes(this)"
                                   class="rounded border-gray-300 text-blue-600 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600">
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Type</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Country</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Method</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Weight Range (kg)</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Price (GMD)</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Delivery</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Priority</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                    {% for rule in rules.items %}
                    {% set country = None %}
                    {% if rule.country_iso and rule.country_iso != '*' %}
                        {% for c in countries %}
                            {% if c.code == rule.country_iso %}
                                {% set country = c %}
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <input type="checkbox" 
                                   class="rule-checkbox rounded border-gray-300 text-blue-600 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600"
                                   value="{{ rule.id }}"
                                   onchange="updateBulkDeleteButton()">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if rule.country_iso == '*' %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">
                                    üåç Global
                                </span>
                            {% else %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">
                                    Country
                                </span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if country %}
                                <div class="flex items-center gap-2">
                                    <div class="flex-shrink-0 w-6 h-6 rounded-full overflow-hidden border border-gray-200 dark:border-gray-700">
                                        <img src="{{ country.get_flag_url() }}" alt="{{ country.name }}" class="w-full h-full object-cover" onerror="this.style.display='none';">
                                    </div>
                                    <span class="text-sm text-gray-900 dark:text-white">{{ country.name }} ({{ rule.country_iso }})</span>
                                </div>
                            {% elif rule.country_iso == '*' %}
                                <span class="text-sm text-gray-400 dark:text-gray-500">Global</span>
                            {% else %}
                                <span class="text-sm text-gray-400 dark:text-gray-500">{{ rule.country_iso }}</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if rule.shipping_mode %}
                                {% if rule.shipping_mode_key == 'express' %}
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200">
                                        üöÄ {{ rule.shipping_mode.label }}
                                    </span>
                                {% elif rule.shipping_mode_key == 'economy_plus' %}
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200">
                                        üì¶ {{ rule.shipping_mode.label }}
                                    </span>
                                {% elif rule.shipping_mode_key == 'economy' %}
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">
                                        üìÆ {{ rule.shipping_mode.label }}
                                    </span>
                                {% else %}
                                    <span class="text-sm text-gray-900 dark:text-white">{{ rule.shipping_mode.label }}</span>
                                {% endif %}
                            {% else %}
                                <span class="text-sm text-gray-400 dark:text-gray-500">{{ rule.shipping_mode_key }}</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">
                            {{ "%.3f"|format(rule.min_weight) }} - {{ "%.3f"|format(rule.max_weight) }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">
                            D{{ "%.2f"|format(rule.price_gmd) }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                            {{ rule.delivery_time or (rule.shipping_mode.delivery_time_range if rule.shipping_mode else '‚Äî') }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">
                            {{ rule.priority }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if rule.active %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">
                                    Active
                                </span>
                            {% else %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300">
                                    Inactive
                                </span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <div class="flex items-center gap-2">
                                <a href="{{ url_for('admin_edit_shipping_rule', rule_id=rule.id) }}" 
                                   class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <form method="POST" action="{{ url_for('admin_duplicate_shipping_rule', rule_id=rule.id) }}" class="inline">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="text-purple-600 hover:text-purple-900 dark:text-purple-400 dark:hover:text-purple-300" title="Duplicate">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </form>
                                <form method="POST" action="{{ url_for('admin_toggle_shipping_rule_status', rule_id=rule.id) }}" class="inline">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="text-yellow-600 hover:text-yellow-900 dark:text-yellow-400 dark:hover:text-yellow-300" title="Toggle Status">
                                        <i class="fas fa-toggle-{% if rule.active %}on{% else %}off{% endif %}"></i>
                                    </button>
                                </form>
                                <form method="POST" action="{{ url_for('admin_delete_shipping_rule', rule_id=rule.id) }}" 
                                      class="inline"
                                      onsubmit="return confirm('Are you sure you want to delete this shipping rule?');">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="10" class="px-6 py-4 text-center text-sm text-gray-500 dark:text-gray-400">
                            No shipping rules found.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if rules.pages > 1 %}
        <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-between items-center">
            <div class="text-sm text-gray-500 dark:text-gray-400">
                Showing page {{ rules.page }} of {{ rules.pages }} ({{ rules.total }} total rules)
            </div>
            <div class="flex space-x-2">
                {% if rules.has_prev %}
                <a href="{{ url_for('admin_shipping_rules', page=rules.prev_num, search=search, country_iso=country_iso, mode_key=mode_key, status=status_filter, sort=sort_by, order=sort_order) }}" 
                   class="px-3 py-1 rounded-md border border-gray-300 dark:border-gray-600 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                    Previous
                </a>
                {% endif %}
                {% if rules.has_next %}
                <a href="{{ url_for('admin_shipping_rules', page=rules.next_num, search=search, country_iso=country_iso, mode_key=mode_key, status=status_filter, sort=sort_by, order=sort_order) }}" 
                   class="px-3 py-1 rounded-md border border-gray-300 dark:border-gray-600 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                    Next
                </a>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
function calculateShipping() {
    const weight = parseFloat(document.getElementById('calc-weight').value);
    const countryId = document.getElementById('calc-country').value;
    const resultDiv = document.getElementById('calc-result');
    const resultContent = document.getElementById('calc-result-content');
    
    if (!weight || weight <= 0) {
        alert('Please enter a valid weight');
        return;
    }
    
    fetch('/api/shipping/estimate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            weight: weight,
            country_id: countryId || null
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.available) {
            resultContent.innerHTML = `
                <div class="text-green-600 dark:text-green-400 font-semibold">‚úì Shipping Available</div>
                <div class="mt-2">
                    <div><strong>Price:</strong> D${data.price_gmd.toFixed(2)}</div>
                    ${data.delivery_time ? `<div><strong>Delivery:</strong> ${data.delivery_time}</div>` : ''}
                    <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                        Rule: ${data.rule.rule_type === 'global' ? 'Global' : data.rule.country_name} 
                        (${data.rule.min_weight}kg - ${data.rule.max_weight}kg)
                    </div>
                </div>
            `;
            resultDiv.classList.remove('hidden');
        } else if (data.success && data.suggestion) {
            resultContent.innerHTML = `
                <div class="text-yellow-600 dark:text-yellow-400 font-semibold">‚ö† Shipping Unavailable</div>
                <div class="mt-2">
                    <div>${data.message}</div>
                    <div class="mt-2 text-sm">
                        <strong>Nearest rule:</strong> ${data.suggestion.min_weight}kg+ = D${data.suggestion.price_gmd.toFixed(2)}
                        ${data.suggestion.delivery_time ? ` (${data.suggestion.delivery_time})` : ''}
                    </div>
                </div>
            `;
            resultDiv.classList.remove('hidden');
        } else {
            resultContent.innerHTML = `
                <div class="text-red-600 dark:text-red-400 font-semibold">‚úó Shipping Unavailable</div>
                <div class="mt-2">${data.message || 'No shipping rules found for this combination.'}</div>
            `;
            resultDiv.classList.remove('hidden');
        }
    })
    .catch(error => {
        resultContent.innerHTML = `
            <div class="text-red-600 dark:text-red-400 font-semibold">Error</div>
            <div class="mt-2">Failed to calculate shipping: ${error.message}</div>
        `;
        resultDiv.classList.remove('hidden');
    });
}

function toggleAllCheckboxes(checkbox) {
    const checkboxes = document.querySelectorAll('.rule-checkbox');
    checkboxes.forEach(cb => {
        cb.checked = checkbox.checked;
    });
    updateBulkDeleteButton();
}

function updateBulkDeleteButton() {
    const checkboxes = document.querySelectorAll('.rule-checkbox:checked');
    const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
    if (bulkDeleteBtn) {
        bulkDeleteBtn.disabled = checkboxes.length === 0;
    }
}

function bulkDeleteRules() {
    const checkboxes = document.querySelectorAll('.rule-checkbox:checked');
    const ruleIds = Array.from(checkboxes).map(cb => cb.value);
    
    if (ruleIds.length === 0) {
        alert('Please select at least one rule to delete.');
        return;
    }
    
    if (!confirm(`Are you sure you want to delete ${ruleIds.length} rule(s)? Rules with dependencies will be deactivated instead of deleted.`)) {
        return;
    }
    
    // Create form and submit
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{{ url_for("admin_bulk_delete_shipping_rules") }}';
    
    // Add CSRF token
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrf_token';
    csrfInput.value = '{{ csrf_token() }}';
    form.appendChild(csrfInput);
    
    // Add rule IDs
    ruleIds.forEach(ruleId => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'rule_ids[]';
        input.value = ruleId;
        form.appendChild(input);
    });
    
    document.body.appendChild(form);
    form.submit();
}
</script>
{% endblock %}

