{% extends 'admin/admin/base.html' %}

{% block header %}Orders (Fully Paid Only){% endblock %}

{% block content %}
<div class="py-4 space-y-6">
    <!-- Filters Section -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Filters</h2>
        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
            Showing last 30 days by default. Select a date range and/or country for more detail.
        </p>
        <form method="GET" action="{{ url_for('admin_orders') }}" class="space-y-4">
            <div class="grid md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Date Filter</label>
                    <select name="date_filter" id="date_filter" class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500" onchange="toggleCustomDates()">
                        <option value="all" {% if date_filter == 'all' %}selected{% endif %}>All Time</option>
                        <option value="yesterday" {% if date_filter == 'yesterday' %}selected{% endif %}>Yesterday</option>
                        <option value="today" {% if date_filter == 'today' %}selected{% endif %}>Today</option>
                        <option value="tomorrow" {% if date_filter == 'tomorrow' %}selected{% endif %}>Tomorrow</option>
                        <option value="7days" {% if date_filter == '7days' %}selected{% endif %}>Last 7 Days</option>
                        <option value="30days" {% if date_filter == '30days' %}selected{% endif %}>Last 30 Days</option>
                        <option value="this_month" {% if date_filter == 'this_month' %}selected{% endif %}>This Month</option>
                        <option value="last_month" {% if date_filter == 'last_month' %}selected{% endif %}>Last Month</option>
                        <option value="this_year" {% if date_filter == 'this_year' %}selected{% endif %}>This Year</option>
                        <option value="custom" {% if date_filter == 'custom' %}selected{% endif %}>Custom Date Range</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Country Filter</label>
                    <div class="relative">
                        <button 
                            type="button"
                            id="country-filter-toggle"
                            class="w-full flex items-center justify-between rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500 text-left"
                            aria-haspopup="true"
                            aria-expanded="false"
                        >
                            <span class="flex items-center gap-2 flex-1 min-w-0">
                                <span id="country-filter-flag" class="flex-shrink-0 w-5 h-5 rounded-full overflow-hidden border border-gray-200 dark:border-gray-700 flex items-center justify-center bg-gray-100 dark:bg-gray-700">
                                    <i data-lucide="globe" class="w-3 h-3 text-gray-400"></i>
                                </span>
                                <span id="country-filter-name" class="flex-1 truncate text-gray-500 dark:text-gray-400">All Countries</span>
                            </span>
                            <i data-lucide="chevron-down" class="w-4 h-4 text-gray-400 flex-shrink-0 ml-2 transition-transform"></i>
                        </button>
                        <input type="hidden" name="country" id="country-filter-input" value="{{ country_filter or '' }}">
                        
                        <!-- Country Dropdown Menu -->
                        <div id="country-filter-dropdown" class="absolute z-50 w-full mt-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg shadow-lg hidden max-h-80 overflow-hidden flex flex-col">
                            <!-- Search Input -->
                            <div class="p-3 border-b border-gray-200 dark:border-gray-700 flex-shrink-0">
                                <input 
                                    type="text" 
                                    id="country-filter-search"
                                    placeholder="Search countries..."
                                    class="w-full px-3 py-2 text-sm rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                                >
                            </div>
                            <!-- Country List -->
                            <div id="country-filter-list" class="overflow-y-auto overscroll-contain p-2 space-y-1 flex-1 min-h-0 scrollbar-thin scrollbar-thumb-gray-300 dark:scrollbar-thumb-gray-600 scrollbar-track-transparent">
                                <button 
                                    type="button"
                                    class="w-full flex items-center gap-2 px-3 py-2 text-left hover:bg-gray-100 dark:hover:bg-gray-700/50 rounded-lg transition-colors {% if not country_filter %}bg-gray-100 dark:bg-gray-700/50 ring-2 ring-blue-500/30{% endif %}"
                                    data-country-name=""
                                    onclick="selectCountryFilter('')"
                                >
                                    <div class="flex-1 min-w-0">
                                        <div class="text-sm font-medium text-gray-900 dark:text-white">All Countries</div>
                                    </div>
                                    {% if not country_filter %}<i data-lucide="check" class="w-4 h-4 text-blue-500 flex-shrink-0"></i>{% endif %}
                                </button>
                                {% for country in countries %}
                                <button 
                                    type="button"
                                    class="w-full flex items-center gap-2 px-3 py-2 text-left hover:bg-gray-100 dark:hover:bg-gray-700/50 rounded-lg transition-colors {% if country_filter == country.name %}bg-gray-100 dark:bg-gray-700/50 ring-2 ring-blue-500/30{% endif %}"
                                    data-country-name="{{ country.name }}"
                                    onclick="selectCountryFilter('{{ country.name }}')"
                                >
                                    <div class="flex-shrink-0 w-6 h-6 rounded-full overflow-hidden border border-gray-200 dark:border-gray-700 flex items-center justify-center bg-gray-100 dark:bg-gray-700">
                                        {% if country.flag_url or country.flag_image_path or country.code %}
                                            <img src="{{ country.get_flag_url() }}" alt="{{ country.name }}" class="w-full h-full object-cover" onerror="this.onerror=null; this.style.display='none'; this.parentElement.innerHTML='<i data-lucide=\\'globe\\' class=\\'w-3 h-3 text-gray-400\\'></i>'; if(window.lucide) window.lucide.createIcons();">
                                        {% else %}
                                            <i data-lucide="globe" class="w-3 h-3 text-gray-400"></i>
                                        {% endif %}
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <div class="text-sm font-medium text-gray-900 dark:text-white truncate">{{ country.name }}</div>
                                        <div class="text-xs text-gray-500 dark:text-gray-400">{{ country.code }}</div>
                                    </div>
                                    {% if country_filter == country.name %}<i data-lucide="check" class="w-4 h-4 text-blue-500 flex-shrink-0"></i>{% endif %}
                                </button>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                <div id="custom_date_range" style="display: {% if date_filter == 'custom' %}block{% else %}none{% endif %};">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Custom Date Range</label>
                    <div class="grid grid-cols-2 gap-2">
                        <input type="date" name="start_date" value="{{ start_date }}" 
                               class="rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500"
                               placeholder="Start Date">
                        <input type="date" name="end_date" value="{{ end_date }}" 
                               class="rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-blue-500"
                               placeholder="End Date">
                    </div>
                </div>
            </div>
            <div class="flex gap-3">
                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-500">
                    <i class="fas fa-filter mr-2"></i>Apply Filter
                </button>
                <button type="button" onclick="window.location.reload()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 focus:ring-2 focus:ring-purple-500">
                    <i class="fas fa-sync-alt mr-2"></i>Refresh
                </button>
                <a href="{{ url_for('admin_orders') }}" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 focus:ring-2 focus:ring-gray-500 inline-flex items-center">
                    <i class="fas fa-times mr-2"></i>Clear
                </a>
                <a href="{{ url_for('admin_orders', date_filter=date_filter, start_date=start_date, end_date=end_date, country=country_filter or '', export='csv') }}" 
                   class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 focus:ring-2 focus:ring-green-500 inline-flex items-center">
                    <i class="fas fa-download mr-2"></i>Export CSV
                </a>
            </div>
        </form>
    </div>

    <!-- Totals Section -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <div class="text-sm font-medium text-gray-500 dark:text-gray-400">Total Sales</div>
            <div class="text-2xl font-bold text-gray-900 dark:text-white mt-2">D{{ "%.2f"|format(total_sales) }}</div>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <div class="text-sm font-medium text-gray-500 dark:text-gray-400">Total Orders</div>
            <div class="text-2xl font-bold text-gray-900 dark:text-white mt-2">{{ total_orders_count }}</div>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <div class="text-sm font-medium text-gray-500 dark:text-gray-400">Avg Order Value</div>
            <div class="text-2xl font-bold text-gray-900 dark:text-white mt-2">D{{ "%.2f"|format(avg_order_value) }}</div>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <div class="text-sm font-medium text-gray-500 dark:text-gray-400">Total Quantity</div>
            <div class="text-2xl font-bold text-gray-900 dark:text-white mt-2">{{ total_quantity }}</div>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <div class="text-sm font-medium text-gray-500 dark:text-gray-400">Unique Customers</div>
            <div class="text-2xl font-bold text-gray-900 dark:text-white mt-2">{{ unique_customers }}</div>
        </div>
    </div>

    <!-- Orders Table -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
            <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Orders List</h2>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-800">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                            Order ID
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                            Customer
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                            Country
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                            Date
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                            Total
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                            Status
                        </th>
                        <th scope="col" class="relative px-6 py-3">
                            <span class="sr-only">Actions</span>
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                    {% for order in orders.items %}
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">
                            #{{ order.id }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">
                            {{ order.customer.username if order.customer else 'N/A' }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            {% set order_country = order.customer.profile.country if (order.customer and order.customer.profile and order.customer.profile.country) else None %}
                            {% if order_country %}
                                {% set country_obj = countries|selectattr("name", "equalto", order_country)|first %}
                                <a href="{{ url_for('admin_orders', country=order_country, date_filter=date_filter, start_date=start_date, end_date=end_date) }}" 
                                   class="flex items-center gap-2 text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 transition-colors group">
                                    <div class="flex-shrink-0 w-6 h-6 rounded-full overflow-hidden border border-gray-200 dark:border-gray-700 flex items-center justify-center bg-gray-100 dark:bg-gray-700">
                                        {% if country_obj and (country_obj.flag_url or country_obj.flag_image_path or country_obj.code) %}
                                            <img src="{{ country_obj.get_flag_url() }}" alt="{{ order_country }}" class="w-full h-full object-cover" onerror="this.onerror=null; this.style.display='none'; this.parentElement.innerHTML='<i data-lucide=\\'globe\\' class=\\'w-3 h-3 text-gray-400\\'></i>'; if(window.lucide) window.lucide.createIcons();">
                                        {% else %}
                                            <i data-lucide="globe" class="w-3 h-3 text-gray-400"></i>
                                        {% endif %}
                                    </div>
                                    <span class="font-medium group-hover:underline">{{ order_country }}</span>
                                </a>
                            {% else %}
                                <span class="text-gray-400 dark:text-gray-500">N/A</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">
                            {{ order.created_at.strftime('%Y-%m-%d %H:%M') }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">
                            D{{ "%.2f"|format(order.total) }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                {% if order.status == 'completed' %}
                                    bg-green-100 text-green-800 dark:bg-green-800 dark:text-green-100
                                {% elif order.status == 'paid' %}
                                    bg-purple-100 text-purple-800 dark:bg-purple-800 dark:text-purple-100
                                {% else %}
                                    bg-yellow-100 text-yellow-800 dark:bg-yellow-800 dark:text-yellow-100
                                {% endif %}">
                                {{ order.status|title }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <a href="{{ url_for('admin_order_detail', order_id=order.id) }}" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300">
                                <i class="fas fa-eye"></i> View
                            </a>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="px-6 py-4 text-center text-sm text-gray-500 dark:text-gray-400">
                            {% if country_filter %}
                                No fully paid orders found for {{ country_filter }} in the selected date range.
                            {% else %}
                                No fully paid orders found for the selected date range.
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        {% if orders.pages > 1 %}
        <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-between items-center">
            <div class="text-sm text-gray-500 dark:text-gray-400">
                Showing page {{ orders.page }} of {{ orders.pages }} ({{ orders.total }} total orders)
            </div>
            <div class="flex space-x-2">
                {% if orders.has_prev %}
                <a href="{{ url_for('admin_orders', page=orders.prev_num, date_filter=date_filter, start_date=start_date, end_date=end_date, country=country_filter or '') }}" 
                   class="px-3 py-1 rounded-md border border-gray-300 text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:hover:bg-gray-600">
                    Previous
                </a>
                {% endif %}
                
                {% if orders.has_next %}
                <a href="{{ url_for('admin_orders', page=orders.next_num, date_filter=date_filter, start_date=start_date, end_date=end_date, country=country_filter or '') }}" 
                   class="px-3 py-1 rounded-md border border-gray-300 text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:hover:bg-gray-600">
                    Next
                </a>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
function toggleCustomDates() {
    const dateFilter = document.getElementById('date_filter').value;
    const customDateRange = document.getElementById('custom_date_range');
    if (dateFilter === 'custom') {
        customDateRange.style.display = 'block';
    } else {
        customDateRange.style.display = 'none';
    }
}

// Country filter dropdown functionality
(function() {
    const countryToggle = document.getElementById('country-filter-toggle');
    const countryDropdown = document.getElementById('country-filter-dropdown');
    const countrySearch = document.getElementById('country-filter-search');
    const countryList = document.getElementById('country-filter-list');
    const countryInput = document.getElementById('country-filter-input');
    const countryName = document.getElementById('country-filter-name');
    const countryFlag = document.getElementById('country-filter-flag');
    
    const selectedCountryName = '{{ country_filter or '' }}';
    const countries = {{ countries_dict|tojson }};
    
    // Initialize selected country display
    if (selectedCountryName && countryName && countryFlag) {
        const selectedCountry = countries.find(c => c.name === selectedCountryName);
        if (selectedCountry) {
            const flagUrl = selectedCountry.flag_url || 
                (selectedCountry.flag_image_path ? 
                    (selectedCountry.flag_image_path.startsWith('http') ? selectedCountry.flag_image_path : `/static/${selectedCountry.flag_image_path}`) :
                    (selectedCountry.code ? `https://flagcdn.com/w40/${selectedCountry.code.toLowerCase()}.png` : ''));
            
            if (flagUrl) {
                countryFlag.innerHTML = `<img src="${flagUrl}" alt="${selectedCountry.name}" class="w-full h-full object-cover" onerror="this.onerror=null; this.innerHTML='<i data-lucide=\\'globe\\' class=\\'w-3 h-3 text-gray-400\\'></i>'; if(window.lucide) window.lucide.createIcons();">`;
            }
            countryName.textContent = selectedCountry.name;
            countryName.classList.remove('text-gray-500', 'dark:text-gray-400');
            countryName.classList.add('text-gray-900', 'dark:text-white');
        }
    }
    
    // Toggle dropdown
    if (countryToggle && countryDropdown) {
        countryToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            const isHidden = countryDropdown.classList.contains('hidden');
            
            if (isHidden) {
                countryDropdown.classList.remove('hidden');
                countryToggle.setAttribute('aria-expanded', 'true');
                const chevron = countryToggle.querySelector('[data-lucide="chevron-down"]');
                if (chevron) {
                    chevron.style.transform = 'rotate(180deg)';
                }
                if (countrySearch) {
                    setTimeout(() => countrySearch.focus(), 100);
                }
            } else {
                countryDropdown.classList.add('hidden');
                countryToggle.setAttribute('aria-expanded', 'false');
                const chevron = countryToggle.querySelector('[data-lucide="chevron-down"]');
                if (chevron) {
                    chevron.style.transform = '';
                }
            }
        });
    }
    
    // Search functionality
    if (countrySearch && countryList) {
        countrySearch.addEventListener('input', (e) => {
            const filter = e.target.value.toLowerCase();
            const buttons = countryList.querySelectorAll('button[data-country-name]');
            buttons.forEach(btn => {
                const countryName = btn.dataset.countryName || '';
                const countryText = btn.textContent.toLowerCase();
                if (countryName.toLowerCase().includes(filter) || countryText.includes(filter)) {
                    btn.style.display = '';
                } else {
                    btn.style.display = 'none';
                }
            });
        });
    }
    
    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
        if (countryDropdown && countryToggle && 
            !countryDropdown.contains(e.target) && 
            !countryToggle.contains(e.target)) {
            countryDropdown.classList.add('hidden');
            countryToggle.setAttribute('aria-expanded', 'false');
            const chevron = countryToggle.querySelector('[data-lucide="chevron-down"]');
            if (chevron) {
                chevron.style.transform = '';
            }
        }
    });
    
    // Select country function (called from onclick)
    window.selectCountryFilter = function(countryName) {
        if (countryInput) {
            countryInput.value = countryName;
            const form = countryInput.closest('form');
            if (form) {
                form.submit();
            }
        }
    };
})();
</script>
{% endblock %}
