{% extends 'admin/admin/base.html' %}

{% block header %}{% if product %}Edit{% else %}Add New{% endif %} Product{% endblock %}

{% block content %}
<div class="py-6">
    <div class="max-w-3xl mx-auto">
        <div class="bg-white dark:bg-gray-800 shadow rounded-lg">
            <div class="px-6 py-5">
                <form method="POST" enctype="multipart/form-data" class="space-y-6">
                    {{ form.hidden_tag() }}
                    
                    <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                        <!-- Product Name -->
                        <div class="sm:col-span-2">
                            {{ form.name.label(class="block text-sm font-medium text-gray-700 dark:text-gray-300") }}
                            {{ form.name(class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white sm:text-sm") }}
                            {% if form.name.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ form.name.errors[0] }}</p>
                            {% endif %}
                        </div>

                        <!-- Category -->
                        <div>
                            {{ form.category_id.label(class="block text-sm font-medium text-gray-700 dark:text-gray-300") }}
                            {{ form.category_id(class="mt-1 block w-full rounded-md border-gray-300 py-2 pl-3 pr-10 text-base focus:border-blue-500 focus:outline-none focus:ring-blue-500 sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white") }}
                            {% if form.category_id.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ form.category_id.errors[0] }}</p>
                            {% endif %}
                        </div>

                        <!-- Price -->
                        <div>
                            {{ form.price.label(class="block text-sm font-medium text-gray-700 dark:text-gray-300") }}
                            <div class="mt-1 relative rounded-md shadow-sm">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <span class="text-gray-500 sm:text-sm">D</span>
                                </div>
                                {{ form.price(class="focus:ring-blue-500 focus:border-blue-500 block w-full pl-7 pr-12 sm:text-sm border-gray-300 rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white", placeholder="0.00", step="0.01", id="product-price") }}
                            </div>
                            {% if form.price.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ form.price.errors[0] }}</p>
                            {% endif %}
                        </div>

                        <!-- Delivery Price -->
                        <div>
                            {{ form.delivery_price.label(class="block text-sm font-medium text-gray-700 dark:text-gray-300") }}
                            <div class="mt-1 relative rounded-md shadow-sm">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <span class="text-gray-500 sm:text-sm">D</span>
                                </div>
                                {{ form.delivery_price(class="focus:ring-blue-500 focus:border-blue-500 block w-full pl-7 pr-12 sm:text-sm border-gray-300 rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white", placeholder="0.00", step="0.01", id="delivery-price") }}
                            </div>
                            {% if form.delivery_price.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ form.delivery_price.errors[0] }}</p>
                            {% endif %}
                            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                                Delivery fee shown to customers. Default: 0.00
                            </p>
                        </div>

                        <!-- Shipping Price -->
                        <div>
                            {{ form.shipping_price.label(class="block text-sm font-medium text-gray-700 dark:text-gray-300") }}
                            <div class="mt-1 relative rounded-md shadow-sm">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <span class="text-gray-500 sm:text-sm">D</span>
                                </div>
                                {{ form.shipping_price(class="focus:ring-blue-500 focus:border-blue-500 block w-full pl-7 pr-12 sm:text-sm border-gray-300 rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white", placeholder="0.00", step="0.01", id="shipping-price") }}
                            </div>
                            {% if form.shipping_price.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ form.shipping_price.errors[0] }}</p>
                            {% endif %}
                            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                                Actual shipping cost. Default: 0.00
                            </p>
                        </div>

                        <!-- Location -->
                        <div class="sm:col-span-2">
                            {{ form.location.label(class="block text-sm font-medium text-gray-700 dark:text-gray-300") }}
                            {{ form.location(class="mt-1 block w-full rounded-md border-gray-300 py-2 pl-3 pr-10 text-base focus:border-blue-500 focus:outline-none focus:ring-blue-500 sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white") }}
                            {% if form.location.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ form.location.errors[0] }}</p>
                            {% endif %}
                        </div>

                        <!-- Stock -->
                        <div>
                            {{ form.stock.label(class="block text-sm font-medium text-gray-700 dark:text-gray-300") }}
                            {{ form.stock(class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white sm:text-sm") }}
                            {% if form.stock.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ form.stock.errors[0] }}</p>
                            {% endif %}
                        </div>

                        <!-- Image Upload -->
                        <div class="sm:col-span-2">
                            {{ form.image.label(class="block text-sm font-medium text-gray-700 dark:text-gray-300") }}
                            <div class="mt-1 flex items-center">
                                <span class="inline-block h-12 w-12 overflow-hidden rounded-full bg-gray-100 dark:bg-gray-700">
                                    {% if product and product.image %}
                                        <img src="{{ product.image|product_image_url }}" alt="{{ product.name }}" class="h-full w-full text-gray-300 object-cover">
                                    {% else %}
                                        <svg class="h-full w-full text-gray-300" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M24 20.993V24H0v-2.996A14.977 14.977 0 0112.004 15c4.904 0 9.26 2.354 11.996 5.993zM16.002 8.999a4 4 0 11-8 0 4 4 0 018 0z" />
                                        </svg>
                                    {% endif %}
                                </span>
                                <label for="{{ form.image.id }}" class="ml-5 rounded-md border border-gray-300 bg-white dark:bg-gray-700 dark:border-gray-600 py-2 px-3 text-sm font-medium leading-4 text-gray-700 dark:text-gray-300 shadow-sm hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 cursor-pointer">
                                    <span>Change</span>
                                    {{ form.image(class="sr-only", accept="image/*") }}
                                </label>
                            </div>
                            {% if form.image.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ form.image.errors[0] }}</p>
                            {% endif %}
                        </div>

                        <!-- Description -->
                        <div class="sm:col-span-2">
                            {{ form.description.label(class="block text-sm font-medium text-gray-700 dark:text-gray-300") }}
                            <div class="mt-1">
                                {{ form.description(rows=4, class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white sm:text-sm") }}
                            </div>
                            {% if form.description.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ form.description.errors[0] }}</p>
                            {% endif %}
                        </div>
                        
                        <!-- Available in Gambia -->
                        <div class="sm:col-span-2">
                            <div class="flex items-center">
                                {{ form.available_in_gambia(class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded") }}
                                {{ form.available_in_gambia.label(class="ml-2 block text-sm font-medium text-gray-700 dark:text-gray-300") }}
                            </div>
                            {% if form.available_in_gambia.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ form.available_in_gambia.errors[0] }}</p>
                            {% endif %}
                            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                                Check this to mark the product as available in Gambia. A flag icon will appear on the product listing.
                            </p>
                        </div>
                    </div>

                    <!-- Delivery Fee Configuration Section -->
                    {% if product %}
                    <div class="mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Delivery Fee Configuration</h3>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">
                            Configure price-based delivery fees. The system will use the first matching rule based on product price.
                        </p>
                        
                        <div class="overflow-hidden shadow ring-1 ring-black ring-opacity-5 rounded-lg">
                            <table class="min-w-full divide-y divide-gray-300 dark:divide-gray-700" id="delivery-rules-table">
                                <thead class="bg-gray-50 dark:bg-gray-800">
                                    <tr>
                                        <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 dark:text-white sm:pl-6">Min Price (D)</th>
                                        <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900 dark:text-white">Max Price (D)</th>
                                        <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900 dark:text-white">Delivery Fee (D)</th>
                                        <th scope="col" class="relative py-3.5 pl-3 pr-4 sm:pr-6">
                                            <span class="sr-only">Actions</span>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200 dark:divide-gray-700 bg-white dark:bg-gray-900" id="delivery-rules-tbody">
                                    {% if product.delivery_rules %}
                                        {% for rule in product.delivery_rules %}
                                        <tr data-rule-id="{{ rule.id }}">
                                            <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm sm:pl-6">
                                                <input type="number" name="delivery_rules[{{ rule.id }}][min_amount]" 
                                                       value="{{ rule.min_amount }}" 
                                                       step="0.01" min="0" required
                                                       class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white sm:text-sm">
                                            </td>
                                            <td class="whitespace-nowrap px-3 py-4 text-sm">
                                                <input type="number" name="delivery_rules[{{ rule.id }}][max_amount]" 
                                                       value="{{ rule.max_amount if rule.max_amount else '' }}" 
                                                       step="0.01" min="0"
                                                       placeholder="No limit"
                                                       class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white sm:text-sm">
                                            </td>
                                            <td class="whitespace-nowrap px-3 py-4 text-sm">
                                                <input type="number" name="delivery_rules[{{ rule.id }}][fee]" 
                                                       value="{{ rule.fee }}" 
                                                       step="0.01" min="0" required
                                                       class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white sm:text-sm">
                                            </td>
                                            <td class="relative whitespace-nowrap py-4 pl-3 pr-4 text-right text-sm font-medium sm:pr-6">
                                                <button type="button" 
                                                        onclick="removeDeliveryRule({{ rule.id }})"
                                                        class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">
                                                    Remove
                                                </button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-4">
                            <button type="button" 
                                    onclick="addDeliveryRule()"
                                    class="inline-flex items-center rounded-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 shadow-sm hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                                <svg class="-ml-0.5 mr-1.5 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                </svg>
                                Add Rule
                            </button>
                        </div>
                        
                        <div id="delivery-rules-to-delete" style="display: none;"></div>
                    </div>
                    {% endif %}

                    <div class="flex justify-end space-x-3 pt-6">
                        <a href="{{ url_for('admin_products') }}" class="rounded-md border border-gray-300 bg-white dark:bg-gray-700 dark:border-gray-600 py-2 px-4 text-sm font-medium text-gray-700 dark:text-gray-300 shadow-sm hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                            Cancel
                        </a>
                        {{ form.submit(class="inline-flex justify-center rounded-md border border-transparent bg-blue-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2") }}
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.getElementById('{{ form.image.id }}').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.querySelector('.inline-block.h-12.w-12.overflow-hidden.rounded-full img');
                if (preview) {
                    preview.src = e.target.result;
                } else {
                    const svg = document.querySelector('.inline-block.h-12.w-12.overflow-hidden.rounded-full svg');
                    if (svg) {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'h-full w-full text-gray-300 object-cover';
                        svg.parentNode.replaceChild(img, svg);
                    }
                }
            };
            reader.readAsDataURL(file);
        }
    });

    // Delivery Rules Management
    let ruleCounter = 0;
    const rulesToDelete = new Set();

    function addDeliveryRule() {
        const tbody = document.getElementById('delivery-rules-tbody');
        const row = document.createElement('tr');
        row.setAttribute('data-rule-id', 'new-' + ruleCounter);
        
        row.innerHTML = `
            <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm sm:pl-6">
                <input type="number" name="delivery_rules[new-${ruleCounter}][min_amount]" 
                       value="0" 
                       step="0.01" min="0" required
                       class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white sm:text-sm">
            </td>
            <td class="whitespace-nowrap px-3 py-4 text-sm">
                <input type="number" name="delivery_rules[new-${ruleCounter}][max_amount]" 
                       value="" 
                       step="0.01" min="0"
                       placeholder="No limit"
                       class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white sm:text-sm">
            </td>
            <td class="whitespace-nowrap px-3 py-4 text-sm">
                <input type="number" name="delivery_rules[new-${ruleCounter}][fee]" 
                       value="0" 
                       step="0.01" min="0" required
                       class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white sm:text-sm">
            </td>
            <td class="relative whitespace-nowrap py-4 pl-3 pr-4 text-right text-sm font-medium sm:pr-6">
                <button type="button" 
                        onclick="removeDeliveryRule('new-${ruleCounter}')"
                        class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">
                    Remove
                </button>
            </td>
        `;
        
        tbody.appendChild(row);
        ruleCounter++;
    }

    function removeDeliveryRule(ruleId) {
        const row = document.querySelector(`tr[data-rule-id="${ruleId}"]`);
        if (row) {
            // If it's an existing rule (not new), mark it for deletion
            if (typeof ruleId === 'number' || (typeof ruleId === 'string' && !ruleId.startsWith('new-'))) {
                rulesToDelete.add(ruleId);
                // Add hidden input to mark for deletion
                const deleteInput = document.createElement('input');
                deleteInput.type = 'hidden';
                deleteInput.name = 'delivery_rules_to_delete[]';
                deleteInput.value = ruleId;
                document.getElementById('delivery-rules-to-delete').appendChild(deleteInput);
            }
            row.remove();
        }
    }

    // Form validation for delivery rules
    document.querySelector('form').addEventListener('submit', function(e) {
        const tbody = document.getElementById('delivery-rules-tbody');
        if (tbody) {
            const rows = tbody.querySelectorAll('tr');
            for (let row of rows) {
                const minInput = row.querySelector('input[name*="[min_amount]"]');
                const maxInput = row.querySelector('input[name*="[max_amount]"]');
                
                if (minInput && maxInput && maxInput.value) {
                    const min = parseFloat(minInput.value);
                    const max = parseFloat(maxInput.value);
                    
                    if (min >= max) {
                        e.preventDefault();
                        alert('Minimum price must be less than maximum price.');
                        minInput.focus();
                        return false;
                    }
                }
            }
        }
    });
</script>
{% endblock %}
