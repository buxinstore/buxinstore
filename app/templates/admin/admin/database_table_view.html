{% extends "admin/admin/base.html" %}

{% block header %}
ðŸ“Š Table: {{ table_name }}
{% endblock %}

{% block content %}
<div class="space-y-4">
    <!-- Actions Bar -->
    <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-4">
        <div class="flex flex-wrap items-center justify-between gap-4">
            <div class="flex items-center gap-2">
                <a href="{{ url_for('admin_database_manager') }}" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">
                    <i class="fas fa-arrow-left mr-2"></i> Back
                </a>
                <a href="{{ url_for('admin_database_add_row', table_name=table_name) }}" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                    <i class="fas fa-plus mr-2"></i> Add New Row
                </a>
                <button onclick="deleteSelected()" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700" id="deleteSelectedBtn" style="display: none;">
                    <i class="fas fa-trash mr-2"></i> Delete Selected
                </button>
                <button onclick="clearTable()" class="px-4 py-2 bg-orange-600 text-white rounded hover:bg-orange-700">
                    <i class="fas fa-eraser mr-2"></i> Clear Table
                </button>
            </div>
            <a href="{{ url_for('admin_database_export_csv', table_name=table_name) }}" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                <i class="fas fa-file-csv mr-2"></i> Export CSV
            </a>
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-4">
        <form method="GET" action="{{ url_for('admin_database_table_view', table_name=table_name) }}" class="flex flex-wrap items-center gap-4">
            <div class="flex-1 min-w-[200px]">
                <input type="text" name="search" value="{{ search }}" placeholder="Search..." class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
            </div>
            <div>
                <select name="sort" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                    <option value="">Sort by...</option>
                    {% for col in columns %}
                    <option value="{{ col }}" {% if sort_column == col %}selected{% endif %}>{{ col }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <select name="order" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                    <option value="asc" {% if sort_order == 'asc' %}selected{% endif %}>Ascending</option>
                    <option value="desc" {% if sort_order == 'desc' %}selected{% endif %}>Descending</option>
                </select>
            </div>
            <div>
                <select name="per_page" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                    <option value="25" {% if per_page == 25 %}selected{% endif %}>25 per page</option>
                    <option value="50" {% if per_page == 50 %}selected{% endif %}>50 per page</option>
                    <option value="100" {% if per_page == 100 %}selected{% endif %}>100 per page</option>
                </select>
            </div>
            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                <i class="fas fa-search mr-2"></i> Search
            </button>
            {% if search %}
            <a href="{{ url_for('admin_database_table_view', table_name=table_name) }}" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">
                Clear
            </a>
            {% endif %}
        </form>
    </div>

    <!-- Table Data -->
    <div class="bg-white dark:bg-gray-800 shadow rounded-lg overflow-hidden">
        {% if data %}
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-700">
                    <tr>
                        <th class="px-4 py-3 text-left">
                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                        </th>
                        {% for col in columns %}
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                            {{ col }}
                        </th>
                        {% endfor %}
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                    {% for row in data %}
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                        <td class="px-4 py-4 whitespace-nowrap">
                            <input type="checkbox" class="row-checkbox" value="{% if primary_keys %}{{ row[primary_keys[0]] }}{% endif %}" onchange="updateDeleteButton()">
                        </td>
                        {% for col in columns %}
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">
                            {% if row[col] is none or row[col] == 'NULL' %}
                                <span class="text-gray-400 italic">NULL</span>
                            {% else %}
                                {% set value_str = row[col]|string %}
                                {% if value_str|length > 50 %}
                                    <span title="{{ row[col] }}">{{ value_str[:50] }}...</span>
                                {% else %}
                                    {{ row[col] }}
                                {% endif %}
                            {% endif %}
                        </td>
                        {% endfor %}
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            {% if primary_keys %}
                            <a href="{{ url_for('admin_database_edit_row', table_name=table_name, id=row[primary_keys[0]]) }}" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 mr-3">
                                <i class="fas fa-edit"></i> Edit
                            </a>
                            <button onclick="deleteRow({{ row[primary_keys[0]] }})" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if total > per_page %}
        <div class="bg-white dark:bg-gray-800 px-4 py-3 border-t border-gray-200 dark:border-gray-700 sm:px-6">
            <div class="flex items-center justify-between">
                <div class="text-sm text-gray-700 dark:text-gray-300">
                    Showing {{ ((page - 1) * per_page) + 1 }} to {{ [page * per_page, total]|min }} of {{ total }} results
                </div>
                <div class="flex gap-2">
                    {% if page > 1 %}
                    <a href="{{ url_for('admin_database_table_view', table_name=table_name, page=page-1, search=search, sort=sort_column, order=sort_order, per_page=per_page) }}" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600">
                        Previous
                    </a>
                    {% endif %}
                    {% if page * per_page < total %}
                    <a href="{{ url_for('admin_database_table_view', table_name=table_name, page=page+1, search=search, sort=sort_column, order=sort_order, per_page=per_page) }}" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600">
                        Next
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
        {% else %}
        <div class="p-8 text-center text-gray-500 dark:text-gray-400">
            <i class="fas fa-inbox text-4xl mb-4"></i>
            <p>No data found in this table.</p>
            <a href="{{ url_for('admin_database_add_row', table_name=table_name) }}" class="mt-4 inline-block px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                <i class="fas fa-plus mr-2"></i> Add First Row
            </a>
        </div>
        {% endif %}
    </div>
</div>

<script>
function deleteRow(rowId) {
    if (!confirm('Are you sure you want to delete this row?')) return;
    
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    fetch('{{ url_for("admin_database_delete_row", table_name=table_name) }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ id: rowId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        alert('Error deleting row: ' + error);
    });
}

function deleteSelected() {
    const checkboxes = document.querySelectorAll('.row-checkbox:checked');
    const ids = Array.from(checkboxes).map(cb => cb.value);
    
    if (ids.length === 0) {
        alert('Please select at least one row to delete.');
        return;
    }
    
    if (!confirm(`Are you sure you want to delete ${ids.length} row(s)?`)) return;
    
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    fetch('{{ url_for("admin_database_delete_multiple", table_name=table_name) }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ ids: ids })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        alert('Error deleting rows: ' + error);
    });
}

function clearTable() {
    if (!confirm('âš ï¸ WARNING: This will delete ALL rows from this table! Are you absolutely sure?')) return;
    if (!confirm('This action cannot be undone. Are you really sure?')) return;
    
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    fetch('{{ url_for("admin_database_clear_table", table_name=table_name) }}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        alert('Error clearing table: ' + error);
    });
}

function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.row-checkbox');
    checkboxes.forEach(cb => cb.checked = selectAll.checked);
    updateDeleteButton();
}

function updateDeleteButton() {
    const checkboxes = document.querySelectorAll('.row-checkbox:checked');
    const btn = document.getElementById('deleteSelectedBtn');
    if (checkboxes.length > 0) {
        btn.style.display = 'inline-block';
    } else {
        btn.style.display = 'none';
    }
}
</script>
{% endblock %}

