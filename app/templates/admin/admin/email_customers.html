{% extends "admin/admin/base.html" %}

{% block title %}Email Customers{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto py-8 px-4">
	<h1 class="text-2xl font-semibold mb-6">Email Customers</h1>

	<div id="alert-container" class="mb-4"></div>

	<form method="post" id="email-customers-form" class="space-y-4">
		<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
		<div>
			<label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Subject</label>
			<input name="subject" type="text" required
			       class="mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm dark:bg-gray-700 dark:text-white" 
			       placeholder="Enter email subject">
		</div>
		<div>
			<label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Message</label>
			<textarea name="body" rows="8" required
			          class="mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm dark:bg-gray-700 dark:text-white" 
			          placeholder="Write your message to customers"></textarea>
		</div>
		<div class="flex items-center gap-3 p-3 border rounded dark:border-gray-600">
			<input id="test_only" name="test_only" type="checkbox" class="h-4 w-4">
			<label for="test_only" class="text-sm text-gray-700 dark:text-gray-300">Send test only</label>
			<input name="test_email" type="email" 
			       class="ml-3 flex-1 border-gray-300 dark:border-gray-600 rounded-md shadow-sm dark:bg-gray-700 dark:text-white" 
			       placeholder="test@example.com">
		</div>
		<div class="flex items-center gap-3">
			<button type="submit" id="submit-btn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
				<span id="submit-text">Send</span>
				<span id="submit-loading" class="hidden">
					<i class="fas fa-spinner fa-spin mr-2"></i> Sending...
				</span>
			</button>
			<div id="status-message" class="text-sm text-gray-600 dark:text-gray-400"></div>
		</div>
	</form>
	<p class="mt-4 text-xs text-gray-500 dark:text-gray-400">Note: Emails are sent individually to non-admin users to protect privacy.</p>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
	const form = document.getElementById('email-customers-form');
	const alertContainer = document.getElementById('alert-container');
	const submitBtn = document.getElementById('submit-btn');
	const submitText = document.getElementById('submit-text');
	const submitLoading = document.getElementById('submit-loading');
	const statusMessage = document.getElementById('status-message');
	
	function showAlert(message, type = 'error') {
		const alert = document.createElement('div');
		alert.className = `p-3 rounded border ${
			type === 'success' ? 'bg-green-50 text-green-800 border-green-200' : 
			type === 'warning' ? 'bg-yellow-50 text-yellow-800 border-yellow-200' :
			'bg-red-50 text-red-800 border-red-200'
		}`;
		alert.textContent = message;
		alertContainer.innerHTML = '';
		alertContainer.appendChild(alert);
		setTimeout(() => alert.remove(), 5000);
	}
	
	form.addEventListener('submit', function(e) {
		e.preventDefault();
		
		const formData = new FormData(form);
		const testOnly = formData.get('test_only') === 'on';
		const testEmail = formData.get('test_email');
		
		if (testOnly && !testEmail) {
			showAlert('Please enter a test email address', 'error');
			return;
		}
		
		submitBtn.disabled = true;
		submitText.classList.add('hidden');
		submitLoading.classList.remove('hidden');
		statusMessage.textContent = '';
		
		fetch('{{ url_for("admin_email_customers") }}', {
			method: 'POST',
			body: formData
		})
		.then(response => response.json())
		.then(data => {
			if (data.success) {
				if (data.status === 'queued') {
					showAlert(`Email job queued! ${data.recipients || 1} recipient(s) will receive the email.`, 'success');
					if (data.job_id) {
						statusMessage.textContent = `Job ID: ${data.job_id}`;
						// Optionally poll for status
						pollJobStatus(data.job_id);
					}
				} else {
					showAlert('Email sent successfully!', 'success');
				}
				form.reset();
			} else {
				showAlert(data.message || 'Failed to send email', 'error');
			}
		})
		.catch(error => {
			console.error('Error:', error);
			showAlert('An error occurred. Please try again.', 'error');
		})
		.finally(() => {
			submitBtn.disabled = false;
			submitText.classList.remove('hidden');
			submitLoading.classList.add('hidden');
		});
	});
	
	function pollJobStatus(jobId) {
		const maxAttempts = 30;
		let attempts = 0;
		
		const poll = setInterval(() => {
			attempts++;
			fetch(`/admin/email/status/${jobId}`)
				.then(response => response.json())
				.then(data => {
					if (data.success && data.status === 'completed') {
						clearInterval(poll);
						statusMessage.textContent = `Completed: ${data.sent} sent, ${data.failed} failed`;
					} else if (data.success && data.status === 'failed') {
						clearInterval(poll);
						statusMessage.textContent = 'Job failed';
					} else if (attempts >= maxAttempts) {
						clearInterval(poll);
						statusMessage.textContent = 'Status check timeout';
					}
				})
				.catch(() => {
					if (attempts >= maxAttempts) {
						clearInterval(poll);
					}
				});
		}, 2000);
	}
});
</script>
{% endblock %}
