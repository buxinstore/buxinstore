{% extends 'admin/admin/base.html' %}

{% block header %}Products{% endblock %}

{% block content %}
<style>
    /* Gambia Toggle Switch Styles */
    .gambia-toggle-switch {
        position: relative;
        display: inline-block;
        width: 44px;
        height: 24px;
    }

    .gambia-toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .gambia-toggle-switch .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 24px;
    }

    .gambia-toggle-switch .slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .gambia-toggle-switch input:checked + .slider {
        background-color: #22c55e; /* Green */
    }

    .gambia-toggle-switch input:checked + .slider:before {
        transform: translateX(20px);
    }

    .gambia-toggle-switch input:disabled + .slider {
        opacity: 0.6;
        cursor: not-allowed;
    }

    /* Dark mode support */
    .dark .gambia-toggle-switch .slider {
        background-color: #4b5563;
    }

    .dark .gambia-toggle-switch input:checked + .slider {
        background-color: #16a34a; /* Darker green for dark mode */
    }

    /* Bulk Edit Styles - Subtle, matches existing design */
    .bulk-edit-field {
        transition: all 0.2s ease;
    }
    
    .bulk-edit-field:not(:focus):not(.edited) {
        border-color: transparent !important;
        background-color: transparent !important;
    }
    
    .bulk-edit-field.edited {
        background-color: #fef3c7 !important; /* Light yellow */
        border-color: #f59e0b !important;
    }

    .dark .bulk-edit-field.edited {
        background-color: #78350f !important; /* Dark yellow */
        border-color: #f59e0b !important;
    }

    .bulk-edit-row.has-changes {
        background-color: #fffbeb !important;
    }

    .dark .bulk-edit-row.has-changes {
        background-color: #451a03 !important;
    }
    
    /* Make inputs look like text when not focused */
    .bulk-edit-field.product-name-input {
        font-weight: 500;
    }
    
    .bulk-edit-field.category-select {
        appearance: none;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 0.25rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
        padding-right: 2rem;
    }
</style>
<div class="py-4">
    <div class="flex flex-col">
        <div class="-my-2 overflow-x-auto sm:-mx-6 lg:-mx-8">
            <div class="py-2 align-middle inline-block min-w-full sm:px-6 lg:px-8">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex-1 max-w-lg">
                        <div class="relative rounded-md shadow-sm">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-search text-gray-400"></i>
                            </div>
                            <input type="text" id="search" name="search" 
                                class="focus:ring-blue-500 focus:border-blue-500 block w-full pl-10 sm:text-sm border-gray-300 rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white" 
                                placeholder="Search products..."
                                hx-get="{{ url_for('admin_search_products') }}"
                                hx-trigger="keyup changed delay:500ms"
                                hx-target="#products-table"
                                hx-indicator=".htmx-indicator">
                        </div>
                    </div>
                    <div class="ml-4 flex space-x-2">
                        <button id="save-all-changes-btn" 
                                class="hidden inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fas fa-save mr-2"></i> Save All Changes
                        </button>
                        <a href="{{ url_for('admin_bulk_upload') }}" 
                           class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md shadow-sm text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:hover:bg-gray-600">
                            <i class="fas fa-upload mr-2"></i> Bulk Upload
                        </a>
                        <a href="{{ url_for('admin_add_product') }}" 
                           class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            <i class="fas fa-plus mr-2"></i> Add Product
                        </a>
                    </div>
                </div>

                <div class="shadow overflow-hidden border-b border-gray-200 dark:border-gray-700 sm:rounded-lg">
                    <div class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-gray-50 dark:bg-gray-800">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                        Product
                                    </th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                        Category
                                    </th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                        Price
                                    </th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                        Stock
                                    </th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                        Status
                                    </th>
                                    <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                        Gambia
                                    </th>
                                    <th scope="col" class="relative px-6 py-3">
                                        <span class="sr-only">Actions</span>
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="products-table" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                {% include 'admin/admin/partials/_products_table.html' %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Pagination -->
                {% if products.pages > 1 %}
                <div class="bg-white dark:bg-gray-800 px-4 py-3 flex items-center justify-between border-t border-gray-200 dark:border-gray-700 sm:px-6">
                    <div class="flex-1 flex justify-between sm:hidden">
                        {% if products.has_prev %}
                        <a href="{{ url_for('admin_products', page=products.prev_num) }}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 dark:bg-gray-700 dark:text-gray-200">
                            Previous
                        </a>
                        {% endif %}
                        {% if products.has_next %}
                        <a href="{{ url_for('admin_products', page=products.next_num) }}" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 dark:bg-gray-700 dark:text-gray-200">
                            Next
                        </a>
                        {% endif %}
                    </div>
                    <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                        <div>
                            <p class="text-sm text-gray-700 dark:text-gray-300">
                                Showing <span class="font-medium">{{ products.first }}</span> to <span class="font-medium">{{ products.last }}</span> of <span class="font-medium">{{ products.total }}</span> results
                            </p>
                        </div>
                        <div>
                            <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                                {% if products.has_prev %}
                                <a href="{{ url_for('admin_products', page=products.prev_num) }}" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 dark:bg-gray-700 dark:text-gray-300">
                                    <span class="sr-only">Previous</span>
                                    <i class="fas fa-chevron-left h-5 w-5"></i>
                                </a>
                                {% endif %}

                                {% for page_num in products.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
                                    {% if page_num %}
                                        {% if page_num != products.page %}
                                            <a href="{{ url_for('admin_products', page=page_num) }}" class="bg-white border-gray-300 text-gray-500 hover:bg-gray-50 relative inline-flex items-center px-4 py-2 border text-sm font-medium dark:bg-gray-700 dark:text-gray-300">
                                                {{ page_num }}
                                            </a>
                                        {% else %}
                                            <span class="z-10 bg-blue-50 border-blue-500 text-blue-600 relative inline-flex items-center px-4 py-2 border text-sm font-medium dark:bg-blue-900 dark:text-blue-100 dark:border-blue-700">
                                                {{ page_num }}
                                            </span>
                                        {% endif %}
                                    {% else %}
                                        <span class="border-transparent text-gray-500 border-t-2 border-b-2 hover:border-gray-300 bg-white px-4 py-2 text-sm font-medium dark:bg-gray-700 dark:text-gray-400">
                                            ...
                                        </span>
                                    {% endif %}
                                {% endfor %}

                                {% if products.has_next %}
                                <a href="{{ url_for('admin_products', page=products.next_num) }}" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 dark:bg-gray-700 dark:text-gray-300">
                                    <span class="sr-only">Next</span>
                                    <i class="fas fa-chevron-right h-5 w-5"></i>
                                </a>
                                {% endif %}
                            </nav>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Delete Product Modal -->
<div id="delete-modal" class="hidden fixed z-10 inset-0 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                        <i class="fas fa-exclamation text-red-600"></i>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white" id="modal-title">
                            Delete Product
                        </h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500 dark:text-gray-300">
                                Are you sure you want to delete this product? This action cannot be undone.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <form id="delete-form" method="POST" action="">
                    <input type="hidden" name="_method" value="DELETE">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm">
                        Delete
                    </button>
                </form>
                <button type="button" onclick="closeModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm dark:bg-gray-600 dark:text-white dark:border-gray-500">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // Delete product modal
    function confirmDelete(productId, productName) {
        const modal = document.getElementById('delete-modal');
        const form = document.getElementById('delete-form');
        form.action = `/admin/products/${productId}/delete`;
        document.getElementById('modal-title').textContent = `Delete ${productName}?`;
        modal.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
    }

    function closeModal() {
        const modal = document.getElementById('delete-modal');
        modal.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('delete-modal');
        if (event.target === modal) {
            closeModal();
        }
    }

    // Get CSRF token from meta tag
    function getCSRFToken() {
        const metaTag = document.querySelector('meta[name="csrf-token"]');
        return metaTag ? metaTag.getAttribute('content') : '';
    }

    // Bulk Edit Functionality
    document.addEventListener('DOMContentLoaded', function() {
        const saveBtn = document.getElementById('save-all-changes-btn');
        const changedProducts = new Map(); // productId -> {field: value}

        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-md shadow-lg ${
                type === 'success' ? 'bg-green-500' : 'bg-red-500'
            } text-white`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Check if field value has changed
        function hasChanged(field) {
            const original = field.dataset.original;
            let current = field.value;
            
            // Handle checkbox
            if (field.type === 'checkbox') {
                current = field.checked ? 'true' : 'false';
            }
            
            // Handle number fields - compare as numbers
            if (field.type === 'number') {
                const origNum = parseFloat(original) || 0;
                const currNum = parseFloat(current) || 0;
                return origNum !== currNum;
            }
            
            return original !== current;
        }

        // Mark field as edited
        function markFieldAsEdited(field, isEdited) {
            if (isEdited) {
                field.classList.add('edited');
            } else {
                field.classList.remove('edited');
            }
        }

        // Update row highlight
        function updateRowHighlight(productId) {
            const row = document.querySelector(`tr[data-product-id="${productId}"]`);
            if (!row) return;
            
            const fields = row.querySelectorAll('.bulk-edit-field');
            let hasChanges = false;
            
            fields.forEach(field => {
                if (hasChanged(field)) {
                    hasChanges = true;
                    markFieldAsEdited(field, true);
                } else {
                    markFieldAsEdited(field, false);
                }
            });
            
            if (hasChanges) {
                row.classList.add('has-changes');
            } else {
                row.classList.remove('has-changes');
                changedProducts.delete(productId);
            }
        }

        // Update save button visibility
        function updateSaveButton() {
            if (changedProducts.size > 0) {
                saveBtn.classList.remove('hidden');
            } else {
                saveBtn.classList.add('hidden');
            }
        }

        // Track changes for a field
        function trackChange(field) {
            const productId = parseInt(field.dataset.productId);
            const fieldName = field.dataset.field;
            
            if (!hasChanged(field)) {
                // Field reverted to original
                if (changedProducts.has(productId)) {
                    const productChanges = changedProducts.get(productId);
                    delete productChanges[fieldName];
                    if (Object.keys(productChanges).length === 0) {
                        changedProducts.delete(productId);
                    }
                }
            } else {
                // Field has changed
                if (!changedProducts.has(productId)) {
                    changedProducts.set(productId, {});
                }
                const productChanges = changedProducts.get(productId);
                
                let value = field.value;
                if (field.type === 'checkbox') {
                    value = field.checked;
                } else if (field.type === 'number') {
                    value = parseFloat(value) || 0;
                }
                
                productChanges[fieldName] = value;
            }
            
            updateRowHighlight(productId);
            updateSaveButton();
        }

        // Image URL change handler - update preview
        function handleImageUrlChange(field) {
            const productId = field.dataset.productId;
            const imageUrl = field.value.trim();
            const productThumbnail = document.querySelector(`.product-thumbnail[data-product-id="${productId}"]`);
            
            // Validate URL and update thumbnail
            if (imageUrl && (imageUrl.startsWith('http://') || imageUrl.startsWith('https://'))) {
                if (productThumbnail) {
                    productThumbnail.src = imageUrl;
                    productThumbnail.onerror = function() {
                        this.src = '/static/img/placeholder.png';
                    };
                }
            } else if (!imageUrl) {
                if (productThumbnail) productThumbnail.src = '/static/img/placeholder.png';
            }
            
            trackChange(field);
        }

        // Stock change handler - update status badge
        function handleStockChange(field) {
            trackChange(field);
            // Status badge will update on page reload, or we could update it dynamically here
        }

        // Setup bulk edit handlers
        function setupBulkEditHandlers() {
            // Handle all editable fields
            document.querySelectorAll('.bulk-edit-field').forEach(function(field) {
                // Remove existing listeners
                const newField = field.cloneNode(true);
                field.parentNode.replaceChild(newField, field);
                
                if (newField.classList.contains('image-url-input')) {
                    newField.addEventListener('input', function() {
                        handleImageUrlChange(this);
                    });
                } else if (newField.classList.contains('stock-input')) {
                    newField.addEventListener('input', function() {
                        handleStockChange(this);
                    });
                } else if (newField.type === 'checkbox') {
                    newField.addEventListener('change', function() {
                        trackChange(this);
                    });
                } else {
                    newField.addEventListener('input', function() {
                        trackChange(this);
                    });
                }
            });
        }

        // Bulk save function
        function saveAllChanges() {
            if (changedProducts.size === 0) {
                showToast('No changes to save', 'error');
                return;
            }

            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Saving...';

            const updates = [];
            changedProducts.forEach((changes, productId) => {
                updates.push({
                    product_id: parseInt(productId),
                    ...changes
                });
            });

            fetch('/admin/products/bulk-update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({ updates: updates })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showToast(`Successfully updated ${data.updated_count || updates.length} product(s)`, 'success');
                    changedProducts.clear();
                    updateSaveButton();
                    
                    // Reset all fields to their new values
                    updates.forEach(update => {
                        const row = document.querySelector(`tr[data-product-id="${update.product_id}"]`);
                        if (row) {
                            row.querySelectorAll('.bulk-edit-field').forEach(field => {
                                const fieldName = field.dataset.field;
                                if (update[fieldName] !== undefined) {
                                    if (field.type === 'checkbox') {
                                        field.checked = update[fieldName];
                                    } else {
                                        field.value = update[fieldName];
                                    }
                                    field.dataset.original = field.type === 'checkbox' 
                                        ? (update[fieldName] ? 'true' : 'false')
                                        : update[fieldName];
                                    markFieldAsEdited(field, false);
                                }
                            });
                            row.classList.remove('has-changes');
                        }
                    });
                    
                    // Update original values to reflect saved state (no page reload)
                    updates.forEach(update => {
                        const row = document.querySelector(`tr[data-product-id="${update.product_id}"]`);
                        if (row) {
                            row.querySelectorAll('.bulk-edit-field').forEach(field => {
                                const fieldName = field.dataset.field;
                                if (update[fieldName] !== undefined) {
                                    if (field.type === 'checkbox') {
                                        field.checked = update[fieldName];
                                        field.dataset.original = update[fieldName] ? 'true' : 'false';
                                    } else {
                                        field.value = update[fieldName];
                                        field.dataset.original = update[fieldName];
                                    }
                                    markFieldAsEdited(field, false);
                                }
                            });
                            row.classList.remove('has-changes');
                        }
                    });
                } else {
                    showToast(data.message || 'Failed to save changes', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Failed to save changes. Please try again.', 'error');
            })
            .finally(() => {
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-save mr-2"></i> Save All Changes';
            });
        }

        // Setup save button
        saveBtn.addEventListener('click', saveAllChanges);

        // Setup handlers on page load
        setupBulkEditHandlers();
        
        // Setup handlers after HTMX updates (for search functionality)
        document.body.addEventListener('htmx:afterSwap', function(event) {
            if (event.detail.target.id === 'products-table') {
                setupBulkEditHandlers();
                changedProducts.clear();
                updateSaveButton();
            }
        });
    });
</script>
{% endblock %}
