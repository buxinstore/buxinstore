{% extends "base.html" %}

{% block title %}Checkout - buxin store{% endblock %}

{% block content %}
{% set currency = cart_summary.currency if cart_summary is defined else 'D' %}
<div class="max-w-7xl mx-auto pt-12 pb-20 px-4 sm:px-6 lg:px-8 space-y-10 bg-[color:var(--app-bg)]">
        <div class="max-w-2xl mx-auto lg:max-w-none">
            <h1 class="sr-only">Checkout</h1>

            <div class="lg:grid lg:grid-cols-2 lg:gap-x-10 xl:gap-x-16">
                <!-- Order summary -->
                <div class="lg:col-span-1">
                    <h2 class="text-lg font-semibold text-slate-900 dark:text-white">Order summary</h2>

                    <div class="mt-4 bg-[color:var(--app-card)] dark:bg-slate-900/70 border border-[color:var(--app-border)] dark:border-slate-800 rounded-3xl shadow-sm transition-colors duration-300">
                        <div class="{% if cart_items %}hidden{% endif %} py-12 px-6 text-center text-[color:var(--app-muted)] dark:text-slate-400" data-checkout-empty>
                            <p>Your cart is currently empty.</p>
                            <p class="mt-2 text-sm">
                                <a href="{{ url_for('cart') }}" class="text-cyan-500 hover:text-cyan-400 dark:text-cyan-300 dark:hover:text-cyan-200 font-semibold">
                                    Return to cart
                                </a>
                            </p>
                        </div>
                        <ul role="list" class="divide-y divide-slate-200 dark:divide-slate-800 {% if not cart_items %}hidden{% endif %}" data-checkout-items>
                            {% for item in cart_items %}
                            <li class="py-6 px-4 sm:px-6" data-checkout-item="{{ item.id }}">
                            <div class="flex items-center">
                                    <div class="flex-shrink-0 w-20 h-20 border border-slate-200 dark:border-slate-800 rounded-xl overflow-hidden">
                                        <img data-checkout-image src="{{ item.image|product_image_url if item.image else url_for('static', filename='images/placeholder.png') }}" alt="{{ item.name }}" class="w-full h-full object-center object-cover" onerror="this.onerror=null; this.src='{{ url_for('static', filename='images/placeholder.png') }}';">
                                    </div>

                                    <div class="ml-6 flex-1 flex flex-col">
                                        <div class="flex">
                                            <h3 class="text-sm">
                                                <a href="{{ url_for('product', product_id=item.id) }}" data-checkout-name class="font-medium text-slate-700 hover:text-cyan-500 dark:text-slate-200 dark:hover:text-cyan-300 transition-colors">
                                                    {{ item.name }}
                                                </a>
                                            </h3>
                                        </div>

                                        <div class="mt-1 flex-1 flex flex-col gap-1">
                                            <div class="flex items-end justify-between">
                                                <p class="text-sm font-semibold text-slate-900 dark:text-white" data-checkout-price>{{ item.price|price_with_symbol }}</p>
                                                <p class="text-sm text-slate-500 dark:text-slate-400" data-checkout-quantity>Qty {{ item.quantity }}</p>
                                            </div>
                                            <div class="flex items-center justify-between">
                                                <p class="text-xs text-slate-500 dark:text-slate-400">
                                                    Shipping: <span data-checkout-item-shipping>{{ item.shipping|price_with_symbol }}</span>
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </li>
                            {% endfor %}
                        </ul>

                        <dl class="border-t border-[color:var(--app-border)] dark:border-slate-800 py-6 px-4 space-y-6 sm:px-6">
                            <div class="flex items-center justify-between">
                                <dt class="text-sm">Subtotal</dt>
                                <dd class="text-sm font-semibold text-slate-900 dark:text-white" data-checkout-subtotal>{{ checkout_summary.subtotal|price_with_symbol }}</dd>
                            </div>
                            <div class="flex items-center justify-between">
                                <dt class="text-sm">Tax</dt>
                                <dd class="text-sm font-semibold text-slate-900 dark:text-white" data-checkout-tax>{{ checkout_summary.tax|price_with_symbol }}</dd>
                            </div>
                            <div class="flex items-center justify-between">
                                <dt class="text-sm">Shipping</dt>
                                <dd class="text-sm font-semibold text-slate-900 dark:text-white" data-checkout-shipping>
                                    {% set is_all_local = cart_summary.get('is_all_local', false) %}
                                    {% if is_all_local %}
                                        <span class="text-green-600 dark:text-green-400">Free (Local)</span>
                                    {% else %}
                                        {{ checkout_summary.shipping|price_with_symbol }}
                                    {% endif %}
                                </dd>
                            </div>
                            <div class="flex items-center justify-between border-t border-[color:var(--app-border)] dark:border-slate-800 pt-6">
                                <dt class="text-base font-semibold text-slate-900 dark:text-white">Total</dt>
                                <dd class="text-base font-bold text-cyan-500 dark:text-cyan-300" data-checkout-total>{{ checkout_summary.total|price_with_symbol }}</dd>
                            </div>
                        </dl>

                        <!-- Shipping Details -->
                        {% set is_all_local = cart_summary.get('is_all_local', false) %}
                        {% if is_all_local %}
                        <!-- Local Gambian Products - Same-day Pickup/Delivery Message -->
                        <div class="border-t border-[color:var(--app-border)] dark:border-slate-800 px-4 pt-6 pb-4 sm:px-6">
                            <div class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-4">
                                <div class="flex items-start gap-3">
                                    <div class="flex-shrink-0">
                                        <span class="text-2xl">üöö</span>
                                    </div>
                                    <div>
                                        <h3 class="text-sm font-semibold text-green-800 dark:text-green-200 mb-1">Available in The Gambia</h3>
                                        <p class="text-sm text-green-700 dark:text-green-300">
                                            This product is available in The Gambia. No shipping fee. Same-day pickup or delivery.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div class="border-t border-[color:var(--app-border)] dark:border-slate-800 px-4 pt-6 pb-4 sm:px-6">
                            <h3 class="text-sm font-semibold text-slate-900 dark:text-white mb-3">Shipping Details</h3>
                            <div class="space-y-2 text-sm text-slate-600 dark:text-slate-400">
                                <p>Your shipping cost is calculated using:</p>
                                <ul class="list-disc list-inside space-y-1 ml-2">
                                    <li>The total weight of all items in your order</li>
                                    <li>The shipping pricing rules for your selected country</li>
                                </ul>
                                <p class="mt-3">
                                    Our system applies the correct rule when your order weight falls within that country's defined range (e.g., 0‚Äì1 kg, 1‚Äì5 kg, etc.).
                                </p>
                                <div class="mt-4 p-3 bg-slate-50 dark:bg-slate-800/50 rounded-lg">
                                    <p class="text-xs font-semibold text-slate-700 dark:text-slate-300 mb-1">Example:</p>
                                    <p class="text-xs text-slate-600 dark:text-slate-400">
                                        If your order weighs 0.8 kg and you choose Ghana, we apply Ghana's shipping rule for 0‚Äì1 kg.
                                    </p>
                                </div>
                                <p class="mt-3 font-medium text-slate-700 dark:text-slate-300">
                                    Final Shipping Fee: Calculated and shown before payment.
                                </p>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Checkout Form -->
                <div class="mt-10 lg:mt-0">
                    <div class="bg-[color:var(--app-card)] dark:bg-slate-900/70 border border-[color:var(--app-border)] dark:border-slate-800 rounded-3xl p-6 sm:p-8 shadow-sm transition-colors duration-300">
                        <h2 class="text-lg font-semibold text-slate-900 dark:text-white mb-1">Delivery Information</h2>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mb-6">Complete your delivery details to proceed</p>

                        <!-- Success message for saved address -->
                        <div id="address-saved-message" class="hidden mb-4 p-3 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg">
                            <p class="text-sm text-green-800 dark:text-green-200 flex items-center gap-2">
                                <i class="fas fa-check-circle"></i>
                                <span>Address saved successfully!</span>
                            </p>
                        </div>

                        <form id="checkout-form" class="space-y-5">
                            {{ form.hidden_tag() }}
                            
                            <!-- Full Name -->
                            <div>
                                <label for="full_name" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">
                                    Full Name <span class="text-red-500">*</span>
                                </label>
                                <input 
                                    type="text" 
                                    id="full_name" 
                                    name="full_name" 
                                    value="{{ form.full_name.data or '' }}"
                                    required
                                    class="block w-full rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-900 dark:text-white px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition-all"
                                    placeholder="John Doe"
                                >
                                <p class="mt-1 text-xs text-red-600 dark:text-red-400 hidden" id="full_name-error"></p>
                            </div>

                            <!-- Email -->
                            <div>
                                <label for="email" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">
                                    Email Address <span class="text-red-500">*</span>
                                </label>
                                <input 
                                    type="email" 
                                    id="email" 
                                    name="email" 
                                    value="{{ form.email.data or '' }}"
                                    required
                                    class="block w-full rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-900 dark:text-white px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition-all"
                                    placeholder="john@example.com"
                                >
                                <p class="mt-1 text-xs text-red-600 dark:text-red-400 hidden" id="email-error"></p>
                            </div>

                            <!-- Phone -->
                            <div>
                                <label for="phone" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">
                                    Phone Number <span class="text-red-500">*</span>
                                </label>
                                <input 
                                    type="tel" 
                                    id="phone" 
                                    name="phone" 
                                    value="{{ form.phone.data or '' }}"
                                    required
                                    class="block w-full rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-900 dark:text-white px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition-all"
                                    placeholder="+220XXXXXXXXX"
                                >
                                <p class="mt-1 text-xs text-red-600 dark:text-red-400 hidden" id="phone-error"></p>
                            </div>

                            <!-- Country -->
                            <div>
                                <label for="country" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">
                                    Country <span class="text-red-500">*</span>
                                </label>
                                            <input 
                                                type="text" 
                                    id="country" 
                                    name="country" 
                                    value="{{ form.country.data or '' }}"
                                    required
                                    class="block w-full rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-900 dark:text-white px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition-all"
                                    placeholder="Gambia"
                                >
                                <p class="mt-1 text-xs text-red-600 dark:text-red-400 hidden" id="country-error"></p>
                            </div>

                            <!-- City / Region -->
                            <div>
                                <label for="city" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">
                                    City / Region <span class="text-red-500">*</span>
                                </label>
                                    <input 
                                    type="text" 
                                    id="city" 
                                    name="city" 
                                    value="{{ form.city.data or '' }}"
                                    required
                                    class="block w-full rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-900 dark:text-white px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition-all"
                                    placeholder="Banjul"
                                >
                                <p class="mt-1 text-xs text-red-600 dark:text-red-400 hidden" id="city-error"></p>
                            </div>

                            <!-- Full Delivery Address -->
                            <div>
                                <label for="delivery_address" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">
                                    Full Delivery Address <span class="text-red-500">*</span>
                                </label>
                                <textarea 
                                    id="delivery_address" 
                                    name="delivery_address" 
                                    rows="3"
                                    required
                                    class="block w-full rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-900 dark:text-white px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition-all resize-none"
                                    placeholder="Street address, building number, apartment, etc."
                                >{{ form.delivery_address.data or '' }}</textarea>
                                <p class="mt-1 text-xs text-red-600 dark:text-red-400 hidden" id="delivery_address-error"></p>
                            </div>

                            <!-- Delivery Notes (Optional) -->
                            <div>
                                <label for="delivery_notes" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">
                                    Delivery Notes <span class="text-slate-400 text-xs">(Optional)</span>
                                </label>
                                <textarea 
                                    id="delivery_notes" 
                                    name="delivery_notes" 
                                    rows="2"
                                    class="block w-full rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-900 dark:text-white px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition-all resize-none"
                                    placeholder="Special delivery instructions, gate code, etc."
                                >{{ form.delivery_notes.data or '' }}</textarea>
                                </div>

                            <!-- Shipping method is automatically selected by the system based on country and rules -->
                            <input type="hidden" id="shipping_mode_key" name="shipping_mode_key" value="{{ selected_shipping_method or '' }}">

                            <!-- Amount (hidden, from cart total) -->
                            <input type="hidden" id="amount" name="amount" value="{{ "%.2f"|format(checkout_summary.total) }}">
                            <input type="hidden" id="pending_payment_id" name="pending_payment_id" value="{{ pending_payment_id or '' }}">

                            <!-- Payment Method Selection -->
                            <div class="pt-4 border-t border-slate-200 dark:border-slate-800">
                                <label class="block text-sm font-semibold text-slate-900 dark:text-white mb-3">
                                    Choose Payment Method <span class="text-red-500">*</span>
                                </label>
                                
                                <div class="space-y-3" id="payment-method-selection">
                                    <!-- ModemPay Option -->
                                    <label class="flex items-start gap-3 p-4 rounded-xl border-2 cursor-pointer transition-all border-cyan-500 bg-cyan-50 dark:bg-cyan-900/20 payment-method-option" data-payment-method="modempay">
                                        <input type="radio" name="payment_method" value="modempay" class="mt-1 h-4 w-4 text-cyan-600 focus:ring-cyan-500 border-gray-300 dark:border-gray-600" checked>
                                        <div class="flex-1">
                                            <div class="flex items-center gap-2">
                                                <span class="text-xl">üí≥</span>
                                                <span class="font-semibold text-slate-900 dark:text-white">ModemPay</span>
                                            </div>
                                            <p class="text-xs text-slate-600 dark:text-slate-400 mt-1">Pay securely with Wave, QMoney, AfriMoney, ECOBANK, or Card</p>
                                        </div>
                                    </label>

                                    <!-- Bank Transfer -->
                                    <label class="flex items-start gap-3 p-4 rounded-xl border-2 cursor-pointer transition-all border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600 payment-method-option" data-payment-method="bank_transfer">
                                        <input type="radio" name="payment_method" value="bank_transfer" class="mt-1 h-4 w-4 text-cyan-600 focus:ring-cyan-500 border-gray-300 dark:border-gray-600">
                                        <div class="flex-1">
                                            <div class="flex items-center gap-2">
                                                <span class="text-xl">üè¶</span>
                                                <span class="font-semibold text-slate-900 dark:text-white">Bank Transfer</span>
                                            </div>
                                            <p class="text-xs text-slate-600 dark:text-slate-400 mt-1">Transfer directly to our bank account</p>
                                        </div>
                                    </label>

                                    <!-- Western Union -->
                                    <label class="flex items-start gap-3 p-4 rounded-xl border-2 cursor-pointer transition-all border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600 payment-method-option" data-payment-method="western_union">
                                        <input type="radio" name="payment_method" value="western_union" class="mt-1 h-4 w-4 text-cyan-600 focus:ring-cyan-500 border-gray-300 dark:border-gray-600">
                                        <div class="flex-1">
                                            <div class="flex items-center gap-2">
                                                <span class="text-xl">üåç</span>
                                                <span class="font-semibold text-slate-900 dark:text-white">Western Union</span>
                                            </div>
                                            <p class="text-xs text-slate-600 dark:text-slate-400 mt-1">Send money via Western Union</p>
                                        </div>
                                    </label>

                                    <!-- MoneyGram -->
                                    <label class="flex items-start gap-3 p-4 rounded-xl border-2 cursor-pointer transition-all border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600 payment-method-option" data-payment-method="moneygram">
                                        <input type="radio" name="payment_method" value="moneygram" class="mt-1 h-4 w-4 text-cyan-600 focus:ring-cyan-500 border-gray-300 dark:border-gray-600">
                                        <div class="flex-1">
                                            <div class="flex items-center gap-2">
                                                <span class="text-xl">üí∏</span>
                                                <span class="font-semibold text-slate-900 dark:text-white">MoneyGram</span>
                                            </div>
                                            <p class="text-xs text-slate-600 dark:text-slate-400 mt-1">Send money via MoneyGram</p>
                                        </div>
                                    </label>

                                    <!-- Ria -->
                                    <label class="flex items-start gap-3 p-4 rounded-xl border-2 cursor-pointer transition-all border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600 payment-method-option" data-payment-method="ria">
                                        <input type="radio" name="payment_method" value="ria" class="mt-1 h-4 w-4 text-cyan-600 focus:ring-cyan-500 border-gray-300 dark:border-gray-600">
                                        <div class="flex-1">
                                            <div class="flex items-center gap-2">
                                                <span class="text-xl">üí≥</span>
                                                <span class="font-semibold text-slate-900 dark:text-white">Ria Money Transfer</span>
                                            </div>
                                            <p class="text-xs text-slate-600 dark:text-slate-400 mt-1">Send money via Ria Money Transfer</p>
                                        </div>
                                    </label>

                                    <!-- Wave (Manual) -->
                                    <label class="flex items-start gap-3 p-4 rounded-xl border-2 cursor-pointer transition-all border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600 payment-method-option" data-payment-method="wave">
                                        <input type="radio" name="payment_method" value="wave" class="mt-1 h-4 w-4 text-cyan-600 focus:ring-cyan-500 border-gray-300 dark:border-gray-600">
                                        <div class="flex-1">
                                            <div class="flex items-center gap-2">
                                                <span class="text-xl">üì±</span>
                                                <span class="font-semibold text-slate-900 dark:text-white">Wave (Manual Payment)</span>
                                            </div>
                                            <p class="text-xs text-slate-600 dark:text-slate-400 mt-1">Send payment to Wave number and upload receipt</p>
                                        </div>
                                    </label>
                                </div>

                                <!-- Payment Details Display (shown based on selected method) -->
                                <div id="payment-details-container" class="mt-4 hidden">
                                    <div class="bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-800 rounded-xl p-4">
                                        <h4 class="text-sm font-semibold text-slate-900 dark:text-white mb-3">Payment Details</h4>
                                        <div id="payment-details-content" class="space-y-2 text-sm text-slate-700 dark:text-slate-300">
                                            <!-- Payment details will be populated by JavaScript -->
                                        </div>
                                    </div>
                                </div>

                                <!-- Receipt Upload (for manual payment methods only) -->
                                <div id="receipt-upload-container" class="mt-4 hidden">
                                    <label for="payment_receipt" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
                                        Upload Payment Receipt <span class="text-red-500">*</span>
                                    </label>
                                    <input 
                                        type="file" 
                                        id="payment_receipt" 
                                        name="payment_receipt"
                                        accept="image/*,.pdf"
                                        class="block w-full text-sm text-slate-500 dark:text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-cyan-50 file:text-cyan-700 hover:file:bg-cyan-100 dark:file:bg-cyan-900/20 dark:file:text-cyan-300"
                                    >
                                    <p class="mt-1 text-xs text-slate-500 dark:text-slate-400" id="receipt-instructions">
                                        Upload a screenshot or photo of your payment receipt
                                    </p>
                                    <div id="receipt-preview" class="mt-2 hidden">
                                        <img id="receipt-preview-img" src="" alt="Receipt preview" class="max-w-xs rounded-lg border border-slate-200 dark:border-slate-700">
                                    </div>
                                </div>
                            </div>

                            <!-- Proceed to Payment Button -->
                            <div class="pt-2">
                                <button 
                                    type="submit" 
                                    id="proceed-button"
                                    class="w-full rounded-xl bg-gradient-to-r from-cyan-500 to-blue-500 py-3 px-4 text-base font-semibold text-white shadow-lg shadow-cyan-500/20 transition-all hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-cyan-400 focus:ring-offset-2 dark:focus:ring-offset-slate-900"
                                >
                                    <span id="button-text">Proceed to Payment</span>
                                    <span id="button-loading" class="hidden">Processing...</span>
                                </button>
                            </div>
                        </form>

                        <!-- Response Display Area -->
                        <div id="response" class="mt-6 hidden" style="display:none !important;" aria-hidden="true">
                            <div class="rounded-2xl border border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-slate-900/50 p-4 shadow-inner">
                                <h3 class="text-sm font-semibold text-slate-900 dark:text-white mb-2">Payment Response</h3>
                                <pre id="response-content" class="text-xs bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 p-3 overflow-auto max-h-64 text-slate-800 dark:text-slate-200"></pre>
                            </div>
                        </div>
                         

                        <!-- Success/Error Messages -->
                        <div id="message" class="mt-4 hidden" style="display:none !important;" aria-hidden="true">
                            <div id="message-content" class="rounded-xl p-4 text-sm font-medium"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- How We Calculate Shipping -->
        <div class="mt-10 bg-[color:var(--app-card)] dark:bg-slate-900/70 border border-[color:var(--app-border)] dark:border-slate-800 rounded-3xl p-6 shadow-sm transition-colors duration-300">
            <h2 class="text-lg font-semibold text-slate-900 dark:text-white mb-4">How We Calculate Shipping</h2>
            <div class="space-y-3 text-sm text-slate-600 dark:text-slate-400">
                <ul class="list-disc list-inside space-y-2">
                    <li>Every product has an official weight.</li>
                    <li>We add all product weights together.</li>
                    <li>We match the total weight to your country's shipping ranges.</li>
                    <li>The exact shipping fee is added to your final total.</li>
                </ul>
                <div class="mt-4 pt-4 border-t border-slate-200 dark:border-slate-800">
                    <p class="text-sm">This ensures:</p>
                    <ul class="list-disc list-inside space-y-1 mt-2">
                        <li>Accurate pricing</li>
                        <li>Fair and transparent shipping</li>
                        <li>No guesswork or hidden fees</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script id="checkout-summary-data" type="application/json">{{ cart_summary | tojson }}</script>
<script>
    // Checkout form validation and submission
    (function() {
        const form = document.getElementById('checkout-form');
        const proceedButton = document.getElementById('proceed-button');
        const buttonText = document.getElementById('button-text');
        const buttonLoading = document.getElementById('button-loading');
        const addressSavedMessage = document.getElementById('address-saved-message');
        
        // Form fields
        const fields = {
            full_name: document.getElementById('full_name'),
            email: document.getElementById('email'),
            phone: document.getElementById('phone'),
            country: document.getElementById('country'),
            city: document.getElementById('city'),
            delivery_address: document.getElementById('delivery_address')
        };
        
        // Validation state
        let validationState = {
            full_name: false,
            email: false,
            phone: false,
            country: false,
            city: false,
            delivery_address: false
        };
        
        // Validation functions
        function validateFullName(value) {
            return value.trim().length >= 2;
        }
        
        function validateEmail(value) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(value.trim());
        }
        
        function validatePhone(value) {
            // Allow various phone formats
            const cleaned = value.replace(/\D/g, '');
            return cleaned.length >= 7;
        }
        
        function validateRequired(value) {
            return value.trim().length > 0;
        }
        
        // Show error
        function showError(fieldName, message) {
            const field = fields[fieldName];
            const errorEl = document.getElementById(`${fieldName}-error`);
            if (field && errorEl) {
                field.classList.add('border-red-500', 'dark:border-red-500');
                field.classList.remove('border-slate-300', 'dark:border-slate-600');
                errorEl.textContent = message;
                errorEl.classList.remove('hidden');
                validationState[fieldName] = false;
            }
        }
        
        // Clear error
        function clearError(fieldName) {
            const field = fields[fieldName];
            const errorEl = document.getElementById(`${fieldName}-error`);
            if (field && errorEl) {
                field.classList.remove('border-red-500', 'dark:border-red-500');
                field.classList.add('border-slate-300', 'dark:border-slate-600');
                errorEl.classList.add('hidden');
                validationState[fieldName] = true;
            }
        }
        
        // Validate field
        function validateField(fieldName, value) {
            switch(fieldName) {
                case 'full_name':
                    if (!validateFullName(value)) {
                        showError(fieldName, 'Full name must be at least 2 characters');
                        return false;
                    }
                    break;
                case 'email':
                    if (!validateEmail(value)) {
                        showError(fieldName, 'Please enter a valid email address');
                        return false;
                    }
                    break;
                case 'phone':
                    if (!validatePhone(value)) {
                        showError(fieldName, 'Please enter a valid phone number');
                        return false;
                    }
                    break;
                case 'country':
                    if (!validateRequired(value)) {
                        showError(fieldName, 'Please enter your country');
                        return false;
                    }
                    break;
                case 'city':
                case 'delivery_address':
                    if (!validateRequired(value)) {
                        showError(fieldName, 'This field is required');
                        return false;
                    }
                    break;
            }
            clearError(fieldName);
            return true;
        }
        
        // Validate all fields
        function validateForm() {
            let isValid = true;
            for (const [fieldName, field] of Object.entries(fields)) {
                if (!validateField(fieldName, field.value)) {
                    isValid = false;
                }
            }
            return isValid;
        }
        
        // Update button state
        function updateButtonState() {
            const isValid = validateForm();
            if (proceedButton) {
            proceedButton.disabled = !isValid;
                console.log('Button state updated:', { isValid, disabled: proceedButton.disabled });
            }
        }
        
        // Initial button state check on page load
        setTimeout(() => {
            updateButtonState();
        }, 100);
        
        // Real-time validation for all fields
        Object.entries(fields).forEach(([fieldName, field]) => {
            if (!field) return;
            
            field.addEventListener('blur', () => {
                validateField(fieldName, field.value);
                updateButtonState();
            });
            
            field.addEventListener('input', () => {
                // Always validate on input to ensure button state updates
                    validateField(fieldName, field.value);
                updateButtonState();
            });
        });
        
        // Auto-save address on blur (debounced)
        let saveTimeout;
        function autoSaveAddress() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                if (validateForm()) {
                    try {
                        const response = await fetch('/api/checkout/save-address', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
                            },
                            body: JSON.stringify({
                                full_name: fields.full_name.value,
                                email: fields.email.value,
                                phone: fields.phone.value,
                                country: fields.country.value,
                                city: fields.city.value,
                                delivery_address: fields.delivery_address.value
                            })
                        });
                        
                const data = await response.json();
                        if (data.success) {
                            addressSavedMessage.classList.remove('hidden');
                            setTimeout(() => {
                                addressSavedMessage.classList.add('hidden');
                            }, 3000);
                }
            } catch (error) {
                        console.error('Error saving address:', error);
                    }
                }
            }, 1000); // Wait 1 second after user stops typing
        }
        
        // Auto-save on field changes
        Object.values(fields).forEach(field => {
            field.addEventListener('input', autoSaveAddress);
        });
        
        // Payment method selection and details display (initialize after DOM is ready)
        let paymentMethodRadios, paymentDetailsContainer, paymentDetailsContent, receiptUploadContainer, receiptInput, receiptPreview, receiptPreviewImg, receiptInstructions;
        
        function initPaymentMethodElements() {
            paymentMethodRadios = document.querySelectorAll('input[name="payment_method"]');
            paymentDetailsContainer = document.getElementById('payment-details-container');
            paymentDetailsContent = document.getElementById('payment-details-content');
            receiptUploadContainer = document.getElementById('receipt-upload-container');
            receiptInput = document.getElementById('payment_receipt');
            receiptPreview = document.getElementById('receipt-preview');
            receiptPreviewImg = document.getElementById('receipt-preview-img');
            receiptInstructions = document.getElementById('receipt-instructions');
        }
        
        // Payment details data
        const paymentDetails = {
            'bank_transfer': {
                title: 'Bank Transfer Details',
                content: `
                    <div class="space-y-2">
                        <div><strong>Account Holder Name:</strong> ABDOUKADIR JABBI</div>
                        <div><strong>Bank Name:</strong> State Bank of India (SBI)</div>
                        <div><strong>Branch Name:</strong> Surajpur Greater Noida</div>
                        <div><strong>Account Number:</strong> 60541424234</div>
                        <div><strong>IFSC Code:</strong> <span class="font-bold text-red-600 dark:text-red-400">SBIN0014022</span> <span class="text-xs">(VERY IMPORTANT)</span></div>
                        </div>
                `,
                instructions: 'After payment, upload your bank transfer receipt/screenshot here.'
            },
            'western_union': {
                title: 'Western Union Details',
                content: `
                    <div class="space-y-2">
                        <div><strong>Receiver Name:</strong> Abdoukadir Jabbi</div>
                        <div><strong>Country:</strong> India</div>
                        <div><strong>Phone:</strong> +91 93190 38312</div>
                        </div>
                `,
                instructions: 'Send payment via Western Union and upload your receipt here.'
            },
            'moneygram': {
                title: 'MoneyGram Details',
                content: `
                    <div class="space-y-2">
                        <div><strong>Receiver Name:</strong> Abdoukadir Jabbi</div>
                        <div><strong>Country:</strong> India</div>
                        <div><strong>Phone:</strong> +91 93190 38312</div>
                    </div>
                `,
                instructions: 'Send payment via MoneyGram and upload your receipt here.'
            },
            'ria': {
                title: 'Ria Money Transfer Details',
                content: `
                    <div class="space-y-2">
                        <div><strong>Receiver Name:</strong> Abdoukadir Jabbi</div>
                        <div><strong>Country:</strong> India</div>
                        <div><strong>Phone:</strong> +91 93190 38312</div>
                    </div>
                `,
                instructions: 'Send payment via Ria Money Transfer and upload your receipt here.'
            },
            'wave': {
                title: 'Wave Payment Details',
                content: `
                    <div class="space-y-2">
                        <div><strong>Receiver Name:</strong> Foday M J</div>
                        <div><strong>Wave Number:</strong> <span class="font-bold text-cyan-600 dark:text-cyan-400">5427090</span></div>
                        <div class="text-xs text-slate-600 dark:text-slate-400">Send payment to this Wave number and upload the screenshot.</div>
                    </div>
                `,
                instructions: 'Send payment to the Wave number above and upload your payment screenshot here.'
            }
        };
        
        // Handle payment method selection
        function updatePaymentMethodDisplay() {
            const selectedMethod = document.querySelector('input[name="payment_method"]:checked')?.value || 'modempay';
            const isManualPayment = selectedMethod !== 'modempay';
            
            // Update visual selection
            document.querySelectorAll('.payment-method-option').forEach(option => {
                const method = option.dataset.paymentMethod;
                if (method === selectedMethod) {
                    option.classList.remove('border-gray-200', 'dark:border-gray-700');
                    option.classList.add('border-cyan-500', 'bg-cyan-50', 'dark:bg-cyan-900/20');
                } else {
                    option.classList.remove('border-cyan-500', 'bg-cyan-50', 'dark:bg-cyan-900/20');
                    option.classList.add('border-gray-200', 'dark:border-gray-700');
                }
            });
            
            // Show/hide payment details
            if (isManualPayment && paymentDetails[selectedMethod]) {
                paymentDetailsContainer.classList.remove('hidden');
                paymentDetailsContent.innerHTML = paymentDetails[selectedMethod].content;
            } else {
                paymentDetailsContainer.classList.add('hidden');
            }
            
            // Show/hide receipt upload
            if (isManualPayment) {
                receiptUploadContainer.classList.remove('hidden');
                if (paymentDetails[selectedMethod]) {
                    receiptInstructions.textContent = paymentDetails[selectedMethod].instructions;
                }
            } else {
                receiptUploadContainer.classList.add('hidden');
            }
        }
        
        // Initialize payment method functionality (called after DOM is ready)
        function initPaymentMethodSelection() {
            initPaymentMethodElements();
            
            if (!paymentDetailsContainer || !paymentDetailsContent || !receiptUploadContainer) {
                // Payment method elements don't exist (maybe not on this page), skip initialization
                return;
            }
            
            // Handle receipt preview
            if (receiptInput) {
                receiptInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        if (file.type.startsWith('image/')) {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                if (receiptPreviewImg) {
                                    receiptPreviewImg.src = e.target.result;
                                }
                                if (receiptPreview) {
                                    receiptPreview.classList.remove('hidden');
                                }
                            };
                            reader.readAsDataURL(file);
                } else {
                            if (receiptPreview) {
                                receiptPreview.classList.add('hidden');
                    }
                }
            } else {
                        if (receiptPreview) {
                            receiptPreview.classList.add('hidden');
                        }
                    }
                });
            }
            
            // Listen for payment method changes
            if (paymentMethodRadios && paymentMethodRadios.length > 0) {
                paymentMethodRadios.forEach(radio => {
                    radio.addEventListener('change', updatePaymentMethodDisplay);
                });
            }
            
            // Initialize display
            updatePaymentMethodDisplay();
        }
        
        // Form submission
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!validateForm()) {
                // Scroll to first error
                const firstError = Object.entries(fields).find(([name, field]) => !validationState[name]);
                if (firstError) {
                    firstError[1].scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstError[1].focus();
                }
                return;
            }
            
            // Disable button and show loading
            proceedButton.disabled = true;
            buttonText.classList.add('hidden');
            buttonLoading.classList.remove('hidden');
            
            // Save address and update pending payment with shipping method
            try {
                // Save address
                await fetch('/api/checkout/save-address', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
                    },
                    body: JSON.stringify({
                        full_name: fields.full_name.value,
                        email: fields.email.value,
                        phone: fields.phone.value,
                        country: fields.country.value,
                        city: fields.city.value,
                        delivery_address: fields.delivery_address.value
                    })
                });
                
                // Update pending payment with shipping method and recalculate totals
                const pendingPaymentId = document.getElementById('pending_payment_id').value;
                const shippingMethod = document.getElementById('shipping_mode_key').value;
                
                const updateResponse = await fetch('/api/checkout/update-pending-payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
                    },
                    body: JSON.stringify({
                        pending_payment_id: pendingPaymentId,
                        shipping_mode_key: shippingMethod,
                        country: fields.country.value,
                        full_name: fields.full_name.value,
                        phone: fields.phone.value,
                        email: fields.email.value,
                        delivery_address: fields.delivery_address.value
                    })
                });
                
                const updateData = await updateResponse.json();
                if (updateData.success) {
                    // Update amount field with new total
                    const amountInput = document.getElementById('amount');
                    if (amountInput) {
                        amountInput.value = updateData.amount.toFixed(2);
                    }
                }
            } catch (error) {
                console.error('Error saving address/updating payment:', error);
            }
            
            // Get form values
            const pendingPaymentId = document.getElementById('pending_payment_id').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const selectedPaymentMethod = document.querySelector('input[name="payment_method"]:checked')?.value || 'modempay';
            const isManualPayment = selectedPaymentMethod !== 'modempay';
            
            // Validate pending_payment_id
            if (!pendingPaymentId) {
                showMessage('Pending payment ID is missing. Please refresh the page and try again.', 'error');
                proceedButton.disabled = false;
                buttonText.classList.remove('hidden');
                buttonLoading.classList.add('hidden');
                return;
            }
            
            // Validate amount
            if (isNaN(amount) || amount <= 0) {
                showMessage(`Invalid payment amount: ${amount.toFixed(2)}`, 'error');
                proceedButton.disabled = false;
                buttonText.classList.remove('hidden');
                buttonLoading.classList.add('hidden');
                return;
            }
            
            // For manual payments, validate receipt upload
            if (isManualPayment) {
                const receiptInput = document.getElementById('payment_receipt');
                const receiptFile = receiptInput?.files[0];
                if (!receiptFile) {
                    showMessage('Please upload your payment receipt before proceeding.', 'error');
                    const receiptUploadContainer = document.getElementById('receipt-upload-container');
                    if (receiptUploadContainer) {
                        receiptUploadContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                    proceedButton.disabled = false;
                    buttonText.classList.remove('hidden');
                    buttonLoading.classList.add('hidden');
                    return;
                }
            }
            
            // Validation - ModemPay requires minimum 10 GMD
            if (!isManualPayment) {
                const MIN_AMOUNT = 10.0;
                if (amount < MIN_AMOUNT) {
                    showMessage(`Payment amount must be at least D${MIN_AMOUNT}. Current amount: D${amount.toFixed(2)}`, 'error');
                    proceedButton.disabled = false;
                    buttonText.classList.remove('hidden');
                    buttonLoading.classList.add('hidden');
                    return;
                }
            }
            
            try {
                if (isManualPayment) {
                    // Handle manual payment submission
                    const receiptInput = document.getElementById('payment_receipt');
                    const receiptFile = receiptInput?.files[0];
                    if (!receiptFile) {
                        showMessage('Please upload your payment receipt before proceeding.', 'error');
                        proceedButton.disabled = false;
                        buttonText.classList.remove('hidden');
                        buttonLoading.classList.add('hidden');
                        return;
                    }
                    
                    const formData = new FormData();
                    formData.append('pending_payment_id', pendingPaymentId);
                    formData.append('payment_method', selectedPaymentMethod);
                    formData.append('amount', amount);
                    formData.append('receipt', receiptFile);
                    
                    console.log('Submitting manual payment:', selectedPaymentMethod);
                    
                    const response = await fetch('/payments/manual/submit', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
                        },
                        credentials: 'same-origin',
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        // Redirect to payment status/waiting page
                        window.location.href = `/payments/manual/${data.manual_payment_id}/status`;
                    } else {
                        showMessage(data.message || 'Failed to submit payment. Please try again.', 'error');
                        proceedButton.disabled = false;
                        buttonText.classList.remove('hidden');
                        buttonLoading.classList.add('hidden');
                    }
                } else {
                    // Handle ModemPay payment
                const paymentData = {
                    pending_payment_id: parseInt(pendingPaymentId),
                        amount: amount,  // Use the amount from checkout page (what user sees)
                        provider: 'modempay'
                };
                
                    console.log('Initiating ModemPay payment with checkout total:', paymentData);
                
                // Make API call to ModemPay payment endpoint
                const response = await fetch('/payments/modempay/pay', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify(paymentData)
                });
                
                // Parse response
                const data = await response.json();
                
                console.log('ModemPay response:', data);
                
                // Display response
                const responseContent = document.getElementById('response-content');
                if (responseContent) {
                    responseContent.textContent = JSON.stringify(data, null, 2);
                }
                
                // Handle response
                if (data.success || response.ok) {
                    const paymentUrl = data.payment_url || (data.data && data.data.payment_url);
                    
                    if (paymentUrl && typeof paymentUrl === 'string' && paymentUrl.startsWith('http')) {
                        // Valid payment URL - immediately redirect
                        console.log('Redirecting to ModemPay checkout:', paymentUrl);
                        window.location.href = paymentUrl;
                        return;
                    } else {
                        showMessage('Payment initiated but redirect URL is missing or invalid. Please contact support.', 'error');
                    }
                } else {
                    const errorMsg = data.message || data.error || 'Payment initiation failed';
                    showMessage(errorMsg, 'error');
                }
                }
            } catch (error) {
                console.error('Payment error:', error);
                showMessage('An error occurred while processing your payment. Please try again.', 'error');
            } finally {
                // Re-enable button
                proceedButton.disabled = false;
                buttonText.classList.remove('hidden');
                buttonLoading.classList.add('hidden');
            }
        });
        
        // Show message function
        function showMessage(message, type) {
            const messageDiv = document.getElementById('message');
            const messageContent = document.getElementById('message-content');
            
            if (!messageDiv || !messageContent) return;
            
            messageContent.className = 'rounded-md p-4';
            
            if (type === 'success') {
                messageContent.classList.add('bg-green-50', 'text-green-800', 'border', 'border-green-200', 'dark:bg-green-900', 'dark:text-green-200', 'dark:border-green-700');
            } else if (type === 'error') {
                messageContent.classList.add('bg-red-50', 'text-red-800', 'border', 'border-red-200', 'dark:bg-red-900', 'dark:text-red-200', 'dark:border-red-700');
            }
            
            messageContent.innerHTML = message;
            messageDiv.classList.remove('hidden');
            messageDiv.style.display = 'block';
            
            setTimeout(() => {
                messageDiv.classList.add('hidden');
                messageDiv.style.display = 'none';
            }, 10000);
        }
        
        // Initialize payment method selection on DOM ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                initPaymentMethodSelection();
            });
        } else {
            initPaymentMethodSelection();
        }
    })();
    
    // Rest of existing checkout summary sync code...
    const CHECKOUT_CURRENCY = document.body.dataset.cartCurrency || "{{ currency }}";
    const STATIC_BASE = "{{ url_for('static', filename='') }}";
    const PLACEHOLDER_IMAGE = "{{ url_for('static', filename='images/placeholder.png') }}";

    function formatCheckoutCurrency(value, currency = CHECKOUT_CURRENCY) {
        const numeric = Number(value) || 0;
        return `${currency}${numeric.toFixed(2)}`;
    }

    function sanitizeImagePath(imagePath) {
        if (!imagePath) {
            return PLACEHOLDER_IMAGE;
        }

        // Handle full URLs (http/https) - return as-is
        if (/^https?:\/\//i.test(imagePath)) {
            return imagePath;
        }
        
        // Handle absolute paths that don't start with /static/ - return as-is
        if (imagePath.startsWith('/') && !imagePath.startsWith('/static/')) {
            return imagePath;
        }

        // Handle relative paths - prepend /static/
        const trimmed = imagePath.startsWith('/') ? imagePath.slice(1) : imagePath;
        return `${STATIC_BASE}${trimmed}`;
    }

    function updateCheckoutItemRow(row, item, currency) {
        const imageEl = row.querySelector('[data-checkout-image]');
        if (imageEl) {
            imageEl.src = sanitizeImagePath(item.image);
            imageEl.alt = item.name || 'Cart item';
        }

        const nameLink = row.querySelector('[data-checkout-name]');
        if (nameLink) {
            nameLink.textContent = item.name || 'Product';
            nameLink.href = `/product/${item.id}`;
        }

        const priceEl = row.querySelector('[data-checkout-price]');
        if (priceEl) {
            priceEl.textContent = formatCheckoutCurrency(item.price, currency);
        }

        const quantityEl = row.querySelector('[data-checkout-quantity]');
        if (quantityEl) {
            quantityEl.textContent = `Qty ${item.quantity}`;
        }

        const itemShippingEl = row.querySelector('[data-checkout-item-shipping]');
        if (itemShippingEl) {
            const itemShipping = item.shipping || 0;
            itemShippingEl.textContent = formatCheckoutCurrency(itemShipping, currency);
        }
    }

    function normalizeSummary(payload) {
        if (!payload) {
            return null;
        }

        if (payload.cart) {
            return payload.cart;
        }

        if (payload.checkout && payload.items) {
            return payload;
        }

        return null;
    }

    function updateCheckoutView(summary) {
        if (!summary) {
            return;
        }

        const currency = summary.currency || CHECKOUT_CURRENCY;
        const checkout = summary.checkout || {};
        const itemsData = summary.items || checkout.items || [];

        const itemsContainer = document.querySelector('[data-checkout-items]');
        const emptyState = document.querySelector('[data-checkout-empty]');

        if (itemsContainer) {
            const existingItems = new Map();
            itemsContainer.querySelectorAll('[data-checkout-item]').forEach(node => {
                existingItems.set(Number(node.dataset.checkoutItem), node);
            });

            const visibleIds = new Set();

            itemsData.forEach(item => {
                const id = Number(item.id);
                visibleIds.add(id);
                let row = existingItems.get(id);
                if (!row) {
                    row = document.createElement('li');
                    row.className = 'py-6 px-4 sm:px-6';
                    row.dataset.checkoutItem = id;
                    row.innerHTML = `
                        <div class="flex items-center">
                            <div class="flex-shrink-0 w-20 h-20 border border-slate-200 dark:border-slate-800 rounded-xl overflow-hidden">
                                <img data-checkout-image class="w-full h-full object-center object-cover" alt="">
                            </div>
                            <div class="ml-6 flex-1 flex flex-col">
                                <div class="flex">
                                    <h3 class="text-sm">
                                        <a data-checkout-name class="font-medium text-slate-700 hover:text-cyan-500 dark:text-slate-200 dark:hover:text-cyan-300 transition-colors"></a>
                                    </h3>
                                </div>
                                <div class="mt-1 flex-1 flex flex-col gap-1">
                                    <div class="flex items-end justify-between">
                                        <p class="text-sm font-semibold text-slate-900 dark:text-white" data-checkout-price></p>
                                        <p class="text-sm text-slate-500 dark:text-slate-400" data-checkout-quantity></p>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <p class="text-xs text-slate-500 dark:text-slate-400">
                                            Shipping: <span data-checkout-item-shipping></span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    itemsContainer.appendChild(row);
                }

                updateCheckoutItemRow(row, item, currency);
            });

            existingItems.forEach((row, id) => {
                if (!visibleIds.has(id)) {
                    row.remove();
                }
            });

            const hasItems = itemsData.length > 0;
            itemsContainer.classList.toggle('hidden', !hasItems);
            if (emptyState) {
                emptyState.classList.toggle('hidden', hasItems);
            }
        }

        const subtotalEl = document.querySelector('[data-checkout-subtotal]');
        if (subtotalEl) {
            subtotalEl.textContent = formatCheckoutCurrency(summary.cart_subtotal ?? checkout.subtotal ?? 0, currency);
        }

        const taxEl = document.querySelector('[data-checkout-tax]');
        if (taxEl) {
            taxEl.textContent = formatCheckoutCurrency(summary.cart_tax ?? checkout.tax ?? 0, currency);
        }

        const shippingEl = document.querySelector('[data-checkout-shipping]');
        if (shippingEl) {
            shippingEl.textContent = formatCheckoutCurrency(summary.cart_shipping ?? checkout.shipping ?? 0, currency);
        }

        const totalEl = document.querySelector('[data-checkout-total]');
        if (totalEl) {
            totalEl.textContent = formatCheckoutCurrency(summary.cart_total ?? checkout.total ?? 0, currency);
        }

        const amountInput = document.getElementById('amount');
        if (amountInput) {
            amountInput.value = (checkout.total ?? summary.cart_total ?? 0).toFixed(2);
        }
    }

    function syncCheckoutSummary() {
        fetch('{{ url_for("api_get_cart_summary") }}', {
            credentials: 'same-origin',
            headers: {
                'Accept': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            const normalized = normalizeSummary(data);
            if (normalized) {
                updateCheckoutView(normalized);
            }
        })
        .catch(error => console.error('Error syncing checkout summary:', error));
    }

    document.addEventListener('DOMContentLoaded', () => {
        try {
            const summaryEl = document.getElementById('checkout-summary-data');
            const initialSummary = summaryEl ? JSON.parse(summaryEl.textContent || '{}') : {};
            updateCheckoutView(initialSummary);
        } catch (error) {
            console.error('Failed to parse initial checkout summary:', error);
        }
        syncCheckoutSummary();
    });

    window.addEventListener('cart:updated', event => {
        const normalized = normalizeSummary(event.detail);
        if (normalized) {
            updateCheckoutView(normalized);
        }
    });
</script>
{% endblock %}
