{% extends "base.html" %}

{% block title %}Checkout - buxin store{% endblock %}

{% block content %}
{% set currency = cart_summary.currency if cart_summary is defined else 'D' %}
<div class="max-w-7xl mx-auto pt-12 pb-20 px-4 sm:px-6 lg:px-8 space-y-10 bg-[color:var(--app-bg)]">
        <div class="max-w-2xl mx-auto lg:max-w-none">
            <h1 class="sr-only">Checkout</h1>

            <div class="lg:grid lg:grid-cols-2 lg:gap-x-10 xl:gap-x-16">
                <!-- Order summary -->
                <div class="lg:col-span-1">
                    <h2 class="text-lg font-semibold text-slate-900 dark:text-white">Order summary</h2>

                    <div class="mt-4 bg-[color:var(--app-card)] dark:bg-slate-900/70 border border-[color:var(--app-border)] dark:border-slate-800 rounded-3xl shadow-sm transition-colors duration-300">
                        <div class="{% if cart_items %}hidden{% endif %} py-12 px-6 text-center text-[color:var(--app-muted)] dark:text-slate-400" data-checkout-empty>
                            <p>Your cart is currently empty.</p>
                            <p class="mt-2 text-sm">
                                <a href="{{ url_for('cart') }}" class="text-cyan-500 hover:text-cyan-400 dark:text-cyan-300 dark:hover:text-cyan-200 font-semibold">
                                    Return to cart
                                </a>
                            </p>
                        </div>
                        <ul role="list" class="divide-y divide-slate-200 dark:divide-slate-800 {% if not cart_items %}hidden{% endif %}" data-checkout-items>
                            {% for item in cart_items %}
                            <li class="py-6 px-4 sm:px-6" data-checkout-item="{{ item.id }}">
                            <div class="flex items-center">
                                    <div class="flex-shrink-0 w-20 h-20 border border-slate-200 dark:border-slate-800 rounded-xl overflow-hidden">
                                        <img data-checkout-image src="{{ item.image|product_image_url if item.image else url_for('static', filename='images/placeholder.png') }}" alt="{{ item.name }}" class="w-full h-full object-center object-cover" onerror="this.onerror=null; this.src='{{ url_for('static', filename='images/placeholder.png') }}';">
                                    </div>

                                    <div class="ml-6 flex-1 flex flex-col">
                                        <div class="flex">
                                            <h3 class="text-sm">
                                                <a href="{{ url_for('product', product_id=item.id) }}" data-checkout-name class="font-medium text-slate-700 hover:text-cyan-500 dark:text-slate-200 dark:hover:text-cyan-300 transition-colors">
                                                    {{ item.name }}
                                                </a>
                                            </h3>
                                        </div>

                                        <div class="mt-1 flex-1 flex flex-col gap-1">
                                            <div class="flex items-end justify-between">
                                                <p class="text-sm font-semibold text-slate-900 dark:text-white" data-checkout-price>{{ item.price|price_with_symbol }}</p>
                                                <p class="text-sm text-slate-500 dark:text-slate-400" data-checkout-quantity>Qty {{ item.quantity }}</p>
                                            </div>
                                            <div class="flex items-center justify-between">
                                                <p class="text-xs text-slate-500 dark:text-slate-400">
                                                    Shipping: <span data-checkout-item-shipping>{{ item.shipping|price_with_symbol }}</span>
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </li>
                            {% endfor %}
                        </ul>

                        <dl class="border-t border-[color:var(--app-border)] dark:border-slate-800 py-6 px-4 space-y-6 sm:px-6">
                            <div class="flex items-center justify-between">
                                <dt class="text-sm">Subtotal</dt>
                                <dd class="text-sm font-semibold text-slate-900 dark:text-white" data-checkout-subtotal>{{ checkout_summary.subtotal|price_with_symbol }}</dd>
                            </div>
                            <div class="flex items-center justify-between">
                                <dt class="text-sm">Tax</dt>
                                <dd class="text-sm font-semibold text-slate-900 dark:text-white" data-checkout-tax>{{ checkout_summary.tax|price_with_symbol }}</dd>
                            </div>
                            <div class="flex items-center justify-between">
                                <dt class="text-sm">Shipping</dt>
                                <dd class="text-sm font-semibold text-slate-900 dark:text-white" data-checkout-shipping>{{ checkout_summary.shipping|price_with_symbol }}</dd>
                            </div>
                            <div class="flex items-center justify-between border-t border-[color:var(--app-border)] dark:border-slate-800 pt-6">
                                <dt class="text-base font-semibold text-slate-900 dark:text-white">Total</dt>
                                <dd class="text-base font-bold text-cyan-500 dark:text-cyan-300" data-checkout-total>{{ checkout_summary.total|price_with_symbol }}</dd>
                            </div>
                        </dl>

                        <!-- Shipping Details -->
                        <div class="border-t border-[color:var(--app-border)] dark:border-slate-800 px-4 pt-6 pb-4 sm:px-6">
                            <h3 class="text-sm font-semibold text-slate-900 dark:text-white mb-3">Shipping Details</h3>
                            <div class="space-y-2 text-sm text-slate-600 dark:text-slate-400">
                                <p>Your shipping cost is calculated using:</p>
                                <ul class="list-disc list-inside space-y-1 ml-2">
                                    <li>The total weight of all items in your order</li>
                                    <li>The shipping pricing rules for your selected country</li>
                                </ul>
                                <p class="mt-3">
                                    Our system applies the correct rule when your order weight falls within that country's defined range (e.g., 0–1 kg, 1–5 kg, etc.).
                                </p>
                                <div class="mt-4 p-3 bg-slate-50 dark:bg-slate-800/50 rounded-lg">
                                    <p class="text-xs font-semibold text-slate-700 dark:text-slate-300 mb-1">Example:</p>
                                    <p class="text-xs text-slate-600 dark:text-slate-400">
                                        If your order weighs 0.8 kg and you choose Ghana, we apply Ghana's shipping rule for 0–1 kg.
                                    </p>
                                </div>
                                <p class="mt-3 font-medium text-slate-700 dark:text-slate-300">
                                    Final Shipping Fee: Calculated and shown before payment.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Checkout Form -->
                <div class="mt-10 lg:mt-0">
                    <div class="bg-[color:var(--app-card)] dark:bg-slate-900/70 border border-[color:var(--app-border)] dark:border-slate-800 rounded-3xl p-6 sm:p-8 shadow-sm transition-colors duration-300">
                        <h2 class="text-lg font-semibold text-slate-900 dark:text-white mb-1">Delivery Information</h2>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mb-6">Complete your delivery details to proceed</p>

                        <!-- Success message for saved address -->
                        <div id="address-saved-message" class="hidden mb-4 p-3 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg">
                            <p class="text-sm text-green-800 dark:text-green-200 flex items-center gap-2">
                                <i class="fas fa-check-circle"></i>
                                <span>Address saved successfully!</span>
                            </p>
                        </div>

                        <form id="checkout-form" class="space-y-5">
                            {{ form.hidden_tag() }}
                            
                            <!-- Full Name -->
                            <div>
                                <label for="full_name" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">
                                    Full Name <span class="text-red-500">*</span>
                                </label>
                                <input 
                                    type="text" 
                                    id="full_name" 
                                    name="full_name" 
                                    value="{{ form.full_name.data or '' }}"
                                    required
                                    class="block w-full rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-900 dark:text-white px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition-all"
                                    placeholder="John Doe"
                                >
                                <p class="mt-1 text-xs text-red-600 dark:text-red-400 hidden" id="full_name-error"></p>
                            </div>

                            <!-- Email -->
                            <div>
                                <label for="email" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">
                                    Email Address <span class="text-red-500">*</span>
                                </label>
                                <input 
                                    type="email" 
                                    id="email" 
                                    name="email" 
                                    value="{{ form.email.data or '' }}"
                                    required
                                    class="block w-full rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-900 dark:text-white px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition-all"
                                    placeholder="john@example.com"
                                >
                                <p class="mt-1 text-xs text-red-600 dark:text-red-400 hidden" id="email-error"></p>
                            </div>

                            <!-- Phone -->
                            <div>
                                <label for="phone" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">
                                    Phone Number <span class="text-red-500">*</span>
                                </label>
                                <input 
                                    type="tel" 
                                    id="phone" 
                                    name="phone" 
                                    value="{{ form.phone.data or '' }}"
                                    required
                                    class="block w-full rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-900 dark:text-white px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition-all"
                                    placeholder="+220XXXXXXXXX"
                                >
                                <p class="mt-1 text-xs text-red-600 dark:text-red-400 hidden" id="phone-error"></p>
                            </div>

                            <!-- Country Dropdown -->
                            <div>
                                <label for="country" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">
                                    Country <span class="text-red-500">*</span>
                                </label>
                                <div class="relative" style="z-index: 50;">
                                    <button 
                                        type="button"
                                        id="checkout-country-toggle"
                                        class="w-full flex items-center justify-between rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-900 dark:text-white px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition-all text-left cursor-pointer"
                                        aria-haspopup="true"
                                        aria-expanded="false"
                                        style="pointer-events: auto;"
                                    >
                                        <span class="flex items-center gap-3 flex-1 min-w-0">
                                            <span id="checkout-country-flag" class="flex-shrink-0 w-6 h-6 rounded-full overflow-hidden border border-slate-200 dark:border-slate-700 flex items-center justify-center bg-gray-100 dark:bg-gray-700">
                                                <i data-lucide="globe" class="w-4 h-4 text-slate-400"></i>
                                            </span>
                                            <span id="checkout-country-name" class="flex-1 truncate text-slate-500 dark:text-slate-400">Select a country</span>
                                        </span>
                                        <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400 flex-shrink-0 ml-2 transition-transform"></i>
                                    </button>
                                    <input type="hidden" id="country" name="country" value="{{ form.country.data or '' }}" required>
                                    
                                    <!-- Country Dropdown Menu -->
                                    <div id="checkout-country-dropdown" class="absolute z-[100] w-full mt-2 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-xl shadow-lg hidden max-h-80 overflow-hidden flex flex-col" style="top: 100%; left: 0;">
                                        <!-- Search Input -->
                                        <div class="p-3 border-b border-slate-200 dark:border-slate-700 flex-shrink-0">
                                            <input 
                                                type="text" 
                                                id="checkout-country-search"
                                                placeholder="Search countries..."
                                                class="w-full px-3 py-2 text-sm rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                            >
                                        </div>
                                        <!-- Country List -->
                                        <div id="checkout-country-list" class="overflow-y-auto overscroll-contain p-2 space-y-1 flex-1 min-h-0 scrollbar-thin scrollbar-thumb-slate-300 dark:scrollbar-thumb-slate-600 scrollbar-track-transparent">
                                            <!-- Countries will be loaded via JavaScript -->
                                        </div>
                                    </div>
                                </div>
                                <p class="mt-1 text-xs text-red-600 dark:text-red-400 hidden" id="country-error"></p>
                            </div>

                            <!-- City / Region -->
                            <div>
                                <label for="city" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">
                                    City / Region <span class="text-red-500">*</span>
                                </label>
                                    <input 
                                    type="text" 
                                    id="city" 
                                    name="city" 
                                    value="{{ form.city.data or '' }}"
                                    required
                                    class="block w-full rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-900 dark:text-white px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition-all"
                                    placeholder="Banjul"
                                >
                                <p class="mt-1 text-xs text-red-600 dark:text-red-400 hidden" id="city-error"></p>
                            </div>

                            <!-- Full Delivery Address -->
                            <div>
                                <label for="delivery_address" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">
                                    Full Delivery Address <span class="text-red-500">*</span>
                                </label>
                                <textarea 
                                    id="delivery_address" 
                                    name="delivery_address" 
                                    rows="3"
                                    required
                                    class="block w-full rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-900 dark:text-white px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition-all resize-none"
                                    placeholder="Street address, building number, apartment, etc."
                                >{{ form.delivery_address.data or '' }}</textarea>
                                <p class="mt-1 text-xs text-red-600 dark:text-red-400 hidden" id="delivery_address-error"></p>
                            </div>

                            <!-- Delivery Notes (Optional) -->
                            <div>
                                <label for="delivery_notes" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">
                                    Delivery Notes <span class="text-slate-400 text-xs">(Optional)</span>
                                </label>
                                <textarea 
                                    id="delivery_notes" 
                                    name="delivery_notes" 
                                    rows="2"
                                    class="block w-full rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-900 dark:text-white px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition-all resize-none"
                                    placeholder="Special delivery instructions, gate code, etc."
                                >{{ form.delivery_notes.data or '' }}</textarea>
                                </div>

                            <!-- Shipping method is automatically selected by the system based on country and rules -->
                            <input type="hidden" id="shipping_mode_key" name="shipping_mode_key" value="{{ selected_shipping_method or '' }}">

                            <!-- Amount (hidden, from cart total) -->
                            <input type="hidden" id="amount" name="amount" value="{{ "%.2f"|format(checkout_summary.total) }}">
                            <input type="hidden" id="pending_payment_id" name="pending_payment_id" value="{{ pending_payment_id or '' }}">

                            <!-- Proceed to Payment Button -->
                            <div class="pt-2">
                                <button 
                                    type="submit" 
                                    id="proceed-button"
                                    disabled
                                    class="w-full rounded-xl bg-gradient-to-r from-cyan-500 to-blue-500 py-3 px-4 text-base font-semibold text-white shadow-lg shadow-cyan-500/20 transition-all hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-cyan-400 focus:ring-offset-2 dark:focus:ring-offset-slate-900 disabled:opacity-60 disabled:cursor-not-allowed disabled:hover:shadow-lg"
                                >
                                    <span id="button-text">Proceed to Payment</span>
                                    <span id="button-loading" class="hidden">Processing...</span>
                                </button>
                            </div>
                        </form>

                        <!-- Response Display Area -->
                        <div id="response" class="mt-6 hidden" style="display:none !important;" aria-hidden="true">
                            <div class="rounded-2xl border border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-slate-900/50 p-4 shadow-inner">
                                <h3 class="text-sm font-semibold text-slate-900 dark:text-white mb-2">Payment Response</h3>
                                <pre id="response-content" class="text-xs bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 p-3 overflow-auto max-h-64 text-slate-800 dark:text-slate-200"></pre>
                            </div>
                        </div>
                         

                        <!-- Success/Error Messages -->
                        <div id="message" class="mt-4 hidden" style="display:none !important;" aria-hidden="true">
                            <div id="message-content" class="rounded-xl p-4 text-sm font-medium"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- How We Calculate Shipping -->
        <div class="mt-10 bg-[color:var(--app-card)] dark:bg-slate-900/70 border border-[color:var(--app-border)] dark:border-slate-800 rounded-3xl p-6 shadow-sm transition-colors duration-300">
            <h2 class="text-lg font-semibold text-slate-900 dark:text-white mb-4">How We Calculate Shipping</h2>
            <div class="space-y-3 text-sm text-slate-600 dark:text-slate-400">
                <ul class="list-disc list-inside space-y-2">
                    <li>Every product has an official weight.</li>
                    <li>We add all product weights together.</li>
                    <li>We match the total weight to your country's shipping ranges.</li>
                    <li>The exact shipping fee is added to your final total.</li>
                </ul>
                <div class="mt-4 pt-4 border-t border-slate-200 dark:border-slate-800">
                    <p class="text-sm">This ensures:</p>
                    <ul class="list-disc list-inside space-y-1 mt-2">
                        <li>Accurate pricing</li>
                        <li>Fair and transparent shipping</li>
                        <li>No guesswork or hidden fees</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script id="checkout-summary-data" type="application/json">{{ cart_summary | tojson }}</script>
<script>
    // Checkout form validation and submission
    (function() {
        const form = document.getElementById('checkout-form');
        const proceedButton = document.getElementById('proceed-button');
        const buttonText = document.getElementById('button-text');
        const buttonLoading = document.getElementById('button-loading');
        const addressSavedMessage = document.getElementById('address-saved-message');
        
        // Form fields
        const fields = {
            full_name: document.getElementById('full_name'),
            email: document.getElementById('email'),
            phone: document.getElementById('phone'),
            country: document.getElementById('country'),
            city: document.getElementById('city'),
            delivery_address: document.getElementById('delivery_address')
        };
        
        // Validation state
        let validationState = {
            full_name: false,
            email: false,
            phone: false,
            country: false,
            city: false,
            delivery_address: false
        };
        
        // Validation functions
        function validateFullName(value) {
            return value.trim().length >= 2;
        }
        
        function validateEmail(value) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(value.trim());
        }
        
        function validatePhone(value) {
            // Allow various phone formats
            const cleaned = value.replace(/\D/g, '');
            return cleaned.length >= 7;
        }
        
        function validateRequired(value) {
            return value.trim().length > 0;
        }
        
        // Show error
        function showError(fieldName, message) {
            const field = fields[fieldName];
            const errorEl = document.getElementById(`${fieldName}-error`);
            if (fieldName === 'country') {
                // For country dropdown, update toggle button border
                const toggle = document.getElementById('checkout-country-toggle');
                if (toggle && errorEl) {
                    toggle.classList.add('border-red-500', 'dark:border-red-500');
                    toggle.classList.remove('border-slate-300', 'dark:border-slate-600');
                    errorEl.textContent = message;
                    errorEl.classList.remove('hidden');
                    validationState[fieldName] = false;
                }
            } else if (field && errorEl) {
                field.classList.add('border-red-500', 'dark:border-red-500');
                field.classList.remove('border-slate-300', 'dark:border-slate-600');
                errorEl.textContent = message;
                errorEl.classList.remove('hidden');
                validationState[fieldName] = false;
            }
        }
        
        // Clear error
        function clearError(fieldName) {
            const field = fields[fieldName];
            const errorEl = document.getElementById(`${fieldName}-error`);
            if (fieldName === 'country') {
                // For country dropdown, update toggle button border
                const toggle = document.getElementById('checkout-country-toggle');
                if (toggle && errorEl) {
                    toggle.classList.remove('border-red-500', 'dark:border-red-500');
                    toggle.classList.add('border-slate-300', 'dark:border-slate-600');
                    errorEl.classList.add('hidden');
                    validationState[fieldName] = true;
                }
            } else if (field && errorEl) {
                field.classList.remove('border-red-500', 'dark:border-red-500');
                field.classList.add('border-slate-300', 'dark:border-slate-600');
                errorEl.classList.add('hidden');
                validationState[fieldName] = true;
            }
        }
        
        // Validate field
        function validateField(fieldName, value) {
            switch(fieldName) {
                case 'full_name':
                    if (!validateFullName(value)) {
                        showError(fieldName, 'Full name must be at least 2 characters');
                        return false;
                    }
                    break;
                case 'email':
                    if (!validateEmail(value)) {
                        showError(fieldName, 'Please enter a valid email address');
                        return false;
                    }
                    break;
                case 'phone':
                    if (!validatePhone(value)) {
                        showError(fieldName, 'Please enter a valid phone number');
                        return false;
                    }
                    break;
                case 'country':
                    // For country dropdown, check if a country is selected
                    if (!value || value.trim() === '') {
                        showError(fieldName, 'Please select a country');
                        return false;
                    }
                    break;
                case 'city':
                case 'delivery_address':
                    if (!validateRequired(value)) {
                        showError(fieldName, 'This field is required');
                        return false;
                    }
                    break;
            }
            clearError(fieldName);
            return true;
        }
        
        // Validate all fields
        function validateForm() {
            let isValid = true;
            for (const [fieldName, field] of Object.entries(fields)) {
                if (!validateField(fieldName, field.value)) {
                    isValid = false;
                }
            }
            return isValid;
        }
        
        // Update button state
        function updateButtonState() {
            const isValid = validateForm();
            proceedButton.disabled = !isValid;
        }
        
        // Real-time validation (excluding country which is handled by dropdown)
        Object.entries(fields).forEach(([fieldName, field]) => {
            if (fieldName === 'country') return; // Skip country, handled by dropdown
            
            field.addEventListener('blur', () => {
                validateField(fieldName, field.value);
                updateButtonState();
            });
            
            field.addEventListener('input', () => {
                if (validationState[fieldName] === false) {
                    // Only validate if there was an error
                    validateField(fieldName, field.value);
                }
                updateButtonState();
            });
        });
        
        // Country dropdown functionality
        let checkoutCountries = [];
        let selectedCountry = null;
        let countryToggle, countryDropdown, countryList, countrySearch, countryName, countryFlag, countryInput;
        const savedCountryName = '{{ form.country.data or '' }}';
        
        // Initialize country dropdown elements (called after DOM is ready)
        function initCountryDropdownElements() {
            countryToggle = document.getElementById('checkout-country-toggle');
            countryDropdown = document.getElementById('checkout-country-dropdown');
            countryList = document.getElementById('checkout-country-list');
            countrySearch = document.getElementById('checkout-country-search');
            countryName = document.getElementById('checkout-country-name');
            countryFlag = document.getElementById('checkout-country-flag');
            countryInput = document.getElementById('country');
        }
        
        // Load countries from API
        async function loadCheckoutCountries() {
            if (!countryToggle || !countryDropdown || !countryList) {
                console.error('Country dropdown elements not found', {
                    toggle: !!countryToggle,
                    dropdown: !!countryDropdown,
                    list: !!countryList
                });
                return;
            }
            
            // Show loading state
            countryList.innerHTML = '<p class="p-4 text-sm text-slate-500">Loading countries...</p>';
            
            try {
                const response = await fetch('/api/countries');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                if (data.success && data.countries && Array.isArray(data.countries)) {
                    checkoutCountries = data.countries;
                    if (checkoutCountries.length === 0) {
                        console.warn('No countries returned from API');
                        countryList.innerHTML = '<p class="p-4 text-sm text-slate-500">No countries available</p>';
                        return;
                    }
                    renderCheckoutCountryList();
                    // Auto-select saved country
                    if (savedCountryName && savedCountryName.trim()) {
                        const savedCountry = checkoutCountries.find(c => c.name === savedCountryName.trim());
                        if (savedCountry) {
                            await selectCheckoutCountry(savedCountry);
                        }
                    }
                } else {
                    console.error('Invalid response from countries API:', data);
                    countryList.innerHTML = '<p class="p-4 text-sm text-red-500">Error loading countries. Please refresh the page.</p>';
                }
            } catch (error) {
                console.error('Error loading countries:', error);
                if (countryList) {
                    countryList.innerHTML = '<p class="p-4 text-sm text-red-500">Failed to load countries. Please refresh the page.</p>';
                }
            }
        }
        
        // Render country list
        function renderCheckoutCountryList(filter = '') {
            if (!countryList) return;
            
            const filtered = filter 
                ? checkoutCountries.filter(c => 
                    c.name.toLowerCase().includes(filter.toLowerCase()) ||
                    c.code.toLowerCase().includes(filter.toLowerCase())
                  )
                : checkoutCountries;
            
            countryList.innerHTML = filtered.map(country => {
                const flagUrl = country.flag_url || 
                    (country.flag_image_path ? 
                        (country.flag_image_path.startsWith('http') ? country.flag_image_path : `/static/${country.flag_image_path}`) :
                        (country.code ? `https://flagcdn.com/w40/${country.code.toLowerCase()}.png` : ''));
                
                const isSelected = selectedCountry && selectedCountry.id === country.id;
                
                return `
                    <button 
                        type="button"
                        class="w-full flex items-center gap-3 px-3 py-2.5 text-left hover:bg-slate-100 dark:hover:bg-slate-700/50 rounded-lg transition-colors ${isSelected ? 'bg-slate-100 dark:bg-slate-700/50 ring-2 ring-cyan-500/30' : ''}"
                        data-country-id="${country.id}"
                        data-country-name="${country.name}"
                    >
                        <div class="flex-shrink-0 w-8 h-8 rounded-full overflow-hidden border border-slate-200 dark:border-slate-700 flex items-center justify-center bg-gray-100 dark:bg-gray-700">
                            ${flagUrl ? `<img src="${flagUrl}" alt="${country.name}" class="w-full h-full object-cover" onerror="this.onerror=null; this.style.display='none'; this.parentElement.innerHTML='<i data-lucide=\\'globe\\' class=\\'w-4 h-4 text-slate-400\\'></i>'; if(window.lucide) window.lucide.createIcons();">` : '<i data-lucide="globe" class="w-4 h-4 text-slate-400"></i>'}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="text-sm font-medium text-slate-900 dark:text-white truncate">${country.name}</div>
                            <div class="text-xs text-slate-500 dark:text-slate-400">${country.code}</div>
                        </div>
                        ${isSelected ? '<i data-lucide="check" class="w-4 h-4 text-cyan-500 flex-shrink-0"></i>' : ''}
                    </button>
                `;
            }).join('');
            
            // Re-render Lucide icons
            if (window.lucide) {
                window.lucide.createIcons();
            }
            
            // Add click handlers
            countryList.querySelectorAll('button[data-country-id]').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const countryId = parseInt(btn.dataset.countryId);
                    const country = checkoutCountries.find(c => c.id === countryId);
                    if (country) {
                        await selectCheckoutCountry(country);
                    }
                });
            });
        }
        
        // Select country
        async function selectCheckoutCountry(country) {
            selectedCountry = country;
            countryInput.value = country.name;
            
            // Update display
            const flagUrl = country.flag_url || 
                (country.flag_image_path ? 
                    (country.flag_image_path.startsWith('http') ? country.flag_image_path : `/static/${country.flag_image_path}`) :
                    (country.code ? `https://flagcdn.com/w40/${country.code.toLowerCase()}.png` : ''));
            
            if (flagUrl) {
                countryFlag.innerHTML = `<img src="${flagUrl}" alt="${country.name}" class="w-full h-full object-cover" onerror="this.onerror=null; this.innerHTML='<i data-lucide=\\'globe\\' class=\\'w-4 h-4 text-slate-400\\'></i>'; if(window.lucide) window.lucide.createIcons();">`;
            } else {
                countryFlag.innerHTML = '<i data-lucide="globe" class="w-4 h-4 text-slate-400"></i>';
            }
            
            countryName.textContent = country.name;
            countryName.classList.remove('text-slate-500', 'dark:text-slate-400');
            countryName.classList.add('text-slate-900', 'dark:text-white');
            
            // Close dropdown
            countryDropdown.classList.add('hidden');
            countryToggle.setAttribute('aria-expanded', 'false');
            const chevron = countryToggle.querySelector('[data-lucide="chevron-down"]');
            if (chevron) {
                chevron.style.transform = '';
            }
            
            // Re-render Lucide icons
            if (window.lucide) {
                window.lucide.createIcons();
            }
            
            // Validate and update button state
            clearError('country');
            validationState.country = true;
            updateButtonState();
            
            // Automatically calculate and set shipping method based on country and rules
            await autoSelectShippingMethod(country.id);
            
            // Trigger auto-save
            autoSaveAddress();
        }
        
        // Automatically select shipping method based on country and rules
        async function autoSelectShippingMethod(countryId) {
            try {
                // Get cart summary data
                const summaryData = JSON.parse(document.getElementById('checkout-summary-data').textContent);
                const cartItems = summaryData.items || [];
                
                // Calculate total weight
                let totalWeight = 0;
                for (const item of cartItems) {
                    const itemWeight = item.weight_kg || 0.1; // Default 0.1kg per item
                    totalWeight += itemWeight * item.quantity;
                }
                
                // Call shipping methods API to get available methods
                const response = await fetch('/api/shipping/methods', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        country_id: countryId,
                        weight: totalWeight
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.methods && data.methods.length > 0) {
                    // Find the first available method (prefer express, then economy_plus, then economy)
                    const methodPriority = ['express', 'economy_plus', 'economy'];
                    let selectedMethod = null;
                    
                    for (const priority of methodPriority) {
                        const method = data.methods.find(m => {
                            const methodId = m.id;
                            const mapping = {
                                'ecommerce': 'economy_plus',
                                'express': 'express',
                                'economy': 'economy'
                            };
                            const modeKey = mapping[methodId] || methodId;
                            return modeKey === priority && m.available && m.price_gmd !== null;
                        });
                        
                        if (method) {
                            selectedMethod = method;
                            break;
                        }
                    }
                    
                    // If no method found by priority, use first available
                    if (!selectedMethod) {
                        selectedMethod = data.methods.find(m => m.available && m.price_gmd !== null);
                    }
                    
                    if (selectedMethod) {
                        // Map method ID to shipping_mode_key
                        const methodMapping = {
                            'ecommerce': 'economy_plus',
                            'express': 'express',
                            'economy': 'economy'
                        };
                        const shipping_mode_key = methodMapping[selectedMethod.id] || selectedMethod.id;
                        
                        // Set the hidden input
                        const shippingMethodInput = document.getElementById('shipping_mode_key');
                        if (shippingMethodInput) {
                            shippingMethodInput.value = shipping_mode_key;
                        }
                        
                        // Save to session
                        try {
                            await fetch('/api/cart/select-shipping-method', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
                                },
                                body: JSON.stringify({ shipping_mode_key: shipping_mode_key })
                            });
                        } catch (error) {
                            console.error('Error saving shipping method to session:', error);
                        }
                        
                        // Update cart summary to reflect new shipping
                        const cartSummaryResponse = await fetch('/api/cart/summary');
                        if (cartSummaryResponse.ok) {
                            const cartData = await cartSummaryResponse.json();
                            if (cartData.cart) {
                                updateCheckoutSummary(cartData.cart);
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Error auto-selecting shipping method:', error);
            }
        }
        
        // Update checkout summary display
        function updateCheckoutSummary(summary) {
            const shippingEl = document.querySelector('[data-checkout-shipping]');
            const totalEl = document.querySelector('[data-checkout-total]');
            
            if (shippingEl && summary.shipping !== undefined) {
                const currency = summary.currency || 'D';
                shippingEl.textContent = `${currency}${summary.shipping.toFixed(2)}`;
            }
            
            if (totalEl && summary.total !== undefined) {
                const currency = summary.currency || 'D';
                totalEl.textContent = `${currency}${summary.total.toFixed(2)}`;
            }
            
            const amountInput = document.getElementById('amount');
            if (amountInput && summary.total !== undefined) {
                amountInput.value = summary.total.toFixed(2);
            }
        }
        
        // Toggle dropdown
        function toggleCountryDropdown() {
            if (!countryToggle || !countryDropdown) {
                console.error('Country dropdown elements not found in toggleCountryDropdown');
                return;
            }
            
            const isHidden = countryDropdown.classList.contains('hidden');
            
            if (isHidden) {
                // Ensure countries are loaded before opening
                if (checkoutCountries.length === 0) {
                    loadCheckoutCountries().then(() => {
                        countryDropdown.classList.remove('hidden');
                        countryToggle.setAttribute('aria-expanded', 'true');
                        const chevron = countryToggle.querySelector('[data-lucide="chevron-down"]');
                        if (chevron) {
                            chevron.style.transform = 'rotate(180deg)';
                        }
                        // Focus search input
                        if (countrySearch) {
                            setTimeout(() => countrySearch.focus(), 100);
                        }
                    }).catch(err => {
                        console.error('Error loading countries:', err);
                    });
                } else {
                    countryDropdown.classList.remove('hidden');
                    countryToggle.setAttribute('aria-expanded', 'true');
                    const chevron = countryToggle.querySelector('[data-lucide="chevron-down"]');
                    if (chevron) {
                        chevron.style.transform = 'rotate(180deg)';
                    }
                    // Focus search input
                    if (countrySearch) {
                        setTimeout(() => countrySearch.focus(), 100);
                    }
                }
            } else {
                countryDropdown.classList.add('hidden');
                countryToggle.setAttribute('aria-expanded', 'false');
                const chevron = countryToggle.querySelector('[data-lucide="chevron-down"]');
                if (chevron) {
                    chevron.style.transform = '';
                }
            }
        }
        
        // Track if dropdown is initialized to prevent duplicate listeners
        let dropdownInitialized = false;
        
        // Initialize country dropdown on page load
        function initCountryDropdown() {
            initCountryDropdownElements();
            
            if (!countryToggle || !countryDropdown || !countryList) {
                console.error('Country dropdown elements not found, retrying...', {
                    toggle: !!countryToggle,
                    dropdown: !!countryDropdown,
                    list: !!countryList
                });
                setTimeout(initCountryDropdown, 100);
                return;
            }
            
            // Prevent duplicate initialization
            if (dropdownInitialized) {
                return;
            }
            
            // Load countries
            loadCheckoutCountries();
            
            // Set up event listeners
            if (countryToggle) {
                // Click handler - use capture phase to catch early and prevent conflicts
                const handleToggleClick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleCountryDropdown();
                    return false;
                };
                
                // Add listener in capture phase to catch event early
                countryToggle.addEventListener('click', handleToggleClick, true);
            }
            
            // Search functionality
            if (countrySearch) {
                countrySearch.addEventListener('input', (e) => {
                    renderCheckoutCountryList(e.target.value);
                });
            }
            
            // Close dropdown when clicking outside (only add once)
            if (!dropdownInitialized) {
                document.addEventListener('click', function handleOutsideClick(e) {
                    if (countryDropdown && countryToggle && 
                        !countryDropdown.contains(e.target) && 
                        !countryToggle.contains(e.target)) {
                        countryDropdown.classList.add('hidden');
                        if (countryToggle) {
                            countryToggle.setAttribute('aria-expanded', 'false');
                            const chevron = countryToggle.querySelector('[data-lucide="chevron-down"]');
                            if (chevron) {
                                chevron.style.transform = '';
                            }
                        }
                    }
                });
            }
            
            dropdownInitialized = true;
        }
        
        // Load countries immediately on page load
        function initializeCountryDropdownWhenReady() {
            // Wait a bit to ensure DOM is fully ready
            setTimeout(() => {
                initCountryDropdown();
                
                // Verify button exists and is clickable
                const btn = document.getElementById('checkout-country-toggle');
                if (btn) {
                    // Test that button is accessible
                    if (btn.offsetParent === null) {
                        console.warn('Country toggle button is not visible');
                    }
                } else {
                    console.error('Country toggle button not found in DOM');
                    // Retry after longer delay
                    setTimeout(() => {
                        initCountryDropdown();
                    }, 500);
                }
            }, 50);
        }
        
        // Start initialization when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeCountryDropdownWhenReady);
        } else {
            // DOM is already loaded
            initializeCountryDropdownWhenReady();
        }
        
        // Auto-save address on blur (debounced)
        let saveTimeout;
        function autoSaveAddress() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                if (validateForm()) {
                    try {
                        const response = await fetch('/api/checkout/save-address', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
                            },
                            body: JSON.stringify({
                                full_name: fields.full_name.value,
                                email: fields.email.value,
                                phone: fields.phone.value,
                                country: fields.country.value,
                                city: fields.city.value,
                                delivery_address: fields.delivery_address.value
                            })
                        });
                        
                        const data = await response.json();
                        if (data.success) {
                            addressSavedMessage.classList.remove('hidden');
                            setTimeout(() => {
                                addressSavedMessage.classList.add('hidden');
                            }, 3000);
                        }
                    } catch (error) {
                        console.error('Error saving address:', error);
                    }
                }
            }, 1000); // Wait 1 second after user stops typing
        }
        
        // Auto-save on field changes
        Object.values(fields).forEach(field => {
            field.addEventListener('input', autoSaveAddress);
        });
        
        // Form submission
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!validateForm()) {
                // Scroll to first error
                const firstError = Object.entries(fields).find(([name, field]) => !validationState[name]);
                if (firstError) {
                    firstError[1].scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstError[1].focus();
                return;
            }
            
            // Disable button and show loading
            proceedButton.disabled = true;
            buttonText.classList.add('hidden');
            buttonLoading.classList.remove('hidden');
            
            // Save address and update pending payment with shipping method
            try {
                // Save address
                await fetch('/api/checkout/save-address', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
                    },
                    body: JSON.stringify({
                        full_name: fields.full_name.value,
                        email: fields.email.value,
                        phone: fields.phone.value,
                        country: fields.country.value,
                        city: fields.city.value,
                        delivery_address: fields.delivery_address.value
                    })
                });
                
                // Update pending payment with shipping method and recalculate totals
                const pendingPaymentId = document.getElementById('pending_payment_id').value;
                const shippingMethod = document.getElementById('shipping_mode_key').value;
                
                const updateResponse = await fetch('/api/checkout/update-pending-payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
                    },
                    body: JSON.stringify({
                        pending_payment_id: pendingPaymentId,
                        shipping_mode_key: shippingMethod,
                        country: fields.country.value,
                        full_name: fields.full_name.value,
                        phone: fields.phone.value,
                        email: fields.email.value,
                        delivery_address: fields.delivery_address.value
                    })
                });
                
                const updateData = await updateResponse.json();
                if (updateData.success) {
                    // Update amount field with new total
                    const amountInput = document.getElementById('amount');
                    if (amountInput) {
                        amountInput.value = updateData.amount.toFixed(2);
                    }
                }
            } catch (error) {
                console.error('Error saving address/updating payment:', error);
            }
            
            // Get form values
            const pendingPaymentId = document.getElementById('pending_payment_id').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const provider = 'modempay'; // Always use ModemPay
            
            // Validation - ModemPay requires minimum 10 GMD
            const MIN_AMOUNT = 10.0;
            if (isNaN(amount) || amount < MIN_AMOUNT) {
                showMessage(`Payment amount must be at least D${MIN_AMOUNT}. Current amount: D${amount.toFixed(2)}`, 'error');
                proceedButton.disabled = false;
                buttonText.classList.remove('hidden');
                buttonLoading.classList.add('hidden');
                return;
            }
            
            // Validate pending_payment_id
            if (!pendingPaymentId) {
                showMessage('Pending payment ID is missing. Please refresh the page and try again.', 'error');
                proceedButton.disabled = false;
                buttonText.classList.remove('hidden');
                buttonLoading.classList.add('hidden');
                return;
            }
            
            try {
                // Prepare payment data
                const paymentData = {
                    pending_payment_id: parseInt(pendingPaymentId),
                    provider: provider
                };
                
                console.log('Initiating ModemPay payment:', paymentData);
                
                // Make API call to ModemPay payment endpoint
                const response = await fetch('/payments/modempay/pay', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify(paymentData)
                });
                
                // Parse response
                const data = await response.json();
                
                console.log('ModemPay response:', data);
                
                // Display response
                const responseContent = document.getElementById('response-content');
                if (responseContent) {
                    responseContent.textContent = JSON.stringify(data, null, 2);
                }
                
                // Handle response
                if (data.success || response.ok) {
                    const paymentUrl = data.payment_url || (data.data && data.data.payment_url);
                    
                    if (paymentUrl && typeof paymentUrl === 'string' && paymentUrl.startsWith('http')) {
                        // Valid payment URL - immediately redirect
                        console.log('Redirecting to ModemPay checkout:', paymentUrl);
                        window.location.href = paymentUrl;
                        return;
                    } else {
                        showMessage('Payment initiated but redirect URL is missing or invalid. Please contact support.', 'error');
                    }
                } else {
                    const errorMsg = data.message || data.error || 'Payment initiation failed';
                    showMessage(errorMsg, 'error');
                }
                
            } catch (error) {
                console.error('Payment error:', error);
                showMessage('An error occurred while processing your payment. Please try again.', 'error');
            } finally {
                // Re-enable button
                proceedButton.disabled = false;
                buttonText.classList.remove('hidden');
                buttonLoading.classList.add('hidden');
            }
        });
        
        // Show message function
        function showMessage(message, type) {
            const messageDiv = document.getElementById('message');
            const messageContent = document.getElementById('message-content');
            
            if (!messageDiv || !messageContent) return;
            
            messageContent.className = 'rounded-md p-4';
            
            if (type === 'success') {
                messageContent.classList.add('bg-green-50', 'text-green-800', 'border', 'border-green-200', 'dark:bg-green-900', 'dark:text-green-200', 'dark:border-green-700');
            } else if (type === 'error') {
                messageContent.classList.add('bg-red-50', 'text-red-800', 'border', 'border-red-200', 'dark:bg-red-900', 'dark:text-red-200', 'dark:border-red-700');
            }
            
            messageContent.innerHTML = message;
            messageDiv.classList.remove('hidden');
            messageDiv.style.display = 'block';
            
            setTimeout(() => {
                messageDiv.classList.add('hidden');
                messageDiv.style.display = 'none';
            }, 10000);
        }
        
        // Initial validation
        updateButtonState();
        
        // Auto-select shipping method on page load if country is already selected
        document.addEventListener('DOMContentLoaded', async function() {
            const countryInput = document.getElementById('country');
            if (countryInput && countryInput.value) {
                // Country is stored as name, need to find the country ID
                const countryName = countryInput.value.trim();
                if (countryName && checkoutCountries.length > 0) {
                    const country = checkoutCountries.find(c => c.name === countryName);
                    if (country && country.id) {
                        await autoSelectShippingMethod(country.id);
                    }
                }
            }
        });
    })();
    
    // Rest of existing checkout summary sync code...
    const CHECKOUT_CURRENCY = document.body.dataset.cartCurrency || "{{ currency }}";
    const STATIC_BASE = "{{ url_for('static', filename='') }}";
    const PLACEHOLDER_IMAGE = "{{ url_for('static', filename='images/placeholder.png') }}";

    function formatCheckoutCurrency(value, currency = CHECKOUT_CURRENCY) {
        const numeric = Number(value) || 0;
        return `${currency}${numeric.toFixed(2)}`;
    }

    function sanitizeImagePath(imagePath) {
        if (!imagePath) {
            return PLACEHOLDER_IMAGE;
        }

        // Handle full URLs (http/https) - return as-is
        if (/^https?:\/\//i.test(imagePath)) {
            return imagePath;
        }
        
        // Handle absolute paths that don't start with /static/ - return as-is
        if (imagePath.startsWith('/') && !imagePath.startsWith('/static/')) {
            return imagePath;
        }

        // Handle relative paths - prepend /static/
        const trimmed = imagePath.startsWith('/') ? imagePath.slice(1) : imagePath;
        return `${STATIC_BASE}${trimmed}`;
    }

    function updateCheckoutItemRow(row, item, currency) {
        const imageEl = row.querySelector('[data-checkout-image]');
        if (imageEl) {
            imageEl.src = sanitizeImagePath(item.image);
            imageEl.alt = item.name || 'Cart item';
        }

        const nameLink = row.querySelector('[data-checkout-name]');
        if (nameLink) {
            nameLink.textContent = item.name || 'Product';
            nameLink.href = `/product/${item.id}`;
        }

        const priceEl = row.querySelector('[data-checkout-price]');
        if (priceEl) {
            priceEl.textContent = formatCheckoutCurrency(item.price, currency);
        }

        const quantityEl = row.querySelector('[data-checkout-quantity]');
        if (quantityEl) {
            quantityEl.textContent = `Qty ${item.quantity}`;
        }

        const itemShippingEl = row.querySelector('[data-checkout-item-shipping]');
        if (itemShippingEl) {
            const itemShipping = item.shipping || 0;
            itemShippingEl.textContent = formatCheckoutCurrency(itemShipping, currency);
        }
    }

    function normalizeSummary(payload) {
        if (!payload) {
            return null;
        }

        if (payload.cart) {
            return payload.cart;
        }

        if (payload.checkout && payload.items) {
            return payload;
        }

        return null;
    }

    function updateCheckoutView(summary) {
        if (!summary) {
            return;
        }

        const currency = summary.currency || CHECKOUT_CURRENCY;
        const checkout = summary.checkout || {};
        const itemsData = summary.items || checkout.items || [];

        const itemsContainer = document.querySelector('[data-checkout-items]');
        const emptyState = document.querySelector('[data-checkout-empty]');

        if (itemsContainer) {
            const existingItems = new Map();
            itemsContainer.querySelectorAll('[data-checkout-item]').forEach(node => {
                existingItems.set(Number(node.dataset.checkoutItem), node);
            });

            const visibleIds = new Set();

            itemsData.forEach(item => {
                const id = Number(item.id);
                visibleIds.add(id);
                let row = existingItems.get(id);
                if (!row) {
                    row = document.createElement('li');
                    row.className = 'py-6 px-4 sm:px-6';
                    row.dataset.checkoutItem = id;
                    row.innerHTML = `
                        <div class="flex items-center">
                            <div class="flex-shrink-0 w-20 h-20 border border-slate-200 dark:border-slate-800 rounded-xl overflow-hidden">
                                <img data-checkout-image class="w-full h-full object-center object-cover" alt="">
                            </div>
                            <div class="ml-6 flex-1 flex flex-col">
                                <div class="flex">
                                    <h3 class="text-sm">
                                        <a data-checkout-name class="font-medium text-slate-700 hover:text-cyan-500 dark:text-slate-200 dark:hover:text-cyan-300 transition-colors"></a>
                                    </h3>
                                </div>
                                <div class="mt-1 flex-1 flex flex-col gap-1">
                                    <div class="flex items-end justify-between">
                                        <p class="text-sm font-semibold text-slate-900 dark:text-white" data-checkout-price></p>
                                        <p class="text-sm text-slate-500 dark:text-slate-400" data-checkout-quantity></p>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <p class="text-xs text-slate-500 dark:text-slate-400">
                                            Shipping: <span data-checkout-item-shipping></span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    itemsContainer.appendChild(row);
                }

                updateCheckoutItemRow(row, item, currency);
            });

            existingItems.forEach((row, id) => {
                if (!visibleIds.has(id)) {
                    row.remove();
                }
            });

            const hasItems = itemsData.length > 0;
            itemsContainer.classList.toggle('hidden', !hasItems);
            if (emptyState) {
                emptyState.classList.toggle('hidden', hasItems);
            }
        }

        const subtotalEl = document.querySelector('[data-checkout-subtotal]');
        if (subtotalEl) {
            subtotalEl.textContent = formatCheckoutCurrency(summary.cart_subtotal ?? checkout.subtotal ?? 0, currency);
        }

        const taxEl = document.querySelector('[data-checkout-tax]');
        if (taxEl) {
            taxEl.textContent = formatCheckoutCurrency(summary.cart_tax ?? checkout.tax ?? 0, currency);
        }

        const shippingEl = document.querySelector('[data-checkout-shipping]');
        if (shippingEl) {
            shippingEl.textContent = formatCheckoutCurrency(summary.cart_shipping ?? checkout.shipping ?? 0, currency);
        }

        const totalEl = document.querySelector('[data-checkout-total]');
        if (totalEl) {
            totalEl.textContent = formatCheckoutCurrency(summary.cart_total ?? checkout.total ?? 0, currency);
        }

        const amountInput = document.getElementById('amount');
        if (amountInput) {
            amountInput.value = (checkout.total ?? summary.cart_total ?? 0).toFixed(2);
        }
    }

    function syncCheckoutSummary() {
        fetch('{{ url_for("api_get_cart_summary") }}', {
            credentials: 'same-origin',
            headers: {
                'Accept': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            const normalized = normalizeSummary(data);
            if (normalized) {
                updateCheckoutView(normalized);
            }
        })
        .catch(error => console.error('Error syncing checkout summary:', error));
    }

    document.addEventListener('DOMContentLoaded', () => {
        try {
            const summaryEl = document.getElementById('checkout-summary-data');
            const initialSummary = summaryEl ? JSON.parse(summaryEl.textContent || '{}') : {};
            updateCheckoutView(initialSummary);
        } catch (error) {
            console.error('Failed to parse initial checkout summary:', error);
        }
        syncCheckoutSummary();
    });

    window.addEventListener('cart:updated', event => {
        const normalized = normalizeSummary(event.detail);
        if (normalized) {
            updateCheckoutView(normalized);
        }
    });
</script>
{% endblock %}
