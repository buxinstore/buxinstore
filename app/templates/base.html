<!DOCTYPE html>
<html lang="{{ current_language or 'en' }}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="csrf-token" content="{{ csrf_token() }}">
  <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com https://unpkg.com https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; img-src 'self' data: https:; font-src 'self' https://cdnjs.cloudflare.com;">
  
  <!-- PWA Meta Tags -->
  {% set pwa_theme_color = pwa_theme_color or '#ffffff' %}
  {% set pwa_app_name = pwa_app_name or 'buxin store' %}
  {% set pwa_description = pwa_description or 'buxin store - Your gateway to the future of technology. Explore robotics, coding, and artificial intelligence.' %}
  {% set default_logo_url = 'https://res.cloudinary.com/dfjffnmzf/image/upload/v1763781131/Gemini_Generated_Image_ufkia2ufkia2ufki_pcf2lq.png' %}
  
  <meta name="theme-color" content="{{ pwa_theme_color }}" id="theme-color-meta">
  <meta name="color-scheme" content="light dark">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="{{ pwa_short_name or pwa_app_name }}">
  <meta name="description" content="{{ pwa_description }}">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">
  
  <!-- Favicon and App Icons -->
  {% if pwa_favicon_path %}
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename=pwa_favicon_path) }}">
  {% else %}
  <link rel="icon" type="image/x-icon" href="{{ url_for('favicon') }}">
  {% endif %}
  
  {% if pwa_logo_path %}
    {% set logo_url = url_for('static', filename=pwa_logo_path) if not pwa_logo_path.startswith('http') else pwa_logo_path %}
  {% else %}
    {% set logo_url = default_logo_url %}
  {% endif %}
  
  <link rel="apple-touch-icon" sizes="72x72" href="{{ logo_url }}">
  <link rel="apple-touch-icon" sizes="96x96" href="{{ logo_url }}">
  <link rel="apple-touch-icon" sizes="128x128" href="{{ logo_url }}">
  <link rel="apple-touch-icon" sizes="192x192" href="{{ logo_url }}">
  <link rel="apple-touch-icon" sizes="256x256" href="{{ logo_url }}">
  <link rel="apple-touch-icon" sizes="512x512" href="{{ logo_url }}">
  
  <title>{% block title %}buxin store{% endblock %}</title>
  <script>
    (function() {
      const storageKey = 'theme';
      const defaultTheme = 'light';
      const html = document.documentElement;
      const themeColorMeta = document.getElementById('theme-color-meta');

      const resolveTheme = (theme) => (theme === 'light' ? 'light' : 'dark');

      const setColorScheme = (scheme) => {
        try {
          html.style.colorScheme = scheme;
          // Update theme-color meta tag dynamically
          if (themeColorMeta) {
            themeColorMeta.content = scheme === 'dark' ? '#0f172a' : '#ffffff';
          }
        } catch (err) {
          /* noop */
        }
      };

      const dispatchThemeChange = (theme) => {
        const resolvedTheme = resolveTheme(theme);
        try {
          html.dispatchEvent(new CustomEvent('theme:change', {
            detail: { theme: resolvedTheme, resolvedTheme }
          }));
        } catch (err) {
          /* noop */
        }
      };

      const applyTheme = (theme, options = {}) => {
        const { persist = true, silent = false } = options;
        const resolvedTheme = resolveTheme(theme);
        html.classList.toggle('dark', resolvedTheme === 'dark');
        html.dataset.theme = resolvedTheme;
        html.dataset.themeResolved = resolvedTheme;
        setColorScheme(resolvedTheme);

        if (persist) {
          try {
            localStorage.setItem(storageKey, resolvedTheme);
          } catch (err) {
            /* noop */
          }
        }

        if (!silent) {
          dispatchThemeChange(resolvedTheme);
        }

        return resolvedTheme;
      };

      const readStoredTheme = () => {
        try {
          const stored = localStorage.getItem(storageKey);
          return stored === 'light' ? 'light' : stored === 'dark' ? 'dark' : null;
        } catch (err) {
          return null;
        }
      };

      // Read stored theme first, then apply
      const storedTheme = readStoredTheme();
      const initialTheme = storedTheme || defaultTheme;
      
      // Apply initial theme without persisting (to avoid overwriting user preference)
      applyTheme(initialTheme, { persist: false, silent: true });
      
      // If no stored theme, set default
      if (!storedTheme) {
        try {
          localStorage.setItem(storageKey, defaultTheme);
        } catch (err) {
          /* noop */
        }
      }

      html.classList.add('theme-initialized');

      window.__themeController = {
        storageKey,
        resolveTheme,
        get() {
          return html.dataset.theme || defaultTheme;
        },
        getResolved() {
          return html.dataset.themeResolved || defaultTheme;
        },
        apply(theme, options) {
          return applyTheme(theme, options);
        }
      };
    })();
  </script>
  <!-- 1. Include Tailwind CSS -->
  <!-- Note: Tailwind CDN doesn't expose a global tailwind object -->
  <!-- Dark mode is handled via the 'dark' class on the html element -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- 2. Include Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <!-- 3. Include Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}">
  
  <!-- 3. Custom CSS for animations and scrollbar (from tailwindcss-animate and scrollbar-hide) -->
  <style>
    :root {
      --app-bg: #ffffff;
      --app-card: #ffffff;
      --app-text: #0f172a;
      --app-muted: #64748b;
      --app-border: rgba(0,0,0,0.1);
      --app-surface-hover: rgba(15, 23, 42, 0.05);
      --app-input: #f1f5f9;
    }

    html.dark {
      --app-bg: #0f172a;
      --app-card: #0b1324;
      --app-text: #f1f5f9;
      --app-muted: #94a3b8;
      --app-border: rgba(255,255,255,0.15);
      --app-surface-hover: rgba(148, 163, 184, 0.12);
      --app-input: rgba(15, 23, 42, 0.75);
    }

    body {
      background-color: var(--app-bg) !important;
      color: var(--app-text) !important;
    }
    
    /* Ensure main container respects theme */
    .min-h-screen {
      background-color: var(--app-bg) !important;
    }

    /* Custom animation to replace tailwindcss-animate */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes slideInFromTop {
      from { transform: translateY(-0.5rem); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    @keyframes slideDown {
      from { transform: translate(-50%, -1rem); opacity: 0; }
      to { transform: translate(-50%, 0); opacity: 1; }
    }
    .animate-in-custom {
      animation: fadeIn 200ms ease-out, slideInFromTop 200ms ease-out;
    }
    /* Mobile-specific animation for country dropdown */
    @media (max-width: 767px) {
      #country-dropdown.animate-in-custom {
        animation: fadeIn 250ms ease-out, slideDown 250ms ease-out;
      }
    }
    
    /* Polyfill for scrollbar-hide */
    .scrollbar-hide::-webkit-scrollbar {
      display: none;
    }
    .scrollbar-hide {
      -ms-overflow-style: none; /* IE and Edge */
      scrollbar-width: none; /* Firefox */
    }
    
    /* Flash messages */
    .flash-message {
      animation: fadeIn 0.3s ease-out;
    }

    .product-card {
      position: relative;
      cursor: pointer;
      touch-action: manipulation;
      transition: transform 0.18s ease, box-shadow 0.18s ease, border-color 0.18s ease;
    }

    .product-card:focus-visible {
      outline: 3px solid rgba(244, 63, 94, 0.35);
      outline-offset: 3px;
    }

    .product-card.wishlist-active {
      box-shadow: 0 0 0 2px rgba(244, 63, 94, 0.3);
    }

    @keyframes wishlist-pulse-add {
      0% {
        box-shadow: 0 0 0 0 rgba(244, 63, 94, 0.45);
        transform: translateZ(0) scale(1);
      }
      50% {
        box-shadow: 0 0 0 8px rgba(244, 63, 94, 0.05);
        transform: translateZ(0) scale(1.015);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(244, 63, 94, 0);
        transform: translateZ(0) scale(1);
      }
    }

    @keyframes wishlist-pulse-remove {
      0% {
        box-shadow: 0 0 0 0 rgba(226, 232, 240, 0.6);
        transform: translateZ(0) scale(1);
      }
      50% {
        box-shadow: 0 0 0 10px rgba(226, 232, 240, 0.05);
        transform: translateZ(0) scale(0.99);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(226, 232, 240, 0);
        transform: translateZ(0) scale(1);
      }
    }

    .product-card.wishlist-pulse-add {
      animation: wishlist-pulse-add 360ms ease-out;
    }

    .product-card.wishlist-pulse-remove {
      animation: wishlist-pulse-remove 320ms ease-in;
    }

    .wishlist-button {
      min-width: 44px;
      min-height: 44px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      touch-action: manipulation;
    }

    .wishlist-button i {
      pointer-events: none;
    }

    .wishlist-heart-animate {
      animation: wishlist-heart-pop 320ms ease-out;
    }

    @keyframes wishlist-heart-pop {
      0% { transform: scale(0.75); opacity: 0.2; }
      60% { transform: scale(1.2); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }

    .wishlist-count-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 1.75rem;
      padding: 0.125rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
      background: rgba(244, 63, 94, 0.08);
      color: rgba(244, 63, 94, 0.92);
    }

    html.dark .wishlist-count-badge {
      background: rgba(244, 63, 94, 0.12);
      color: rgba(252, 231, 243, 0.95);
    }

    .floating-contact {
      position: fixed;
      right: 1.25rem;
      bottom: clamp(6rem, 12vh, 8.5rem);
      z-index: 60;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      padding: 0.75rem 0.65rem;
      background: var(--app-card);
      border-radius: 9999px;
      box-shadow: 0 18px 35px rgba(15, 23, 42, 0.18);
      border: 1px solid rgba(148, 163, 184, 0.2);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      backdrop-filter: blur(12px);
    }

    html.dark .floating-contact {
      box-shadow: 0 18px 40px rgba(8, 14, 28, 0.55);
      border-color: rgba(71, 85, 105, 0.35);
    }

    .floating-contact:hover {
      transform: translateY(-2px);
      box-shadow: 0 22px 42px rgba(15, 23, 42, 0.22);
    }

    .floating-contact__button {
      width: 48px;
      height: 48px;
      border-radius: 9999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: #ffffff;
      font-size: 1.35rem;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.16);
    }

    .floating-contact__button:hover,
    .floating-contact__button:focus-visible {
      transform: scale(1.1);
      box-shadow: 0 12px 28px rgba(15, 23, 42, 0.22);
      outline: none;
    }

    .floating-contact__button--whatsapp {
      background: #25d366;
    }

    .floating-contact__button--email {
      background: linear-gradient(135deg, #1d4ed8, #2563eb);
    }

    html.dark .floating-contact__button {
      box-shadow: 0 12px 28px rgba(3, 7, 18, 0.6);
    }

    @media (min-width: 768px) {
      .floating-contact {
        top: 50%;
        bottom: auto;
        transform: translateY(-50%);
        padding: 1rem 0.8rem;
        gap: 1rem;
      }

      .floating-contact:hover {
        transform: translateY(calc(-50% - 4px));
      }
    }

    @media (max-width: 480px) {
      .floating-contact {
        right: 1rem;
        bottom: clamp(5rem, 14vh, 7rem);
      }

      .floating-contact__button {
        width: 44px;
        height: 44px;
        font-size: 1.2rem;
      }
    }
  </style>
</head>
<body class="bg-[color:var(--app-bg)] text-[color:var(--app-text)] pb-20 transition-colors duration-300" 
      data-authenticated="{{ 'true' if current_user.is_authenticated else 'false' }}" 
      data-login-url="{{ url_for('login') }}"
      data-cart-currency="{{ cart_currency }}"
      data-wishlist-ids="{{ wishlist_product_ids|join(',') }}">
  <div class="min-h-screen bg-[color:var(--app-bg)]">
    <!-- Header -->
    <div class="sticky top-0 z-50 bg-[color:var(--app-card)] backdrop-blur-xl border-b border-[color:var(--app-border)]">
      <div class="px-4 py-4">
        <div class="flex items-center justify-between mb-4">
          <!-- Logo (moved to left) -->
          <a href="{{ url_for('home') }}" class="flex items-center">
            <img src="{{ site_logo_url }}" alt="buxin store" class="h-12 w-auto">
          </a>
          
          <div class="flex items-center gap-2">
            <!-- Country Selector -->
            <div class="relative flex items-center" id="country-selector">
              <button type="button"
                      id="country-toggle"
                      class="relative w-10 h-10 flex items-center justify-center hover:bg-[color:var(--app-surface-hover)] rounded-full transition-all focus:outline-none focus:ring-2 focus:ring-cyan-500/50 border-2 border-[color:var(--app-border)] hover:border-cyan-500/50"
                      aria-label="Select country"
                      aria-haspopup="true"
                      aria-expanded="false">
                <span class="sr-only">Select country</span>
                {% if current_country %}
                  <img src="{{ current_country.get_flag_url() or ('https://flagcdn.com/w40/' + current_country.code.lower() + '.png') }}" 
                       alt="{{ current_country.name }}" 
                       class="w-7 h-7 rounded-full object-cover"
                       id="country-flag-icon"
                       onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 24 24\' fill=\'none\' stroke=\'currentColor\' stroke-width=\'2\'%3E%3Ccircle cx=\'12\' cy=\'12\' r=\'10\'/%3E%3Cpath d=\'M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z\'/%3E%3Cpath d=\'M2 12h20\'/%3E%3C/svg%3E'; this.style.display='block'; document.getElementById('country-globe-icon')?.classList.add('hidden');">
                {% else %}
                  <i data-lucide="globe" class="w-5 h-5" id="country-globe-icon"></i>
                {% endif %}
              </button>
              
              <!-- Mobile Overlay -->
              <div id="country-dropdown-overlay" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[60] hidden md:hidden transition-opacity duration-300"></div>
              
              <!-- Country Dropdown - Responsive: Mobile (centered modal) / Desktop (normal dropdown) -->
              <div id="country-dropdown" class="
                fixed md:absolute 
                top-[12%] md:top-auto 
                left-1/2 md:left-auto 
                right-auto md:right-0 
                -translate-x-1/2 md:translate-x-0 
                translate-y-0 md:translate-y-0 
                mt-0 md:mt-3 
                mb-4 md:mb-0
                w-[92%] md:w-72 
                max-w-md md:max-w-none
                bg-white dark:bg-slate-800 
                backdrop-blur-xl 
                border border-[color:var(--app-border)] 
                rounded-xl md:rounded-2xl 
                shadow-lg md:shadow-2xl 
                hidden 
                z-[70] md:z-50 
                max-h-[76vh] md:max-h-[32rem] 
                overflow-hidden 
                flex flex-col
                animate-in-custom
                transition-transform duration-200 ease-out
              ">
                <div class="px-4 py-3 border-b border-[color:var(--app-border)] bg-slate-50 dark:bg-slate-900/50 flex-shrink-0 relative">
                  <!-- Swipe indicator for mobile -->
                  <div class="absolute top-2 left-1/2 -translate-x-1/2 w-12 h-1 bg-slate-300 dark:bg-slate-600 rounded-full md:hidden"></div>
                  <p class="text-sm font-semibold text-[color:var(--app-text)] mt-2 md:mt-0">{{ _('Select Country') }}</p>
                </div>
                <div id="country-list" class="overflow-y-auto overscroll-contain p-3 md:p-2 space-y-1.5 md:space-y-1 flex-1 min-h-0 scrollbar-thin scrollbar-thumb-slate-300 dark:scrollbar-thumb-slate-600 scrollbar-track-transparent">
                  <!-- Countries will be loaded via JavaScript -->
                </div>
              </div>
            </div>
            
            <!-- Theme Toggle -->
            <div class="relative flex items-center" id="theme-control">
              <button type="button"
                      id="theme-toggle"
                      class="relative p-2 hover:bg-[color:var(--app-surface-hover)] rounded-xl transition-all focus:outline-none focus:ring-2 focus:ring-cyan-500/50"
                      aria-label="Toggle dark mode"
                      aria-pressed="false">
                <span class="sr-only">Toggle dark mode</span>
                <i data-lucide="sun" class="w-5 h-5 hidden" data-theme-icon="light"></i>
                <i data-lucide="moon" class="w-5 h-5 hidden" data-theme-icon="dark"></i>
              </button>
            </div>
            
            <!-- Cart Button -->
            <a href="{{ url_for('cart') }}" class="p-2 hover:bg-[color:var(--app-surface-hover)] rounded-xl transition-colors relative">
              <i data-lucide="shopping-cart" class="w-6 h-6"></i>
              <span id="cart-count-badge" class="absolute -top-1 -right-1 bg-gradient-to-r from-cyan-500 to-blue-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center font-bold hidden">
                <span class="cart-count">0</span>
              </span>
            </a>
            
            <!-- Profile Button -->
            <div class="relative" id="navbar-profile">
              <button onclick="toggleProfile()" class="flex items-center gap-2 p-1 pl-2 pr-3 hover:bg-[color:var(--app-surface-hover)] rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-cyan-500" aria-haspopup="true" aria-expanded="false">
                <span class="hidden sm:flex flex-col text-right leading-tight text-[color:var(--app-text)]">
                  {% if current_user.is_authenticated %}
                    <span class="text-xs text-[color:var(--app-muted)]">Welcome back</span>
                    <span class="text-sm font-semibold text-[color:var(--app-text)] truncate max-w-[110px]" id="navbar-display-name">{{ current_user_display_name or current_user.username }}</span>
                  {% else %}
                    <span class="text-xs text-[color:var(--app-muted)]">Account</span>
                    <span class="text-sm font-semibold text-[color:var(--app-text)]">Sign in</span>
                  {% endif %}
                </span>
                <span class="relative">
                  <img src="{{ current_user_avatar_url or url_for('static', filename='images/default-avatar.svg') }}"
                       alt="Profile"
                       class="h-10 w-10 rounded-full border-2 border-white/70 object-cover shadow-sm"
                       id="navbar-avatar">
                  {% if current_user_google_connected %}
                    <span class="absolute -bottom-1 -right-0.5 h-4 w-4 rounded-full bg-[color:var(--app-card)] flex items-center justify-center shadow ring-1 ring-[color:var(--app-border)]">
                      <i class="fab fa-google text-[0.65rem] text-orange-500"></i>
                    </span>
                  {% endif %}
                </span>
              </button>
              
              <!-- Profile Menu -->
              <div id="profile-menu" class="absolute right-0 mt-3 w-64 bg-[color:var(--app-card)] backdrop-blur-xl border border-[color:var(--app-border)] rounded-2xl p-3 space-y-1 shadow-2xl animate-in-custom hidden z-50">
                {% if current_user.is_authenticated %}
                  <div class="flex items-center gap-3 p-3 rounded-xl bg-[color:var(--app-surface-hover)] mb-1">
                    <img src="{{ current_user_avatar_url or url_for('static', filename='images/default-avatar.svg') }}" alt="Profile" class="h-12 w-12 rounded-full object-cover border border-white/70 shadow" id="profile-menu-avatar">
                    <div>
                      <p class="text-sm font-semibold text-[color:var(--app-text)]" id="profile-menu-name">{{ current_user_display_name or current_user.username }}</p>
                      <p class="text-xs text-[color:var(--app-muted)] truncate max-w-[160px]" id="profile-menu-email">{{ current_user.email }}</p>
                    </div>
                  </div>
                  <a href="{{ url_for('profile') }}" class="w-full flex items-center gap-3 p-3 text-[color:var(--app-text)] hover:bg-[color:var(--app-surface-hover)] rounded-lg transition-colors">
                    <i data-lucide="user" class="w-5 h-5 text-cyan-500"></i>
                    <span class="text-sm font-medium">My Profile</span>
                  </a>
                  <a href="{{ url_for('orders') }}" class="w-full flex items-center gap-3 p-3 text-[color:var(--app-text)] hover:bg-[color:var(--app-surface-hover)] rounded-lg transition-colors">
                    <i data-lucide="package" class="w-5 h-5 text-purple-500"></i>
                    <span class="text-sm font-medium">My Orders</span>
                  </a>
                  <a href="{{ url_for('wishlist') }}" class="w-full flex items-center gap-3 p-3 text-[color:var(--app-text)] hover:bg-[color:var(--app-surface-hover)] rounded-lg transition-colors">
                    <i data-lucide="heart" class="w-5 h-5 text-pink-500"></i>
                    <span class="text-sm font-medium flex items-center gap-2" id="wishlist-count" data-wishlist-count>
                      <span data-wishlist-label>My Wishlist</span>
                      <span class="wishlist-count-badge{% if wishlist_count == 0 %} hidden{% endif %}" data-wishlist-count-badge>{{ wishlist_count }}</span>
                    </span>
                  </a>
                  <a href="{{ url_for('forum.index') }}" class="w-full flex items-center gap-3 p-3 text-[color:var(--app-text)] hover:bg-[color:var(--app-surface-hover)] rounded-lg transition-colors">
                    <i data-lucide="message-square" class="w-5 h-5 text-cyan-500"></i>
                    <span class="text-sm font-medium">Discussion Forum</span>
                  </a>
                  <!--
                  <a href="{{ url_for('profile') }}#preferences-card" class="w-full flex items-center gap-3 p-3 text-[color:var(--app-text)] hover:bg-[color:var(--app-surface-hover)] rounded-lg transition-colors">
                    <i data-lucide="settings" class="w-5 h-5 text-amber-500"></i>
                    <span class="text-sm font-medium">Settings</span>
                  </a>
                -->
                  <div class="border-t border-[color:var(--app-border)] pt-2 mt-2">
                    <a href="{{ url_for('logout') }}" class="w-full flex items-center gap-3 p-3 text-red-500 hover:bg-red-50 rounded-lg transition-colors">
                      <i data-lucide="log-out" class="w-5 h-5"></i>
                      <span class="text-sm font-medium">Sign Out</span>
                    </a>
                  </div>
                {% else %}
                  <a href="{{ url_for('login') }}" class="w-full flex items-center gap-3 p-3 text-[color:var(--app-text)] hover:bg-[color:var(--app-surface-hover)] rounded-lg transition-colors">
                    <i data-lucide="log-in" class="w-5 h-5 text-cyan-400"></i>
                    <span class="text-sm font-medium">Sign In</span>
                  </a>
                  <a href="{{ url_for('register') }}" class="w-full flex items-center gap-3 p-3 text-[color:var(--app-text)] hover:bg-[color:var(--app-surface-hover)] rounded-lg transition-colors">
                    <i data-lucide="user-plus" class="w-5 h-5 text-green-400"></i>
                    <span class="text-sm font-medium">Create Account</span>
                  </a>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        
        <!-- Search Bar -->
        <div class="relative">
          <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-[color:var(--app-muted)]"></i>
          <form action="{{ url_for('home') }}" method="GET" class="w-full">
            <input type="text" name="q" placeholder="Search products..." class="w-full bg-[color:var(--app-input)] border border-[color:var(--app-border)] rounded-xl py-3 pl-11 pr-4 text-sm text-[color:var(--app-text)] placeholder:text-[color:var(--app-muted)] focus:outline-none focus:ring-2 focus:ring-cyan-500/50 focus:border-cyan-500 transition-all">
          </form>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="px-4 py-6 bg-[color:var(--app-bg)]">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="mb-4 p-4 rounded-md {% if category == 'success' %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %} flash-message">
              {{ message }}
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}
      
      {% block content %}{% endblock %}
    </div>
    
    <!-- Country Selector Modal (First-time users) -->
    <div id="country-selector-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] items-center justify-center hidden" style="display: none;">
      <div class="bg-[color:var(--app-card)] rounded-2xl p-6 max-w-md w-full mx-4 shadow-2xl border border-[color:var(--app-border)]">
        <div class="text-center mb-6">
          <h2 class="text-2xl font-bold text-[color:var(--app-text)] mb-2">{{ _('Select your country') }}</h2>
          <p class="text-sm text-[color:var(--app-muted)]">{{ _('Choose your country to see prices and content in your local currency and language') }}</p>
        </div>
        
        <div id="country-modal-list" class="space-y-2 max-h-96 overflow-y-auto mb-4 p-2">
          <!-- Countries will be loaded via JavaScript -->
        </div>
        
        <div class="flex gap-3">
          <button type="button" 
                  id="country-modal-close" 
                  class="flex-1 px-4 py-2 bg-[color:var(--app-surface-hover)] text-[color:var(--app-text)] rounded-xl hover:bg-[color:var(--app-surface-hover)] transition-colors">
            {{ _('Skip for now') }}
          </button>
        </div>
      </div>
    </div>
    
    <!-- Footer 
    <footer class="bg-[color:var(--app-card)] backdrop-blur-xl border-t border-[color:var(--app-border)] mt-12 py-8 text-[color:var(--app-text)]">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-8 text-[color:var(--app-text)]">
          <div>
            <h3 class="text-sm font-semibold text-[color:var(--app-text)] tracking-wider uppercase">Shop</h3>
            <ul class="mt-4 space-y-2">
              <li><a href="#" class="text-sm text-[color:var(--app-muted)] hover:text-[color:var(--app-text)]">All Products</a></li>
            </ul>
          </div>
          <div>
            <h3 class="text-sm font-semibold text-[color:var(--app-text)] tracking-wider uppercase">Support</h3>
            <ul class="mt-4 space-y-2">
              <li><a href="#" class="text-sm text-[color:var(--app-muted)] hover:text-[color:var(--app-text)]">Contact Us</a></li>
            </ul>
          </div>
          <div>
            <h3 class="text-sm font-semibold text-[color:var(--app-text)] tracking-wider uppercase">Company</h3>
            <ul class="mt-4 space-y-2">
              <li><a href="#" class="text-sm text-[color:var(--app-muted)] hover:text-[color:var(--app-text)]">About Us</a></li>
            </ul>
          </div>
          <div>
            <h3 class="text-sm font-semibold text-[color:var(--app-text)] tracking-wider uppercase">Legal</h3>
            <ul class="mt-4 space-y-2">
              <li><a href="#" class="text-sm text-[color:var(--app-muted)] hover:text-[color:var(--app-text)]">Privacy Policy</a></li>
            </ul>
          </div>
        </div>
      -->
        <div class="mt-12 border-t border-[color:var(--app-border)] pt-8 flex flex-col md:flex-row justify-between items-center">
          <p class="text-sm text-[color:var(--app-muted)]">&copy; {{ now.year }} buxin store. All rights reserved.</p>
          <div class="mt-4 md:mt-0 flex space-x-6">
            <a href="#" class="text-[color:var(--app-muted)] hover:text-[color:var(--app-text)]">
              <span class="sr-only">Facebook</span>
              <i data-lucide="facebook" class="w-5 h-5"></i>
            </a>
            <a href="#" class="text-[color:var(--app-muted)] hover:text-[color:var(--app-text)]">
              <span class="sr-only">Twitter</span>
              <i data-lucide="twitter" class="w-5 h-5"></i>
            </a>
            <a href="#" class="text-[color:var(--app-muted)] hover:text-[color:var(--app-text)]">
              <span class="sr-only">Instagram</span>
              <i data-lucide="instagram" class="w-5 h-5"></i>
            </a>
            <a href="#" class="text-[color:var(--app-muted)] hover:text-[color:var(--app-text)]">
              <span class="sr-only">YouTube</span>
              <i data-lucide="youtube" class="w-5 h-5"></i>
            </a>
          </div>
        </div>
      </div>
    </footer>
  </div>

  {% if floating_whatsapp or floating_email %}
  <div class="floating-contact" role="complementary" aria-label="Contact options">
    {% if floating_whatsapp %}
      {% set whatsapp_number = floating_whatsapp|replace('+', '')|replace(' ', '')|replace('-', '') %}
      <a href="https://wa.me/{{ whatsapp_number }}"
         class="floating-contact__button floating-contact__button--whatsapp"
         target="_blank"
         rel="noopener noreferrer"
         aria-label="Chat on WhatsApp">
        <i class="fab fa-whatsapp"></i>
      </a>
    {% endif %}
    {% if floating_email %}
      {% set email_subject = (floating_email_subject or 'Support Request')|urlencode %}
      {% set email_body = (floating_email_body or 'Hello, I need help with ...')|urlencode %}
      <a href="mailto:{{ floating_email|e }}?subject={{ email_subject }}&body={{ email_body }}"
         class="floating-contact__button floating-contact__button--email"
         target="_blank"
         rel="noopener noreferrer"
         aria-label="Send support email">
        <i class="fas fa-envelope"></i>
      </a>
    {% endif %}
  </div>
  {% endif %}

  <!-- WhatsApp Number Popup Modal -->
  <div id="whatsapp-popup-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm" style="display: none;">
    <div class="bg-[color:var(--app-card)] rounded-2xl shadow-2xl max-w-md w-full mx-4 p-6 border border-[color:var(--app-border)] animate-in-custom">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold text-[color:var(--app-text)] flex items-center gap-2">
          <i class="fab fa-whatsapp text-green-500"></i>
          Add Your WhatsApp Number
        </h3>
        <button type="button" id="whatsapp-popup-close" class="text-[color:var(--app-muted)] hover:text-[color:var(--app-text)] transition-colors">
          <i data-lucide="x" class="w-6 h-6"></i>
        </button>
      </div>
      <p class="text-sm text-[color:var(--app-muted)] mb-4">
        ðŸ“± Add your WhatsApp number to receive robotics updates and new buxin store products.
      </p>
      <form id="whatsapp-popup-form">
        <div id="whatsapp-email-field" class="mb-4 hidden">
          <label for="whatsapp-email" class="block text-sm font-medium text-[color:var(--app-text)] mb-2">Email</label>
          <input type="email" id="whatsapp-email" name="email" required
                 class="w-full bg-[color:var(--app-input)] border border-[color:var(--app-border)] rounded-lg px-4 py-2 text-[color:var(--app-text)] focus:outline-none focus:ring-2 focus:ring-cyan-500/50"
                 placeholder="your@email.com">
        </div>
        <div class="mb-4">
          <label for="whatsapp-number" class="block text-sm font-medium text-[color:var(--app-text)] mb-2">WhatsApp Number</label>
          <input type="tel" id="whatsapp-number" name="whatsapp_number" required
                 class="w-full bg-[color:var(--app-input)] border border-[color:var(--app-border)] rounded-lg px-4 py-2 text-[color:var(--app-text)] focus:outline-none focus:ring-2 focus:ring-cyan-500/50"
                 placeholder="+220XXXXXXXXX or 220XXXXXXXXX">
          <p class="text-xs text-[color:var(--app-muted)] mt-1">Include country code (e.g., +220 for Gambia)</p>
        </div>
        <div id="whatsapp-popup-alert" class="mb-4 hidden"></div>
        <div class="flex gap-3">
          <button type="submit" id="whatsapp-popup-submit"
                  class="flex-1 bg-gradient-to-r from-green-500 to-green-600 text-white px-4 py-2 rounded-lg font-medium hover:from-green-600 hover:to-green-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
            <span id="whatsapp-submit-text">Submit</span>
            <span id="whatsapp-submit-loading" class="hidden">
              <i class="fas fa-spinner fa-spin mr-2"></i> Sending...
            </span>
          </button>
          <button type="button" id="whatsapp-popup-dismiss"
                  class="px-4 py-2 border border-[color:var(--app-border)] rounded-lg text-[color:var(--app-text)] hover:bg-[color:var(--app-surface-hover)] transition-colors">
            Maybe Later
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Main JavaScript -->
  <script src="{{ url_for('static', filename='js/wishlist.js') }}" defer></script>
  <script>
    function initializeThemeToggle() {
      const html = document.documentElement;
      const controller = window.__themeController || null;
      const themeControl = document.getElementById('theme-control');
      const toggleButton = document.getElementById('theme-toggle');
      if (!themeControl || !toggleButton) {
        return;
      }

      const icons = {
        light: themeControl.querySelector('[data-theme-icon="light"]'),
        dark: themeControl.querySelector('[data-theme-icon="dark"]')
      };

      const resolveTheme = (theme) => {
        if (controller && typeof controller.resolveTheme === 'function') {
          return controller.resolveTheme(theme);
        }
        return theme === 'light' ? 'light' : 'dark';
      };

      const getTheme = () => {
        if (controller && typeof controller.get === 'function') {
          return controller.get();
        }
        return html.dataset.theme || 'light';
      };

      const updateButtonState = (theme) => {
        const resolvedTheme = resolveTheme(theme);
        if (icons.light) {
          icons.light.classList.toggle('hidden', resolvedTheme !== 'light');
        }
        if (icons.dark) {
          icons.dark.classList.toggle('hidden', resolvedTheme !== 'dark');
        }
        toggleButton.setAttribute('aria-pressed', resolvedTheme === 'dark' ? 'true' : 'false');
        toggleButton.setAttribute('data-theme-active', resolvedTheme);
        toggleButton.classList.toggle('text-yellow-400', resolvedTheme === 'light');
        toggleButton.classList.toggle('text-cyan-400', resolvedTheme === 'dark');
        toggleButton.title = `${resolvedTheme.charAt(0).toUpperCase()}${resolvedTheme.slice(1)} mode`;
      };

      const applyTheme = (theme) => {
        const targetTheme = resolveTheme(theme);
        
        // Step 1: Add theme-changing class to disable transitions
        html.classList.add('theme-changing');
        
        // Step 2: Apply theme class changes
        if (controller && typeof controller.apply === 'function') {
          controller.apply(targetTheme);
        } else {
          html.classList.toggle('dark', targetTheme === 'dark');
          html.dataset.theme = targetTheme;
          html.dataset.themeResolved = targetTheme;
          try {
            localStorage.setItem(controller?.storageKey || 'theme', targetTheme);
          } catch (err) {
            /* noop */
          }
        }
        
        // Step 3: Force immediate reflow to apply CSS variable changes
        const body = document.body;
        void html.offsetHeight;
        void (body ? body.offsetHeight : 0);
        
        // Step 4: Use double requestAnimationFrame to ensure paint completes
        requestAnimationFrame(() => {
          requestAnimationFrame(() => {
            // Step 5: Remove theme-changing class to re-enable transitions
            html.classList.remove('theme-changing');
            
            // Step 6: Force Lucide icons to re-render with new theme colors
            if (window.lucide && typeof window.lucide.createIcons === 'function') {
              try {
                // Re-render all Lucide icons
                window.lucide.createIcons();
                
                // Force a repaint after icon re-render
                void html.offsetHeight;
              } catch (err) {
                console.warn('Failed to re-render Lucide icons:', err);
              }
            }
            
            // Step 7: Dispatch theme change event after everything is updated
            try {
              html.dispatchEvent(new CustomEvent('theme:change', {
                detail: { theme: targetTheme, resolvedTheme: targetTheme }
              }));
            } catch (err) {
              /* noop */
            }
          });
        });
        
        // Step 8: Update button state immediately
        updateButtonState(targetTheme);
      };

      const toggleTheme = () => {
        const current = resolveTheme(getTheme());
        const next = current === 'dark' ? 'light' : 'dark';
        applyTheme(next);
      };

      toggleButton.addEventListener('click', (event) => {
        event.preventDefault();
        toggleTheme();
      });

      html.addEventListener('theme:change', (event) => {
        const theme = event.detail?.theme ?? getTheme();
        updateButtonState(theme);
      });

      updateButtonState(resolveTheme(getTheme()));
    }

    // Toggle profile menu
    function toggleProfile() {
      const profileMenu = document.getElementById('profile-menu');
      const profileButton = document.querySelector('#navbar-profile > button');
      if (!profileMenu || !profileButton) return;
      const isHidden = profileMenu.classList.contains('hidden');
      profileMenu.classList.toggle('hidden');
      profileButton.setAttribute('aria-expanded', isHidden ? 'true' : 'false');
    }
    
    // Close profile menu when clicking outside
    document.addEventListener('click', function(event) {
      const profileButton = document.querySelector('#navbar-profile > button');
      const profileMenu = document.getElementById('profile-menu');
      if (!profileButton || !profileMenu) return;

      if (!profileMenu.classList.contains('hidden') && 
          !profileButton.contains(event.target) && 
          !profileMenu.contains(event.target)) {
        profileMenu.classList.add('hidden');
        profileButton.setAttribute('aria-expanded', 'false');
      }
    });

    // ======================
    // Country Selection System
    // ======================
    
    let currentCountry = null;
    let countries = [];
    
    // Load countries from API
    async function loadCountries() {
      try {
        const response = await fetch('/api/countries');
        const data = await response.json();
        if (data.success) {
          countries = data.countries;
          renderCountryDropdown();
          renderCountryModal();
        }
      } catch (error) {
        console.error('Error loading countries:', error);
      }
    }
    
    // Get current country
    async function loadCurrentCountry() {
      try {
        const response = await fetch('/api/country/current');
        const data = await response.json();
        if (data.success && data.country) {
          currentCountry = data.country;
          updateCountryIcon();
        }
      } catch (error) {
        console.error('Error loading current country:', error);
      }
    }
    
    // Render country dropdown in navigation
    function renderCountryDropdown() {
      const dropdown = document.getElementById('country-list');
      if (!dropdown) return;
      
      dropdown.innerHTML = countries.map(country => {
        // Get flag URL - prefer flag_url from API, then flag_image_path, then fallback
        let flagUrl = country.flag_url || '';
        if (!flagUrl && country.flag_image_path) {
          flagUrl = country.flag_image_path.startsWith('http') 
            ? country.flag_image_path 
            : `/static/${country.flag_image_path}`;
        }
        if (!flagUrl && country.code) {
          // Fallback to flagcdn.com
          flagUrl = `https://flagcdn.com/w40/${country.code.toLowerCase()}.png`;
        }
        
        const isSelected = currentCountry && currentCountry.id === country.id;
        const currencyDisplay = country.currency_symbol || country.currency || '';
        
        return `
          <button type="button" 
                  class="w-full flex items-center gap-3 px-3 py-2.5 md:px-4 md:py-3 text-[color:var(--app-text)] hover:bg-slate-100 dark:hover:bg-slate-700/50 rounded-lg md:rounded-xl transition-all duration-200 ${isSelected ? 'bg-slate-100 dark:bg-slate-700/50 ring-2 ring-cyan-500/30' : ''}"
                  onclick="selectCountry(${country.id}, false)">
            <div class="flex-shrink-0 w-9 h-9 md:w-10 md:h-10 rounded-full overflow-hidden border-2 border-[color:var(--app-border)] flex items-center justify-center bg-gray-100 dark:bg-gray-700">
              ${flagUrl ? `<img src="${flagUrl}" alt="${country.name}" class="w-full h-full object-cover" onerror="this.onerror=null; this.style.display='none'; this.parentElement.innerHTML='<i data-lucide=\\'globe\\' class=\\'w-4 h-4 md:w-5 md:h-5 text-[color:var(--app-muted)]\\'></i>'; if(window.lucide) window.lucide.createIcons();">` : '<i data-lucide="globe" class="w-4 h-4 md:w-5 md:h-5 text-[color:var(--app-muted)]"></i>'}
            </div>
            <div class="flex-1 text-left min-w-0">
              <div class="text-sm md:text-sm font-semibold text-[color:var(--app-text)] truncate">${country.name}</div>
              <div class="text-xs text-[color:var(--app-muted)] truncate">${currencyDisplay} â€¢ ${(country.language || 'en').toUpperCase()}</div>
            </div>
            ${isSelected ? '<i data-lucide="check" class="w-4 h-4 md:w-5 md:h-5 text-cyan-500 flex-shrink-0"></i>' : ''}
          </button>
        `;
      }).join('');
      
      // Re-render Lucide icons
      if (window.lucide) {
        window.lucide.createIcons();
      }
    }
    
    // Render country modal
    function renderCountryModal() {
      const modalList = document.getElementById('country-modal-list');
      if (!modalList) return;
      
      modalList.innerHTML = countries.map(country => {
        // Get flag URL - prefer flag_url from API, then flag_image_path, then fallback
        let flagUrl = country.flag_url || '';
        if (!flagUrl && country.flag_image_path) {
          flagUrl = country.flag_image_path.startsWith('http') 
            ? country.flag_image_path 
            : `/static/${country.flag_image_path}`;
        }
        if (!flagUrl && country.code) {
          // Fallback to flagcdn.com
          flagUrl = `https://flagcdn.com/w40/${country.code.toLowerCase()}.png`;
        }
        
        const currencyDisplay = country.currency_symbol || country.currency || '';
        
        return `
          <button type="button" 
                  class="w-full flex items-center gap-3 px-4 py-3 text-[color:var(--app-text)] hover:bg-[color:var(--app-surface-hover)] rounded-xl transition-all duration-200 border border-[color:var(--app-border)]"
                  onclick="selectCountry(${country.id}, true)">
            <div class="flex-shrink-0 w-10 h-10 rounded-full overflow-hidden border-2 border-[color:var(--app-border)] flex items-center justify-center bg-gray-100 dark:bg-gray-700">
              ${flagUrl ? `<img src="${flagUrl}" alt="${country.name}" class="w-full h-full object-cover" onerror="this.onerror=null; this.style.display='none'; this.parentElement.innerHTML='<i data-lucide=\\'globe\\' class=\\'w-5 h-5 text-[color:var(--app-muted)]\\'></i>'; if(window.lucide) window.lucide.createIcons();">` : '<i data-lucide="globe" class="w-5 h-5 text-[color:var(--app-muted)]"></i>'}
            </div>
            <div class="flex-1 text-left min-w-0">
              <div class="text-sm font-semibold text-[color:var(--app-text)] truncate">${country.name}</div>
              <div class="text-xs text-[color:var(--app-muted)] truncate">${currencyDisplay} â€¢ ${(country.language || 'en').toUpperCase()}</div>
            </div>
          </button>
        `;
      }).join('');
      
      // Re-render Lucide icons
      if (window.lucide) {
        window.lucide.createIcons();
      }
    }
    
    // Update country icon in navigation
    function updateCountryIcon() {
      const flagIcon = document.getElementById('country-flag-icon');
      const globeIcon = document.getElementById('country-globe-icon');
      const toggleButton = document.getElementById('country-toggle');
      
      if (currentCountry) {
        // Get flag URL - prefer flag_url from API, then flag_image_path, then fallback
        let flagUrl = currentCountry.flag_url || '';
        if (!flagUrl && currentCountry.flag_image_path) {
          flagUrl = currentCountry.flag_image_path.startsWith('http') 
            ? currentCountry.flag_image_path 
            : `/static/${currentCountry.flag_image_path}`;
        }
        if (!flagUrl && currentCountry.code) {
          // Fallback to flagcdn.com
          flagUrl = `https://flagcdn.com/w40/${currentCountry.code.toLowerCase()}.png`;
        }
        
        if (flagUrl && flagIcon) {
          flagIcon.src = flagUrl;
          flagIcon.alt = currentCountry.name;
          flagIcon.style.display = 'block';
          flagIcon.classList.remove('hidden');
          flagIcon.onerror = function() {
            // If flag fails to load, show globe icon
            this.style.display = 'none';
            if (globeIcon) {
              globeIcon.classList.remove('hidden');
              globeIcon.style.display = 'block';
            }
          };
        } else {
          if (flagIcon) {
            flagIcon.style.display = 'none';
          }
          if (globeIcon) {
            globeIcon.classList.remove('hidden');
            globeIcon.style.display = 'block';
          }
        }
      } else {
        if (flagIcon) {
          flagIcon.style.display = 'none';
        }
        if (globeIcon) {
          globeIcon.classList.remove('hidden');
          globeIcon.style.display = 'block';
        }
      }
    }
    
    // Select country
    async function selectCountry(countryId, fromModal = false) {
      try {
        const response = await fetch('/api/country/select', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
          },
          body: JSON.stringify({ country_id: countryId })
        });
        
        const data = await response.json();
        if (data.success) {
          currentCountry = data.country;
          updateCountryIcon();
          
          // Reload countries list to ensure dropdown is up-to-date
          await loadCountries();
          
          // Close dropdown/modal
          closeCountryDropdown();
          
          if (fromModal) {
            const modal = document.getElementById('country-selector-modal');
            if (modal) {
              modal.classList.add('hidden');
              modal.style.display = 'none';
            }
            // Set flag to prevent modal from showing again
            sessionStorage.setItem('country_selected', 'true');
          }
          
          // Reload page to apply new currency/language
          window.location.reload();
        } else {
          alert('Failed to select country: ' + (data.message || 'Unknown error'));
        }
      } catch (error) {
        console.error('Error selecting country:', error);
        alert('Failed to select country. Please try again.');
      }
    }
    
    // Check if mobile screen
    function isMobile() {
      return window.innerWidth < 768; // md breakpoint
    }
    
    // Toggle country dropdown
    function toggleCountryDropdown() {
      const dropdown = document.getElementById('country-dropdown');
      const overlay = document.getElementById('country-dropdown-overlay');
      const toggleButton = document.getElementById('country-toggle');
      if (!dropdown || !toggleButton) return;
      
      const isHidden = dropdown.classList.contains('hidden');
      
      if (isHidden) {
        // Show dropdown
        dropdown.classList.remove('hidden');
        toggleButton.setAttribute('aria-expanded', 'true');
        
        // Reset transform and opacity
        dropdown.style.transform = '';
        dropdown.style.opacity = '';
        
        // Show overlay on mobile
        if (isMobile() && overlay) {
          overlay.classList.remove('hidden');
          overlay.style.opacity = '0.5';
        }
      } else {
        // Hide dropdown with animation
        closeCountryDropdown(true);
      }
    }
    
    // Close dropdown (used by overlay click)
    function closeCountryDropdown(animate = true) {
      const dropdown = document.getElementById('country-dropdown');
      const overlay = document.getElementById('country-dropdown-overlay');
      const toggleButton = document.getElementById('country-toggle');
      
      if (dropdown) {
        if (animate && isMobile()) {
          // Add fade/slide animation on mobile
          dropdown.style.transition = 'opacity 200ms ease-out, transform 200ms ease-out';
          dropdown.style.opacity = '0';
          dropdown.style.transform = 'translate(-50%, -1rem)';
          
          setTimeout(() => {
            dropdown.classList.add('hidden');
            dropdown.style.opacity = '';
            dropdown.style.transform = '';
            dropdown.style.transition = '';
          }, 200);
        } else {
          dropdown.classList.add('hidden');
        }
      }
      if (overlay) {
        overlay.style.transition = 'opacity 200ms ease-out';
        overlay.style.opacity = '0';
        setTimeout(() => {
          overlay.classList.add('hidden');
          overlay.style.opacity = '';
          overlay.style.transition = '';
        }, 200);
      }
      if (toggleButton) {
        toggleButton.setAttribute('aria-expanded', 'false');
      }
    }
    
    // Swipe-to-dismiss functionality for mobile
    let swipeState = {
      startY: 0,
      currentY: 0,
      isDragging: false,
      startScrollTop: 0,
      threshold: 100, // pixels to drag before dismissing
      resistance: 0.3 // resistance factor for drag
    };
    
    function initSwipeToDismiss() {
      const dropdown = document.getElementById('country-dropdown');
      const countryList = document.getElementById('country-list');
      if (!dropdown || !countryList) return;
      
      // Touch start
      dropdown.addEventListener('touchstart', function(e) {
        if (!isMobile()) return;
        
        const touch = e.touches[0];
        swipeState.startY = touch.clientY;
        swipeState.currentY = touch.clientY;
        swipeState.startScrollTop = countryList.scrollTop;
        swipeState.isDragging = false;
        
        // Reset transform
        dropdown.style.transition = 'none';
      }, { passive: true });
      
      // Touch move
      dropdown.addEventListener('touchmove', function(e) {
        if (!isMobile()) return;
        
        const touch = e.touches[0];
        const deltaY = touch.clientY - swipeState.startY;
        const scrollTop = countryList.scrollTop;
        
        // Only start dragging if:
        // 1. User is dragging down (deltaY > 0)
        // 2. User is at the top of the scroll (scrollTop === 0) OR already dragging
        // 3. Not scrolling the list
        if (deltaY > 0 && (scrollTop === 0 || swipeState.isDragging)) {
          e.preventDefault();
          swipeState.isDragging = true;
          swipeState.currentY = touch.clientY;
          
          // Apply resistance: drag becomes harder as you pull down
          const dragDistance = deltaY;
          const resistance = 1 - (dragDistance / (window.innerHeight * 0.5)) * swipeState.resistance;
          const adjustedDistance = dragDistance * Math.max(resistance, 0.3);
          
          // Apply transform
          dropdown.style.transform = `translate(-50%, ${adjustedDistance}px)`;
          
          // Fade overlay as user drags
          const overlay = document.getElementById('country-dropdown-overlay');
          if (overlay) {
            const opacity = Math.max(0, 0.5 - (adjustedDistance / 300));
            overlay.style.opacity = opacity.toString();
          }
        } else if (scrollTop > 0 && !swipeState.isDragging) {
          // User is scrolling the list, don't interfere
          return;
        }
      }, { passive: false });
      
      // Touch end
      dropdown.addEventListener('touchend', function(e) {
        if (!isMobile() || !swipeState.isDragging) {
          swipeState.isDragging = false;
          return;
        }
        
        const deltaY = swipeState.currentY - swipeState.startY;
        
        // If dragged far enough, close the dropdown
        if (deltaY > swipeState.threshold) {
          closeCountryDropdown(true);
        } else {
          // Snap back to original position
          dropdown.style.transition = 'transform 200ms ease-out, opacity 200ms ease-out';
          dropdown.style.transform = 'translate(-50%, 0)';
          
          // Restore overlay opacity
          const overlay = document.getElementById('country-dropdown-overlay');
          if (overlay) {
            overlay.style.transition = 'opacity 200ms ease-out';
            overlay.style.opacity = '0.5';
          }
          
          setTimeout(() => {
            dropdown.style.transition = '';
            if (overlay) overlay.style.transition = '';
          }, 200);
        }
        
        swipeState.isDragging = false;
      }, { passive: true });
      
      // Also handle touch on the header for easier dragging
      const dropdownHeader = dropdown.querySelector('.px-4.py-3');
      if (dropdownHeader) {
        dropdownHeader.addEventListener('touchstart', function(e) {
          if (!isMobile()) return;
          const touch = e.touches[0];
          swipeState.startY = touch.clientY;
          swipeState.currentY = touch.clientY;
          swipeState.startScrollTop = 0;
          swipeState.isDragging = true;
          dropdown.style.transition = 'none';
        }, { passive: true });
      }
    }
    
    // Initialize country system
    document.addEventListener('DOMContentLoaded', async function() {
      await loadCountries();
      await loadCurrentCountry();
      
      // Initialize swipe-to-dismiss for mobile
      initSwipeToDismiss();
      
      // Set up country toggle button
      const countryToggle = document.getElementById('country-toggle');
      if (countryToggle) {
        countryToggle.addEventListener('click', function(e) {
          e.stopPropagation();
          toggleCountryDropdown();
        });
      }
      
      // Close dropdown when clicking outside (desktop) or on overlay (mobile)
      document.addEventListener('click', function(event) {
        const countryButton = document.getElementById('country-toggle');
        const countryDropdown = document.getElementById('country-dropdown');
        const overlay = document.getElementById('country-dropdown-overlay');
        
        if (!countryButton || !countryDropdown) return;
        
        // On mobile, close when clicking overlay
        if (isMobile() && overlay && event.target === overlay) {
          closeCountryDropdown();
          return;
        }
        
        // On desktop, close when clicking outside
        if (!isMobile() && 
            !countryDropdown.classList.contains('hidden') && 
            !countryButton.contains(event.target) && 
            !countryDropdown.contains(event.target)) {
          closeCountryDropdown();
        }
      });
      
      // Handle window resize to update dropdown behavior
      let resizeTimer;
      window.addEventListener('resize', function() {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(function() {
          // If resizing from mobile to desktop or vice versa, close dropdown
          const dropdown = document.getElementById('country-dropdown');
          const overlay = document.getElementById('country-dropdown-overlay');
          if (dropdown && !dropdown.classList.contains('hidden')) {
            closeCountryDropdown();
          }
        }, 250);
      });
      
      // Show country selector modal if country not selected
      const countrySelected = sessionStorage.getItem('country_selected') || '{{ country_selected|default("false") }}';
      const modal = document.getElementById('country-selector-modal');
      
      if (modal && countrySelected === 'false' && !currentCountry) {
        // Show modal after a short delay
        setTimeout(() => {
          modal.classList.remove('hidden');
          modal.style.display = 'flex';
        }, 500);
      }
      
      // Close modal button
      const closeModalBtn = document.getElementById('country-modal-close');
      if (closeModalBtn) {
        closeModalBtn.addEventListener('click', function() {
          if (modal) {
            modal.classList.add('hidden');
            modal.style.display = 'none';
          }
          sessionStorage.setItem('country_selected', 'true');
        });
      }
      
      // Close modal when clicking outside
      if (modal) {
        modal.addEventListener('click', function(e) {
          if (e.target === modal) {
            modal.classList.add('hidden');
            modal.style.display = 'none';
            sessionStorage.setItem('country_selected', 'true');
          }
        });
      }
    });
    
    // Make selectCountry available globally
    window.selectCountry = selectCountry;

    function updateNavbarProfile({ avatarUrl, displayName, email, googleConnected }) {
      const avatar = document.getElementById('navbar-avatar');
      const menuAvatar = document.getElementById('profile-menu-avatar');
      const nameEl = document.getElementById('navbar-display-name');
      const menuName = document.getElementById('profile-menu-name');
      const menuEmail = document.getElementById('profile-menu-email');
      const googleBadge = document.querySelector('#navbar-profile span.absolute');

      if (avatar && avatarUrl) {
        avatar.src = avatarUrl;
      }
      if (menuAvatar && avatarUrl) {
        menuAvatar.src = avatarUrl;
      }
      if (nameEl && displayName) {
        nameEl.textContent = displayName;
      }
      if (menuName && displayName) {
        menuName.textContent = displayName;
      }
      if (menuEmail && email) {
        menuEmail.textContent = email;
      }
      if (googleBadge) {
        googleBadge.classList.toggle('hidden', !googleConnected);
      } else if (googleConnected) {
        const avatarWrapper = document.querySelector('#navbar-profile span.relative');
        if (avatarWrapper) {
          const badge = document.createElement('span');
          badge.className = 'absolute -bottom-1 -right-0.5 h-4 w-4 rounded-full bg-[color:var(--app-card)] flex items-center justify-center shadow ring-1 ring-[color:var(--app-border)]';
          badge.innerHTML = '<i class="fab fa-google text-[0.65rem] text-orange-500"></i>';
          avatarWrapper.appendChild(badge);
        }
      }
    }

    window.updateNavbarProfile = updateNavbarProfile;
    
    function updateCartBadgeCount(count) {
      const cartBadge = document.getElementById('cart-count-badge');
      const cartCountElements = document.querySelectorAll('.cart-count');

      cartCountElements.forEach(el => {
        el.textContent = count && count > 0 ? count : '0';
      });

      if (cartBadge) {
        cartBadge.classList.toggle('hidden', !(count && count > 0));
      }
    }

    window.updateCartBadgeCount = updateCartBadgeCount;

    function updateCartCount() {
      fetch('{{ url_for("api_get_cart_count") }}', {
        credentials: 'same-origin',
        headers: {
          'Accept': 'application/json'
        }
      })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            const summary = data.cart || {};
            const count = data.count ?? data.cart_count ?? summary.count ?? summary.cart_count ?? 0;
            updateCartBadgeCount(count);
          }
        })
        .catch(error => console.error('Error updating cart count:', error));
    }
    
    // Initialize cart count on page load
    document.addEventListener('DOMContentLoaded', function() {
      if (window.lucide && typeof window.lucide.createIcons === 'function') {
        window.lucide.createIcons();
      }
      initializeThemeToggle();
      updateCartCount();
    });

    window.addEventListener('cart:updated', function(event) {
      const payload = event.detail || {};
      const summary = payload.cart || payload;
      const count = payload.count ?? payload.cart_count ?? summary.count ?? summary.cart_count ?? 0;
      updateCartBadgeCount(count);
    });

    // WhatsApp Popup Modal
    // PRIORITY: Onboarding â†’ Sign In â†’ WhatsApp prompt (only after login)
    (function() {
      const modal = document.getElementById('whatsapp-popup-modal');
      const form = document.getElementById('whatsapp-popup-form');
      const closeBtn = document.getElementById('whatsapp-popup-close');
      const dismissBtn = document.getElementById('whatsapp-popup-dismiss');
      const emailField = document.getElementById('whatsapp-email-field');
      const emailInput = document.getElementById('whatsapp-email');
      const numberInput = document.getElementById('whatsapp-number');
      const alertDiv = document.getElementById('whatsapp-popup-alert');
      const submitBtn = document.getElementById('whatsapp-popup-submit');
      const submitText = document.getElementById('whatsapp-submit-text');
      const submitLoading = document.getElementById('whatsapp-submit-loading');
      
      if (!modal || !form) return;

      // Check if user already dismissed or has WhatsApp number
      const dismissedKey = 'whatsapp_popup_dismissed';
      const checkInterval = 3000; // 3 seconds

      // Helper: Check if onboarding is completed
      function isOnboardingCompleted() {
        // Check localStorage
        if (localStorage.getItem('buxin_onboarding_completed') === 'true') return true;
        // Check cookie
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
          const [name, value] = cookie.trim().split('=');
          if (name === 'buxin_onboarding_completed' && value === 'true') return true;
        }
        return false;
      }

      // Helper: Check if user is authenticated (from body data attribute)
      function isUserAuthenticated() {
        return document.body.getAttribute('data-authenticated') === 'true';
      }

      function showAlert(message, type = 'error') {
        alertDiv.className = `mb-4 p-3 rounded-lg text-sm ${
          type === 'success' 
            ? 'bg-green-100 text-green-800' 
            : 'bg-red-100 text-red-800'
        }`;
        alertDiv.textContent = message;
        alertDiv.classList.remove('hidden');
      }

      function hideAlert() {
        alertDiv.classList.add('hidden');
      }

      function showModal() {
        modal.style.display = 'flex';
        modal.classList.remove('hidden');
        // Hide email field since user must be logged in
        emailField.classList.add('hidden');
        emailInput.required = false;
      }

      function hideModal() {
        modal.style.display = 'none';
        modal.classList.add('hidden');
      }

      function dismissPopup() {
        localStorage.setItem(dismissedKey, 'true');
        hideModal();
      }

      // IMPORTANT: Only show WhatsApp popup if:
      // 1. Onboarding is completed
      // 2. User is authenticated (logged in)
      // 3. User hasn't dismissed the popup
      // 4. User doesn't already have a WhatsApp number
      function shouldShowWhatsAppPopup() {
        // Rule 1: Onboarding must be completed first
        if (!isOnboardingCompleted()) {
          console.log('[WhatsApp Popup] Skipping - Onboarding not completed');
          return false;
        }
        
        // Rule 2: User must be authenticated
        if (!isUserAuthenticated()) {
          console.log('[WhatsApp Popup] Skipping - User not authenticated');
          return false;
        }
        
        // Rule 3: User hasn't dismissed the popup
        if (localStorage.getItem(dismissedKey)) {
          console.log('[WhatsApp Popup] Skipping - User dismissed popup');
          return false;
        }
        
        return true;
      }

      // Show popup after 3 seconds only if all conditions are met
      setTimeout(() => {
        if (shouldShowWhatsAppPopup()) {
          // Final check: verify user doesn't have WhatsApp number via API
          fetch('{{ url_for("api_whatsapp_check") }}')
            .then(response => response.json())
            .then(data => {
              if (data.authenticated && !data.has_whatsapp) {
                console.log('[WhatsApp Popup] Showing popup - User needs WhatsApp');
                showModal();
              } else if (data.has_whatsapp) {
                console.log('[WhatsApp Popup] Skipping - User already has WhatsApp');
              }
            })
            .catch(err => {
              console.error('[WhatsApp Popup] Error checking status:', err);
            });
        }
      }, checkInterval);

      // Close button handlers
      if (closeBtn) {
        closeBtn.addEventListener('click', dismissPopup);
      }
      if (dismissBtn) {
        dismissBtn.addEventListener('click', dismissPopup);
      }

      // Close on backdrop click
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          dismissPopup();
        }
      });

      // Form submission
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        hideAlert();

        const whatsappNumber = numberInput.value.trim();
        const email = emailInput.value.trim();

        if (!whatsappNumber) {
          showAlert('WhatsApp number is required');
          return;
        }

        // Disable submit button
        submitBtn.disabled = true;
        submitText.classList.add('hidden');
        submitLoading.classList.remove('hidden');

        // Prepare data
        const data = { whatsapp_number: whatsappNumber };
        if (email) {
          data.email = email;
        }

        // Send AJAX request
        fetch('{{ url_for("api_whatsapp_submit") }}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
          },
          body: JSON.stringify(data)
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              showAlert(data.message, 'success');
              // Hide modal after 2 seconds
              setTimeout(() => {
                dismissPopup();
                // Reload page to update user state
                window.location.reload();
              }, 2000);
            } else {
              showAlert(data.message || 'An error occurred. Please try again.');
              submitBtn.disabled = false;
              submitText.classList.remove('hidden');
              submitLoading.classList.add('hidden');
            }
          })
          .catch(error => {
            console.error('Error submitting WhatsApp number:', error);
            showAlert('An error occurred. Please try again.');
            submitBtn.disabled = false;
            submitText.classList.remove('hidden');
            submitLoading.classList.add('hidden');
          });
      });
    })();
  </script>
  
  {% block scripts %}{% endblock %}
  
  <!-- Cart functionality -->
  <script src="{{ url_for('static', filename='js/cart.js') }}"></script>
  
  <!-- Mobile Bottom Navigation -->
  <script src="{{ url_for('static', filename='js/bottom_nav.js') }}" defer></script>

  <!-- PWA Service Worker Registration -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('{{ url_for("service_worker") }}')
          .then((registration) => {
            console.log('[PWA] Service Worker registered successfully:', registration.scope);
            
            // Check for updates
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  // New service worker available, prompt user to refresh
                  if (confirm('A new version of buxin store is available. Would you like to refresh?')) {
                    window.location.reload();
                  }
                }
              });
            });
          })
          .catch((error) => {
            console.error('[PWA] Service Worker registration failed:', error);
          });

        // Listen for service worker updates
        navigator.serviceWorker.addEventListener('controllerchange', () => {
          console.log('[PWA] Service Worker controller changed');
        });
      });

      // Handle "Add to Home Screen" prompt
      let deferredPrompt;
      window.addEventListener('beforeinstallprompt', (e) => {
        // Prevent the mini-infobar from appearing on mobile
        e.preventDefault();
        // Stash the event so it can be triggered later
        deferredPrompt = e;
        console.log('[PWA] Install prompt available');
        
        // Show custom install button (optional)
        // You can create a custom install button in your UI
        // and call deferredPrompt.prompt() when clicked
      });

      // Track when app is installed
      window.addEventListener('appinstalled', () => {
        console.log('[PWA] App installed successfully');
        deferredPrompt = null;
      });
    } else {
      console.warn('[PWA] Service Workers are not supported in this browser');
    }
  </script>
  
  {% include 'components/bottom_nav.html' %}
</body>
</html>
